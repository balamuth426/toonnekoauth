<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ToonNeko Admin Panel</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .admin-container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .admin-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .admin-header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .admin-content {
            padding: 40px;
        }

        .tab-container {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            border-bottom: 2px solid #f0f0f0;
        }

        .tab-btn {
            padding: 15px 25px;
            background: transparent;
            border: none;
            cursor: pointer;
            font-size: 16px;
            color: #666;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
        }

        .tab-btn.active {
            color: #667eea;
            border-bottom-color: #667eea;
            font-weight: 600;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-group textarea {
            min-height: 120px;
            resize: vertical;
        }

        .images-input-container {
            border: 2px dashed #e0e0e0;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            background: #f9f9f9;
        }

        .image-input-item {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
        }

        .image-input-item input {
            flex: 1;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .btn-secondary {
            background: #6c757d;
        }

        .btn-danger {
            background: #dc3545;
        }

        .btn-success {
            background: #28a745;
        }

        .btn-small {
            padding: 8px 15px;
            font-size: 14px;
        }

        .status-message {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }

        .status-message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        /* İstatistik Kartları */
        .stat-card {
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            flex: 1;
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        /* Filtre Bölümü */
        .filter-section .form-group {
            margin-bottom: 0;
        }

        .filter-section .form-group label {
            font-size: 0.85rem;
            margin-bottom: 4px;
        }

        .filter-section .form-group select {
            padding: 8px 10px;
            font-size: 0.9rem;
        }

        .preview-container {
            margin-top: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .preview-images {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .preview-image {
            width: 100%;
            height: 200px;
            object-fit: cover;
            border-radius: 8px;
            border: 2px solid #e0e0e0;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .form-actions {
            display: flex;
            gap: 15px;
            margin-top: 30px;
            justify-content: flex-start;
        }

        .edit-form-container {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 25px;
            margin-top: 20px;
            border: 2px solid #e9ecef;
        }

        .edit-series-header {
            color: #667eea;
            font-size: 1.2rem;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e9ecef;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .form-row-full {
            grid-column: 1 / -1;
        }

        .edit-form-container {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            padding: 30px;
            margin-top: 20px;
        }

        .edit-series-header {
            color: #495057;
            margin-bottom: 25px;
            font-size: 1.5rem;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        .preview-container h4 {
            color: #495057;
            margin-bottom: 15px;
        }

        .preview-container img {
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-ongoing {
            background: #d4edda;
            color: #155724;
        }

        .status-completed {
            background: #d1ecf1;
            color: #0c5460;
        }

        .status-hiatus {
            background: #fff3cd;
            color: #856404;
        }

        .chapters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .chapter-card {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 20px;
            transition: all 0.3s ease;
        }

        .chapter-card:hover {
            border-color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .chapter-card h4 {
            margin: 0 0 10px 0;
            color: #333;
            font-size: 1.2rem;
        }

        .chapter-info {
            color: #666;
            font-size: 0.9rem;
            margin-bottom: 15px;
        }

        .chapter-actions {
            display: flex;
            gap: 10px;
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 0.9rem;
        }

        .edit-image-input-item {
            display: flex;
            gap: 10px;
            margin: 10px 0;
            align-items: center;
        }

        .edit-image-input-item input {
            flex: 1;
        }

        /* Duyuru Yönetimi Stilleri */
        .announcements-list {
            max-height: 600px;
            overflow-y: auto;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            margin-top: 15px;
        }

        .announcement-item {
            padding: 20px;
            border-bottom: 1px solid #f0f0f0;
            background: #fff;
            transition: background-color 0.2s ease;
        }

        .announcement-item:hover {
            background: #f8f9fa;
        }

        .announcement-item:last-child {
            border-bottom: none;
        }

        .announcement-header-item {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
        }

        .announcement-title-item {
            font-size: 1.1rem;
            font-weight: 600;
            color: #333;
            margin: 0;
            flex: 1;
        }

        .announcement-type-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
            margin-left: 10px;
        }

        .announcement-type-info {
            background: #e3f2fd;
            color: #1976d2;
        }

        .announcement-type-warning {
            background: #fff3e0;
            color: #f57c00;
        }

        .announcement-type-success {
            background: #e8f5e8;
            color: #388e3c;
        }

        .announcement-status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
            margin-left: 5px;
        }

        .announcement-active {
            background: #e8f5e8;
            color: #388e3c;
        }

        .announcement-inactive {
            background: #ffebee;
            color: #d32f2f;
        }

        .announcement-content-item {
            color: #666;
            line-height: 1.5;
            margin: 10px 0;
            white-space: pre-wrap;
        }

        .announcement-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9rem;
            color: #888;
            margin-top: 15px;
        }

        .announcement-date {
            font-style: italic;
        }

        .announcement-actions {
            display: flex;
            gap: 8px;
        }

        .btn-edit-announcement {
            background: #2196f3;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: background-color 0.2s ease;
        }

        .btn-edit-announcement:hover {
            background: #1976d2;
        }

        .btn-toggle-announcement {
            background: #ff9800;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: background-color 0.2s ease;
        }

        .btn-toggle-announcement:hover {
            background: #f57c00;
        }

        .btn-delete-announcement {
            background: #f44336;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: background-color 0.2s ease;
        }

        .btn-delete-announcement:hover {
            background: #d32f2f;
        }

        .filter-group {
            display: flex;
            gap: 15px;
            align-items: center;
            margin-bottom: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .filter-group label {
            font-weight: 600;
            color: #333;
            margin: 0;
        }

        .filter-group select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 0.9rem;
            width: auto;
        }

        .pagination-container {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
        }

        .pagination-btn {
            padding: 8px 12px;
            background: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s ease;
        }

        .pagination-btn:hover {
            background: #e9ecef;
        }

        .pagination-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .pagination-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Etiket yönetimi stilleri */
        .label-config {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }

        .label-preview {
            margin-top: 15px;
            padding: 10px;
            background: white;
            border-radius: 5px;
            border: 1px solid #ddd;
        }

        .series-label {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            color: white;
            text-shadow: 0 1px 2px rgba(0,0,0,0.3);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body>
    <div class="admin-container">
        <div class="admin-header">
            <h1>🦸‍♂️ ToonNeko Admin Panel</h1>
            <p>Google Drive ile Manhwa Yönetimi (Proxy Desteği)</p>
        </div>

        <div class="admin-content">
            <div class="tab-container">
                <button class="tab-btn active" onclick="switchTab('series')">📚 Yeni Seri</button>
                <button class="tab-btn" onclick="switchTab('chapter')">📖 Yeni Bölüm</button>
                <button class="tab-btn" onclick="switchTab('edit')">✏️ Seri Düzenle</button>
                <button class="tab-btn" onclick="switchTab('manage')">⚙️ Bölüm Yönetimi</button>
                <button class="tab-btn" onclick="switchTab('stats')">📊 Okuma İstatistikleri</button>
                <button class="tab-btn" onclick="switchTab('comments')">💬 Yorum Yönetimi</button>
                <button class="tab-btn" onclick="switchTab('announcements')">📢 Duyuru Yönetimi</button>
                <button class="tab-btn" onclick="switchTab('users')">👥 Kullanıcı Yönetimi</button>
                <button class="tab-btn" onclick="switchTab('moderators')">🛡️ Moderatör Yönetimi</button>
                <button class="tab-btn" onclick="switchTab('delete')">🗑️ Seri Sil</button>
                <button class="tab-btn" onclick="switchTab('validate')">🔗 Link Doğrula</button>
            </div>

            <div id="status-message" class="status-message"></div>
            <div id="loading" class="loading">
                <div class="spinner"></div>
                <p>İşlem gerçekleştiriliyor...</p>
            </div>

            <!-- Yeni Seri Ekleme -->
            <div id="series-tab" class="tab-content active">
                <h2>📚 Yeni Seri Ekle</h2>
                <form id="series-form">
                    <div class="form-group">
                        <label for="series-title">Seri Başlığı *</label>
                        <input type="text" id="series-title" name="title" required>
                    </div>

                    <div class="form-group">
                        <label for="series-id">Seri ID (URL için) *</label>
                        <input type="text" id="series-id" name="seriesId" required placeholder="nanomachine, sololeveling vb.">
                    </div>

                    <div class="form-group">
                        <label for="series-summary">Açıklama</label>
                        <textarea id="series-summary" name="summary" placeholder="Serinin açıklaması..."></textarea>
                    </div>

                    <div class="form-group">
                        <label for="series-author">Yazar</label>
                        <input type="text" id="series-author" name="author">
                    </div>

                    <div class="form-group">
                        <label for="series-artist">Çizer</label>
                        <input type="text" id="series-artist" name="artist">
                    </div>

                    <div class="form-group">
                        <label for="series-publisher">Yayıncı</label>
                        <input type="text" id="series-publisher" name="publisher">
                    </div>

                    <div class="form-group">
                        <label for="series-cover">Kapak Görseli (Google Drive Link) *</label>
                        <input type="url" id="series-cover" name="coverImageUrl" required placeholder="https://drive.google.com/file/d/...">
                        <button type="button" class="btn btn-secondary btn-small" onclick="validateCoverImage()">Görseli Doğrula</button>
                    </div>

                    <div class="form-group">
                        <label for="series-status">Durum</label>
                        <select id="series-status" name="status">
                            <option value="Devam Ediyor">Devam Ediyor</option>
                            <option value="Tamamlandı">Tamamlandı</option>
                            <option value="Beklemede">Beklemede</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="series-genres">Türler</label>
                        <input type="text" id="series-genres" name="genres" placeholder="Aksiyon, Fantastik, Dram, ... (virgülle ayır)">
                    </div>

                    <div id="cover-preview" class="preview-container" style="display: none;">
                        <h4>Kapak Önizleme:</h4>
                        <img id="cover-preview-img" class="preview-image" style="max-width: 200px;">
                    </div>

                    <button type="submit" class="btn">📚 Seri Oluştur</button>
                </form>
            </div>

            <!-- Yeni Bölüm Ekleme -->
            <div id="chapter-tab" class="tab-content">
                <h2>📖 Yeni Bölüm Ekle</h2>
                <form id="chapter-form">
                    <div class="form-group">
                        <label for="chapter-series">Seri Seç *</label>
                        <select id="chapter-series" name="seriesId" required>
                            <option value="">Seri seçin...</option>
                            <option value="sololeveling">Solo Leveling</option>
                            <option value="nanomachine">Nanomachine</option>
                            <option value="omniscientreader">Omniscient Reader</option>
                            <option value="damnreincarnation">Damn Reincarnation</option>
                            <option value="martialgodregressed">Martial God Regressed</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="chapter-number">Bölüm Numarası *</label>
                        <input type="number" id="chapter-number" name="chapterNumber" required min="1">
                    </div>

                    <div class="form-group">
                        <label for="chapter-title">Bölüm Başlığı</label>
                        <input type="text" id="chapter-title" name="title" placeholder="Opsiyonel">
                    </div>

                    <div class="form-group">
                        <label>Bölüm Görselleri (Google Drive Links) *</label>
                        <div class="images-input-container">
                            <div id="image-inputs">
                                <div class="image-input-item">
                                    <input type="url" placeholder="Sayfa 1 Google Drive linki" required>
                                    <button type="button" class="btn btn-danger btn-small" onclick="removeImageInput(this)">Sil</button>
                                </div>
                            </div>
                            <button type="button" class="btn btn-secondary" onclick="addImageInput()">➕ Görsel Ekle</button>
                        </div>
                    </div>

                    <div id="images-preview" class="preview-container" style="display: none;">
                        <h4>Görsel Önizleme:</h4>
                        <div class="preview-images" id="preview-images-container"></div>
                    </div>

                    <button type="submit" class="btn">📖 Bölüm Oluştur</button>
                    <button type="button" class="btn btn-secondary" onclick="previewImages()">🔍 Görselleri Önizle</button>
                </form>
            </div>

            <!-- Seri Düzenle -->
            <div id="edit-tab" class="tab-content">
                <h2>✏️ Seri Düzenle</h2>
                
                <div class="form-group">
                    <label for="edit-series-select">Düzenlenecek Seri</label>
                    <select id="edit-series-select" onchange="loadSeriesForEdit()">
                        <option value="">-- Seri Seçin --</option>
                    </select>
                </div>

                <div id="edit-series-form-container" class="edit-form-container" style="display: none;">
                    <h3 class="edit-series-header">📝 Seri Bilgilerini Düzenle</h3>
                    <form id="edit-series-form">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="edit-series-title">Seri Başlığı *</label>
                                <input type="text" id="edit-series-title" name="title" required>
                            </div>

                            <div class="form-group">
                                <label for="edit-series-status">Seri Durumu *</label>
                                <select id="edit-series-status" name="status" required>
                                    <option value="Devam Ediyor">Devam Ediyor</option>
                                    <option value="Tamamlandı">Tamamlandı</option>
                                    <option value="Beklemede">Beklemede</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-group form-row-full">
                            <label for="edit-series-summary">Seri Özeti</label>
                            <textarea id="edit-series-summary" name="summary" placeholder="Serinin açıklaması..." rows="4"></textarea>
                        </div>

                        <div class="form-group form-row-full">
                            <label for="edit-series-cover">Kapak Görseli (Google Drive Link) *</label>
                            <div style="display: flex; gap: 10px;">
                                <input type="url" id="edit-series-cover" name="image" required style="flex: 1;">
                                <button type="button" class="btn btn-secondary btn-small" onclick="validateEditCoverImage()">🔍 Görseli Doğrula</button>
                            </div>
                        </div>

                        <div class="form-group form-row-full">
                            <label for="edit-series-genres">Seri Türleri (virgülle ayırarak yazın)</label>
                            <input type="text" id="edit-series-genres" name="genres" placeholder="Aksiyon, Fantastik, Dram...">
                            <small style="color: #666; font-size: 14px; margin-top: 5px; display: block;">Örnek: Aksiyon, Fantastik, Dram, Komedi</small>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="edit-series-author">Yazar</label>
                                <input type="text" id="edit-series-author" name="author">
                            </div>

                            <div class="form-group">
                                <label for="edit-series-artist">Çizer</label>
                                <input type="text" id="edit-series-artist" name="artist">
                            </div>
                        </div>

                        <div class="form-group form-row-full">
                            <label for="edit-series-publisher">Yayıncı</label>
                            <input type="text" id="edit-series-publisher" name="publisher">
                        </div>

                        <!-- Seri Etiketi -->
                        <div class="form-group form-row-full">
                            <label>📋 Seri Etiketi</label>
                            <div class="label-config">
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="edit-series-label-enabled">Etiket Durumu</label>
                                        <select id="edit-series-label-enabled" onchange="toggleLabelSettings()">
                                            <option value="none">Etiket Yok</option>
                                            <option value="false">Etiketi Gizle</option>
                                            <option value="true">Etiketi Göster</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div id="label-settings" style="display: none;">
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label for="edit-series-label-text">Etiket Metni</label>
                                            <select id="edit-series-label-text">
                                                <option value="Yeni">🌟 Yeni</option>
                                                <option value="Güncel">🔥 Güncel</option>
                                                <option value="Yeni Sezon">📺 Yeni Sezon</option>
                                                <option value="Sezon Finali">🏁 Sezon Finali</option>
                                                <option value="Popüler">⭐ Popüler</option>
                                                <option value="Tamamlandı">✅ Tamamlandı</option>
                                                <option value="Ara Verildi">⏸️ Ara Verildi</option>
                                                <option value="Bırakıldı">🛑 Bırakıldı</option>
                                            </select>
                                        </div>
                                        
                                        <div class="form-group">
                                            <label for="edit-series-label-color">Etiket Rengi</label>
                                            <select id="edit-series-label-color">
                                                <option value="#4CAF50">🟢 Yeşil (Yeni)</option>
                                                <option value="#FF9800">🟠 Turuncu (Güncel)</option>
                                                <option value="#2196F3">🔵 Mavi (Sezon)</option>
                                                <option value="#9C27B0">🟣 Mor (Final)</option>
                                                <option value="#F44336">🔴 Kırmızı (Popüler)</option>
                                                <option value="#607D8B">⚫ Gri (Tamamlandı)</option>
                                                <option value="#FFC107">🟡 Sarı (Ara Verildi)</option>
                                                <option value="#795548">🤎 Kahverengi (Bırakıldı)</option>
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <div class="label-preview">
                                        <span>Önizleme: </span>
                                        <span id="label-preview-badge" class="series-label" style="background: #4CAF50;">🌟 Yeni</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div id="edit-cover-preview" class="preview-container" style="display: none;">
                            <h4>📸 Kapak Önizleme:</h4>
                            <img id="edit-preview-image" style="max-width: 200px; border-radius: 8px;">
                        </div>

                        <div class="form-actions">
                            <button type="submit" class="btn">💾 Değişiklikleri Kaydet</button>
                            <button type="button" class="btn btn-secondary" onclick="cancelEdit()">❌ İptal</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Seri Silme -->
            <div id="delete-tab" class="tab-content">
                <h2>🗑️ Seri Sil</h2>
                <div class="warning-box" style="background: #ffe6e6; border: 1px solid #ff6b6b; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <strong>⚠️ DİKKAT:</strong> Bu işlem geri alınamaz! Seriyi sildiğinizde:
                    <ul style="margin: 10px 0 0 20px;">
                        <li>manhwalar.json'dan seri bilgileri silinir</li>
                        <li>chapters/ klasöründen tüm bölümler silinir</li>
                        <li>series/ klasöründen seri sayfası silinir</li>
                        <li>Veritabanından tüm yorumlar, puanlar ve favori kayıtları silinir</li>
                    </ul>
                </div>

                <div class="form-group">
                    <label for="delete-series">Silinecek Seri</label>
                    <select id="delete-series" required>
                        <option value="">-- Seri Seçin --</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="confirm-delete">Silme işlemini onaylamak için "SİL" yazın</label>
                    <input type="text" id="confirm-delete" placeholder="SİL yazın" maxlength="3">
                </div>

                <button type="button" class="btn" style="background: #ff6b6b;" onclick="deleteSeries()" id="delete-btn" disabled>
                    🗑️ Seriyi Sil
                </button>

                <div id="delete-result" class="result-container" style="display: none;">
                    <h4>Silme Sonucu:</h4>
                    <div id="delete-details"></div>
                </div>
            </div>

            <!-- Okuma İstatistikleri -->
            <div id="stats-tab" class="tab-content">
                <h2>📊 Okuma İstatistikleri</h2>
                
                <!-- İstatistik Kartları -->
                <div class="stats-container" style="display: flex; gap: 20px; margin-bottom: 30px; flex-wrap: wrap;">
                    <div class="stat-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; min-width: 200px;">
                        <div class="stat-number" id="total-reads-today">-</div>
                        <div class="stat-label">Bugünkü Okumalar</div>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; min-width: 200px;">
                        <div class="stat-number" id="total-reads-week">-</div>
                        <div class="stat-label">Bu Hafta</div>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; min-width: 200px;">
                        <div class="stat-number" id="total-reads-all">-</div>
                        <div class="stat-label">Toplam Okuma</div>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); color: white; min-width: 200px;">
                        <div class="stat-number" id="total-series-read">-</div>
                        <div class="stat-label">Okunan Seri Sayısı</div>
                    </div>
                </div>

                <!-- Filtreler -->
                <div class="form-group" style="margin-bottom: 20px;">
                    <div style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
                        <div>
                            <label for="stats-series-filter">Seri Filtresi:</label>
                            <select id="stats-series-filter" style="padding: 8px; border-radius: 4px; border: 1px solid #ddd; min-width: 200px;">
                                <option value="">Tüm Seriler</option>
                            </select>
                        </div>
                        <div>
                            <label for="stats-period-filter">Dönem:</label>
                            <select id="stats-period-filter" style="padding: 8px; border-radius: 4px; border: 1px solid #ddd;">
                                <option value="all">Tüm Zamanlar</option>
                                <option value="week">Bu Hafta</option>
                                <option value="month">Bu Ay</option>
                            </select>
                        </div>
                        <button onclick="loadDetailedStats()" style="padding: 8px 16px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">
                            🔄 Yenile
                        </button>
                    </div>
                </div>

                <!-- En Popüler Seriler -->
                <div style="margin-bottom: 30px;">
                    <h3>🔥 En Popüler Seriler</h3>
                    <div class="table-container">
                        <table style="width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                            <thead style="background: #f8f9fa;">
                                <tr>
                                    <th style="padding: 12px; text-align: left; border-bottom: 1px solid #dee2e6;">#</th>
                                    <th style="padding: 12px; text-align: left; border-bottom: 1px solid #dee2e6;">Seri Adı</th>
                                    <th style="padding: 12px; text-align: center; border-bottom: 1px solid #dee2e6;">Toplam Okuma</th>
                                    <th style="padding: 12px; text-align: center; border-bottom: 1px solid #dee2e6;">Haftalık</th>
                                    <th style="padding: 12px; text-align: center; border-bottom: 1px solid #dee2e6;">Bölüm Sayısı</th>
                                    <th style="padding: 12px; text-align: center; border-bottom: 1px solid #dee2e6;">Ortalama/Bölüm</th>
                                    <th style="padding: 12px; text-align: center; border-bottom: 1px solid #dee2e6;">Son Okuma</th>
                                </tr>
                            </thead>
                            <tbody id="popular-series-table">
                                <tr>
                                    <td colspan="7" style="padding: 20px; text-align: center; color: #666;">İstatistikler yükleniyor...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Detaylı Bölüm İstatistikleri -->
                <div>
                    <h3>📖 Detaylı Bölüm İstatistikleri</h3>
                    <div class="table-container">
                        <table style="width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                            <thead style="background: #f8f9fa;">
                                <tr>
                                    <th style="padding: 12px; text-align: left; border-bottom: 1px solid #dee2e6;">Seri</th>
                                    <th style="padding: 12px; text-align: center; border-bottom: 1px solid #dee2e6;">Bölüm</th>
                                    <th style="padding: 12px; text-align: center; border-bottom: 1px solid #dee2e6;">Toplam Okuma</th>
                                    <th style="padding: 12px; text-align: center; border-bottom: 1px solid #dee2e6;">Haftalık</th>
                                    <th style="padding: 12px; text-align: center; border-bottom: 1px solid #dee2e6;">Günlük</th>
                                    <th style="padding: 12px; text-align: center; border-bottom: 1px solid #dee2e6;">Son Okuma</th>
                                </tr>
                            </thead>
                            <tbody id="detailed-stats-table">
                                <tr>
                                    <td colspan="6" style="padding: 20px; text-align: center; color: #666;">İstatistikler yükleniyor...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Pagination -->
                    <div id="stats-pagination" style="margin-top: 20px; text-align: center;">
                        <!-- Pagination controls will be added here -->
                    </div>
                </div>
            </div>

            <!-- Yorum Yönetimi -->
            <div id="comments-tab" class="tab-content">
                <h2>💬 Yorum Yönetimi</h2>
                
                <!-- Rapor İstatistikleri -->
                <div class="stats-container" style="display: flex; gap: 20px; margin-bottom: 30px;">
                    <div class="stat-card" style="background: #ff4444; color: white;">
                        <div class="stat-number" id="pending-reports">-</div>
                        <div class="stat-label">Bekleyen Raporlar</div>
                    </div>
                    <div class="stat-card" style="background: #4CAF50; color: white;">
                        <div class="stat-number" id="total-reports">-</div>
                        <div class="stat-label">Toplam Raporlar</div>
                    </div>
                    <div class="stat-card" style="background: #ff9800; color: white;">
                        <div class="stat-number" id="reported-comments">-</div>
                        <div class="stat-label">Raporlanan Yorumlar</div>
                    </div>
                </div>

                <!-- Filtreler -->
                <div class="filter-section" style="background: #f5f5f5; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                    <div style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
                        <div class="form-group" style="margin: 0; min-width: 150px;">
                            <label>Rapor Durumu:</label>
                            <select id="report-status-filter" onchange="loadReports()">
                                <option value="pending">Bekleyen</option>
                                <option value="reviewed">İncelenen</option>
                                <option value="resolved">Çözümlenen</option>
                                <option value="dismissed">Reddedilen</option>
                                <option value="all">Tümü</option>
                            </select>
                        </div>
                        <div class="form-group" style="margin: 0; min-width: 150px;">
                            <label>Seri:</label>
                            <select id="series-filter" onchange="loadReports()">
                                <option value="">Tüm Seriler</option>
                            </select>
                        </div>
                        <button onclick="loadReports()" style="background: #667eea; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">🔄 Yenile</button>
                    </div>
                </div>

                <!-- Raporlar Listesi -->
                <div class="reports-section">
                    <h3>📋 Raporlanan Yorumlar</h3>
                    <div id="reports-list"></div>
                    <div id="reports-pagination" style="text-align: center; margin-top: 20px;"></div>
                </div>

                <!-- Seri Bazında Yorum Yönetimi -->
                <div class="comments-management" style="margin-top: 40px;">
                    <h3>🗂️ Seri Bazında Yorum Yönetimi</h3>
                    <div class="form-group">
                        <label>Seri Seçin:</label>
                        <select id="comment-series-select" onchange="loadSeriesComments()">
                            <option value="">-- Seri Seçin --</option>
                        </select>
                    </div>
                    <div id="series-comments" style="display: none;">
                        <div id="series-comments-list"></div>
                        <div id="series-comments-pagination" style="text-align: center; margin-top: 20px;"></div>
                    </div>
                </div>
            </div>

            <!-- Duyuru Yönetimi -->
            <div id="announcements-tab" class="tab-content">
                <h2>📢 Duyuru Yönetimi</h2>
                
                <!-- Yeni Duyuru Ekleme -->
                <div class="form-section">
                    <h3>🆕 Yeni Duyuru Ekle</h3>
                    <form id="announcement-form">
                        <div class="form-group">
                            <label for="announcement-title">Başlık:</label>
                            <input type="text" id="announcement-title" name="title" required maxlength="200" placeholder="Duyuru başlığı">
                        </div>
                        
                        <div class="form-group">
                            <label for="announcement-content">İçerik:</label>
                            <textarea id="announcement-content" name="content" required rows="4" placeholder="Duyuru içeriği..."></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label for="announcement-type">Tip:</label>
                            <select id="announcement-type" name="type" required>
                                <option value="info">ℹ️ Bilgi</option>
                                <option value="warning">⚠️ Uyarı</option>
                                <option value="success">✅ Başarı</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="announcement-active" name="isActive" checked>
                                Duyuru aktif olsun
                            </label>
                        </div>
                        
                        <div class="button-group">
                            <button type="submit" class="btn-primary">📢 Duyuru Ekle</button>
                            <button type="button" id="clear-announcement-form" class="btn-secondary">🧹 Temizle</button>
                        </div>
                    </form>
                </div>

                <!-- Mevcut Duyurular -->
                <div class="form-section">
                    <h3>📋 Mevcut Duyurular</h3>
                    <div class="filter-group">
                        <label for="announcement-filter">Filtrele:</label>
                        <select id="announcement-filter">
                            <option value="all">Tümü</option>
                            <option value="active">Aktif</option>
                            <option value="inactive">Pasif</option>
                        </select>
                        <button id="refresh-announcements" class="btn-secondary">🔄 Yenile</button>
                    </div>
                    <div id="announcements-list" class="announcements-list">
                        <!-- Duyurular buraya yüklenecek -->
                    </div>
                    <div id="announcements-pagination" class="pagination-container"></div>
                </div>
            </div>

            <!-- Kullanıcı Yönetimi -->
            <div id="users-tab" class="tab-content">
                <h2>👥 Kullanıcı Yönetimi</h2>
                
                <!-- Kullanıcı İstatistikleri -->
                <div class="stats-container" style="display: flex; gap: 20px; margin-bottom: 30px;">
                    <div class="stat-card" style="flex: 1; background: #f8f9fa; padding: 20px; border-radius: 10px; text-align: center;">
                        <h3 style="color: #667eea; margin-bottom: 10px;" id="total-users-count">0</h3>
                        <p style="color: #666;">Toplam Kullanıcı</p>
                    </div>
                    <div class="stat-card" style="flex: 1; background: #f8f9fa; padding: 20px; border-radius: 10px; text-align: center;">
                        <h3 style="color: #28a745; margin-bottom: 10px;" id="admin-users-count">0</h3>
                        <p style="color: #666;">Admin Kullanıcı</p>
                    </div>
                    <div class="stat-card" style="flex: 1; background: #f8f9fa; padding: 20px; border-radius: 10px; text-align: center;">
                        <h3 style="color: #ffc107; margin-bottom: 10px;" id="moderator-users-count">0</h3>
                        <p style="color: #666;">Moderatör</p>
                    </div>
                    <div class="stat-card" style="flex: 1; background: #f8f9fa; padding: 20px; border-radius: 10px; text-align: center;">
                        <h3 style="color: #dc3545; margin-bottom: 10px;" id="blocked-users-count">0</h3>
                        <p style="color: #666;">Engelli Kullanıcı</p>
                    </div>
                </div>

                <!-- Kullanıcı Arama -->
                <div class="form-group">
                    <label for="user-search">🔍 Kullanıcı Ara</label>
                    <input type="text" id="user-search" placeholder="Kullanıcı adı veya e-posta ile ara..." onkeyup="filterUsers()">
                </div>

                <!-- Kullanıcı Listesi -->
                <div id="users-list-container">
                    <div id="users-loading" style="text-align: center; padding: 40px; color: #666;">
                        <div style="font-size: 18px;">Kullanıcılar yükleniyor...</div>
                    </div>
                    <div id="users-list" style="display: none;"></div>
                </div>

                <!-- Kullanıcı Detay Modalı -->
                <div id="user-detail-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
                    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 15px; width: 90%; max-width: 600px; max-height: 80%; overflow-y: auto;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h3>👤 Kullanıcı Detayları</h3>
                            <button onclick="closeUserModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #999;">&times;</button>
                        </div>
                        <div id="user-detail-content"></div>
                        
                        <!-- Moderatör Atama Bölümü -->
                        <div id="moderator-assignment-section" style="display: none; margin-top: 20px; padding-top: 20px; border-top: 2px solid #f0f0f0;">
                            <h4 style="margin-bottom: 15px; color: #667eea;">🛡️ Moderatör Yönetimi</h4>
                            <form id="user-moderator-form">
                                <input type="hidden" id="selected-user-id">
                                
                                <div class="form-group">
                                    <label for="user-series-select">Atanacak Seriler (Ctrl+Click ile çoklu seçim)</label>
                                    <select id="user-series-select" multiple size="6" style="min-height: 150px; width: 100%;">
                                        <!-- Seriler dinamik olarak yüklenecek -->
                                    </select>
                                    <small style="color: #666; display: block; margin-top: 5px;">
                                        Ctrl tuşuna basarak birden fazla seri seçebilirsiniz
                                    </small>
                                </div>
                                
                                <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 15px;">
                                    <button type="button" id="make-moderator-btn" class="btn" onclick="makeUserModerator()">
                                        🛡️ Moderatör Yap
                                    </button>
                                    <button type="button" id="update-moderator-btn" class="btn" onclick="updateUserModeratorSeries()" style="display: none;">
                                        💾 Serileri Güncelle
                                    </button>
                                    <button type="button" id="remove-moderator-btn" class="btn btn-danger" onclick="removeUserModerator()" style="display: none;">
                                        🗑️ Moderatör Kaldır
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Moderatör Yönetimi -->
            <div id="moderators-tab" class="tab-content">
                <h2>🛡️ Moderatör Yönetimi</h2>
                
                <!-- Moderatör İstatistikleri -->
                <div class="stats-container" style="display: flex; gap: 20px; margin-bottom: 30px;">
                    <div class="stat-card" style="flex: 1; background: #f8f9fa; padding: 20px; border-radius: 10px; text-align: center;">
                        <h3 style="color: #667eea; margin-bottom: 10px;" id="total-moderators-count">0</h3>
                        <p style="color: #666;">Toplam Moderatör</p>
                    </div>
                    <div class="stat-card" style="flex: 1; background: #f8f9fa; padding: 20px; border-radius: 10px; text-align: center;">
                        <h3 style="color: #28a745; margin-bottom: 10px;" id="active-moderators-count">0</h3>
                        <p style="color: #666;">Aktif Moderatör</p>
                    </div>
                    <div class="stat-card" style="flex: 1; background: #f8f9fa; padding: 20px; border-radius: 10px; text-align: center;">
                        <h3 style="color: #ffc107; margin-bottom: 10px;" id="managed-series-count">0</h3>
                        <p style="color: #666;">Yönetilen Seri</p>
                    </div>
                </div>

                <!-- Mevcut Moderatörler -->
                <div>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3>📋 Mevcut Moderatörler</h3>
                        <div style="color: #666; font-size: 14px;">
                            💡 Yeni moderatör atamak için "Kullanıcı Yönetimi" sekmesini kullanın
                        </div>
                    </div>
                    <div id="moderators-loading" style="text-align: center; padding: 40px; color: #666;">
                        <div style="font-size: 18px;">Moderatörler yükleniyor...</div>
                    </div>
                    <div id="moderators-list" style="display: none;"></div>
                </div>

                <!-- Moderatör Düzenleme Modalı -->
                <div id="moderator-edit-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
                    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 15px; width: 90%; max-width: 600px; max-height: 80%; overflow-y: auto;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h3>✏️ Moderatör Düzenle</h3>
                            <button onclick="closeModeratorModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #999;">&times;</button>
                        </div>
                        <form id="edit-moderator-form">
                            <input type="hidden" id="edit-moderator-id">
                            
                            <div class="form-group">
                                <label>Kullanıcı Bilgileri</label>
                                <div id="edit-moderator-info" style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                                    <!-- Kullanıcı bilgileri buraya gelecek -->
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label for="edit-series-select">Atanmış Seriler</label>
                                <select id="edit-series-select" multiple size="8" style="min-height: 200px;">
                                    <!-- Seriler dinamik olarak yüklenecek -->
                                </select>
                                <small style="color: #666; display: block; margin-top: 5px;">
                                    Ctrl tuşuna basarak birden fazla seri seçebilirsiniz
                                </small>
                            </div>
                            
                            <div style="display: flex; gap: 10px; justify-content: flex-end;">
                                <button type="submit" class="btn">💾 Güncelle</button>
                                <button type="button" class="btn btn-danger" onclick="removeModerator()">🗑️ Moderatör Kaldır</button>
                                <button type="button" class="btn btn-secondary" onclick="closeModeratorModal()">❌ İptal</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Link Doğrulama -->
            <div id="validate-tab" class="tab-content">
                <h2>🔗 Google Drive Link Doğrula</h2>
                <form id="validate-form">
                    <div class="form-group">
                        <label for="validate-url">Google Drive Link</label>
                        <input type="url" id="validate-url" name="driveUrl" required placeholder="https://drive.google.com/file/d/...">
                    </div>

                    <button type="submit" class="btn">🔍 Doğrula</button>
                </form>

                <div id="validation-result" class="preview-container" style="display: none;">
                    <h4>Doğrulama Sonucu:</h4>
                    <div id="validation-details"></div>
                </div>
            </div>

            <!-- Bölüm Yönetimi Tab -->
            <div id="manage-tab" class="tab-content" style="display: none;">
                <h2>⚙️ Bölüm Yönetimi</h2>
                
                <!-- Seri Seçimi -->
                <div class="form-group">
                    <label for="manage-series">Seri Seç</label>
                    <select id="manage-series" onchange="loadSeriesChapters(this.value)">
                        <option value="">-- Seri Seçin --</option>
                    </select>
                </div>

                <!-- Bölüm Listesi -->
                <div id="chapters-list-container" style="display: none;">
                    <h3>📖 Bölümler</h3>
                    <div id="chapters-list"></div>
                </div>

                <!-- Bölüm Düzenleme Formu -->
                <div id="chapter-edit-form" class="preview-container" style="display: none;">
                    <h3>✏️ Bölüm Düzenle</h3>
                    <form id="edit-chapter-form">
                        <input type="hidden" id="edit-series-id">
                        <input type="hidden" id="edit-chapter-original-number">
                        
                        <div class="form-group">
                            <label for="edit-chapter-number">Bölüm Numarası</label>
                            <input type="number" id="edit-chapter-number" required min="1">
                        </div>
                        
                        <div class="form-group">
                            <label for="edit-chapter-title">Bölüm Başlığı</label>
                            <input type="text" id="edit-chapter-title" required>
                        </div>
                        
                        <div class="form-group">
                            <label>Görsel URL'leri</label>
                            <div id="edit-image-inputs" class="images-input-container">
                                <!-- Dinamik olarak doldurulacak -->
                            </div>
                            <button type="button" class="btn btn-secondary" onclick="addEditImageInput()">➕ Görsel Ekle</button>
                        </div>
                        
                        <div class="form-actions">
                            <button type="submit" class="btn">💾 Güncelle</button>
                            <button type="button" class="btn btn-secondary" onclick="cancelEdit()">❌ İptal</button>
                            <button type="button" class="btn btn-danger" onclick="deleteChapter()">🗑️ Sil</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script src="config.js?v=5"></script>
    <script>
        // API Base URL - local development için
        const API_BASE = 'https://toonnekoauth-api.onrender.com/api';
        
        // Giriş kontrolü
        function checkAuthentication() {
            const token = localStorage.getItem('token');
            if (!token) {
                // Ana içeriği gizle
                document.querySelector('.admin-container').style.display = 'none';
                // Giriş sayfasına yönlendir veya giriş modalı göster
                showLoginForm();
                return false;
            }
            return true;
        }
        
        // Basit giriş formu göster
        function showLoginForm() {
            const loginHtml = `
                <div id="login-overlay" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 9999; display: flex; align-items: center; justify-content: center;">
                    <div style="background: white; padding: 30px; border-radius: 15px; width: 400px; max-width: 90%;">
                        <h2 style="text-align: center; margin-bottom: 20px; color: #333;">Admin Paneli Girişi</h2>
                        <form id="admin-login-form">
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Kullanıcı Adı veya Email:</label>
                                <input type="text" id="admin-username" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;" required>
                            </div>
                            <div style="margin-bottom: 20px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Şifre:</label>
                                <input type="password" id="admin-password" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;" required>
                            </div>
                            <button type="submit" style="width: 100%; padding: 12px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 5px; font-size: 16px; cursor: pointer;">Giriş Yap</button>
                            <div id="login-error" style="color: #dc3545; text-align: center; margin-top: 10px; display: none;"></div>
                        </form>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', loginHtml);
            
            document.getElementById('admin-login-form').addEventListener('submit', handleAdminLogin);
        }
        
        // Admin girişi işle
        async function handleAdminLogin(e) {
            e.preventDefault();
            
            const username = document.getElementById('admin-username').value;
            const password = document.getElementById('admin-password').value;
            const errorDiv = document.getElementById('login-error');
            
            try {
                const response = await fetch('https://toonnekoauth-api.onrender.com/api/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ identifier: username, password })
                });
                
                const data = await response.json();
                
                if (response.ok && data.token) {
                    // Admin kontrolü
                    if (!data.user.isAdmin) {
                        errorDiv.textContent = 'Bu hesap admin yetkisine sahip değil.';
                        errorDiv.style.display = 'block';
                        return;
                    }
                    
                    localStorage.setItem('token', data.token);
                    document.getElementById('login-overlay').remove();
                    
                    // Ana içeriği göster
                    document.querySelector('.admin-container').style.display = 'block';
                    
                    // Hoş geldin mesajı
                    alert(`Hoş geldiniz, ${data.user.username}!`);
                } else {
                    errorDiv.textContent = data.message || 'Giriş başarısız';
                    errorDiv.style.display = 'block';
                }
            } catch (error) {
                errorDiv.textContent = 'Giriş yapılırken hata oluştu: ' + error.message;
                errorDiv.style.display = 'block';
            }
        }
        
        // Google Drive Helper Functions
        function extractFileId(driveUrl) {
            const match = driveUrl.match(/\/file\/d\/([a-zA-Z0-9_-]+)/);
            return match ? match[1] : null;
        }
        
        function createProxyUrl(fileId) {
            return `${API_BASE}/image/proxy-image/${fileId}`;
        }
        
        function createDirectUrls(fileId) {
            return {
                proxy: `${API_BASE}/image/proxy-image/${fileId}`,
                high: `https://drive.google.com/uc?export=view&id=${fileId}`,
                download: `https://drive.usercontent.google.com/download?id=${fileId}&authuser=0`,
                medium: `https://drive.google.com/uc?id=${fileId}`,
                thumbnail: `https://drive.google.com/thumbnail?id=${fileId}&sz=s1600`
            };
        }
        
        // Tab switching
        function switchTab(tabName) {
            // Remove active class from all tabs
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
                content.style.display = 'none';
            });
            
            // Add active class to selected tab
            event.target.classList.add('active');
            const targetTab = document.getElementById(tabName + '-tab');
            targetTab.classList.add('active');
            targetTab.style.display = 'block';
            
            // Manage tab açıldığında serileri yükle
            if (tabName === 'manage') {
                loadSeriesList();
            }
            
            // Chapter tab açıldığında serileri yükle
            if (tabName === 'chapter') {
                loadChapterSeriesList();
            }
            
            // Edit tab açıldığında serileri yükle
            if (tabName === 'edit') {
                loadEditSeriesList();
            }
            
            // Delete tab açıldığında serileri yükle
            if (tabName === 'delete') {
                loadDeleteSeriesList();
            }
            
            // Comments tab açıldığında verileri yükle
            if (tabName === 'comments') {
                loadReportsStats();
                loadReports();
                loadCommentsSeriesList();
            }
            
            // Stats tab açıldığında istatistikleri yükle
            if (tabName === 'stats') {
                loadStatsOverview();
                loadDetailedStats();
                loadStatsSeriesList();
            }
            
            // Announcements tab açıldığında duyuruları yükle
            if (tabName === 'announcements') {
                loadAnnouncements();
            }
        }

        // Show status message
        function showStatus(message, type) {
            const statusDiv = document.getElementById('status-message');
            statusDiv.textContent = message;
            statusDiv.className = `status-message ${type}`;
            statusDiv.style.display = 'block';
            
            setTimeout(() => {
                statusDiv.style.display = 'none';
            }, 5000);
        }

        // Show/hide loading
        function toggleLoading(show) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
        }

        // Show/hide loading (alias for consistency)
        function showLoading(show) {
            toggleLoading(show);
        }

        // Get auth token (assuming it's stored in localStorage)
        function getAuthToken() {
            // Test için varsayılan token
            return localStorage.getItem('token') || 'test-admin-token-for-development';
        }

        // Image input management
        function addImageInput() {
            const container = document.getElementById('image-inputs');
            const inputCount = container.children.length;
            
            const newInputDiv = document.createElement('div');
            newInputDiv.className = 'image-input-item';
            newInputDiv.innerHTML = `
                <input type="url" placeholder="Sayfa ${inputCount + 1} Google Drive linki" required>
                <button type="button" class="btn btn-danger btn-small" onclick="removeImageInput(this)">Sil</button>
            `;
            
            container.appendChild(newInputDiv);
        }

        function removeImageInput(button) {
            const container = document.getElementById('image-inputs');
            if (container.children.length > 1) {
                button.parentElement.remove();
                
                // Update placeholders
                const inputs = container.querySelectorAll('input');
                inputs.forEach((input, index) => {
                    input.placeholder = `Sayfa ${index + 1} Google Drive linki`;
                });
            }
        }

        // Cover image validation
        async function validateCoverImage() {
            const coverUrl = document.getElementById('series-cover').value;
            if (!coverUrl) {
                showStatus('Lütfen kapak görseli linkini girin', 'error');
                return;
            }

            const fileId = extractFileId(coverUrl);
            if (!fileId) {
                showStatus('Geçersiz Google Drive link formatı!', 'error');
                return;
            }

            toggleLoading(true);
            showStatus(`File ID: ${fileId} - Test başlatılıyor...`, 'info');
            
            try {
                // Test multiple URL formats
                const proxyUrl = `${API_BASE}/image/proxy-image/${fileId}`;
                const directUrls = createDirectUrls(fileId);
                
                console.log('Testing URLs:', { proxyUrl, directUrls });
                
                // Clear previous preview
                const previewDiv = document.getElementById('cover-preview');
                previewDiv.innerHTML = `
                    <h4>Görsel Test Sonuçları:</h4>
                    <div id="test-results"></div>
                `;
                previewDiv.style.display = 'block';
                
                const resultsDiv = document.getElementById('test-results');
                
                // Test proxy URL first (recommended)
                await testImageFormat(resultsDiv, 'Server Proxy (Önerilen)', proxyUrl, true);
                
                // Test direct formats
                await testImageFormat(resultsDiv, 'High Quality Direct', directUrls.high, false);
                await testImageFormat(resultsDiv, 'Download Format', directUrls.download, false);
                await testImageFormat(resultsDiv, 'Medium Quality', directUrls.medium, false);
                
            } catch (error) {
                showStatus('Doğrulama sırasında hata oluştu: ' + error.message, 'error');
                console.error('Validation error:', error);
            }
            
            toggleLoading(false);
        }
        
        async function testImageFormat(container, formatName, url, isRecommended) {
            return new Promise((resolve) => {
                const testDiv = document.createElement('div');
                testDiv.style.cssText = `
                    margin: 10px 0; 
                    padding: 10px; 
                    border: 1px solid #ddd; 
                    border-radius: 5px;
                    background: ${isRecommended ? '#e8f5e8' : '#f8f9fa'};
                `;
                
                testDiv.innerHTML = `
                    <h5>${isRecommended ? '🛡️' : '🌐'} ${formatName}</h5>
                    <div style="font-size: 12px; color: #666; word-break: break-all; margin: 5px 0;">${url}</div>
                    <p id="status-${formatName.replace(/\s+/g, '-').toLowerCase()}">Test ediliyor...</p>
                    <div id="image-container-${formatName.replace(/\s+/g, '-').toLowerCase()}"></div>
                `;
                
                container.appendChild(testDiv);
                
                const statusEl = document.getElementById(`status-${formatName.replace(/\s+/g, '-').toLowerCase()}`);
                const imgContainer = document.getElementById(`image-container-${formatName.replace(/\s+/g, '-').toLowerCase()}`);
                
                const img = new Image();
                img.style.cssText = 'max-width: 200px; max-height: 200px; border: 2px solid #ddd; border-radius: 5px; margin-top: 10px;';
                
                const startTime = Date.now();
                
                img.onload = function() {
                    const loadTime = Date.now() - startTime;
                    img.style.borderColor = '#28a745';
                    statusEl.innerHTML = `✅ Başarılı! (${loadTime}ms)<br><small>${img.naturalWidth} x ${img.naturalHeight}px</small>`;
                    imgContainer.appendChild(img);
                    
                    if (isRecommended) {
                        showStatus(`✅ Kapak görseli başarıyla yüklendi! (${formatName})`, 'success');
                    }
                    resolve(true);
                };
                
                img.onerror = function() {
                    const loadTime = Date.now() - startTime;
                    img.style.borderColor = '#dc3545';
                    statusEl.innerHTML = `❌ Yüklenemedi (${loadTime}ms)<br><small>CORS veya erişim hatası</small>`;
                    
                    // Show error placeholder
                    img.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgZmlsbD0iI2Y4ZjlmYSIvPjx0ZXh0IHg9IjUwIiB5PSI1MCIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjE0IiBmaWxsPSIjNmM3NTdkIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBkeT0iMC4zZW0iPkVycm9yPC90ZXh0Pjwvc3ZnPg==';
                    imgContainer.appendChild(img);
                    resolve(false);
                };
                
                img.src = url;
                
                // Timeout after 10 seconds
                setTimeout(() => {
                    if (statusEl.textContent === 'Test ediliyor...') {
                        statusEl.innerHTML = '⏰ Zaman aşımı (10s+)';
                        resolve(false);
                    }
                }, 10000);
            });
        }

        // Preview chapter images
        async function previewImages() {
            const imageInputs = document.querySelectorAll('#image-inputs input');
            const urls = Array.from(imageInputs).map(input => input.value).filter(url => url);
            
            if (urls.length === 0) {
                showStatus('Lütfen en az bir görsel linki girin', 'error');
                return;
            }

            toggleLoading(true);
            
            const previewContainer = document.getElementById('preview-images-container');
            previewContainer.innerHTML = '';
            
            // Convert URLs to proxy format and display images
            for (let i = 0; i < urls.length; i++) {
                const fileId = extractFileId(urls[i]);
                
                if (fileId) {
                    const proxyUrl = createProxyUrl(fileId);
                    
                    const imgContainer = document.createElement('div');
                    imgContainer.style.cssText = 'margin: 10px; text-align: center; border: 1px solid #ddd; padding: 10px; border-radius: 5px;';
                    
                    const img = document.createElement('img');
                    img.className = 'preview-image';
                    img.alt = `Sayfa ${i + 1}`;
                    img.style.cssText = 'max-width: 150px; border: 2px solid #28a745; border-radius: 5px;';
                    
                    const label = document.createElement('p');
                    label.innerHTML = `<strong>Sayfa ${i + 1}</strong><br><small>Proxy URL</small>`;
                    
                    img.onload = function() {
                        img.style.borderColor = '#28a745';
                        label.innerHTML = `<strong>Sayfa ${i + 1} ✅</strong><br><small>${img.naturalWidth}x${img.naturalHeight}px</small>`;
                    };
                    
                    img.onerror = function() {
                        img.style.borderColor = '#dc3545';
                        img.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgeG1zbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgZmlsbD0iI2Y4ZjlmYSIvPjx0ZXh0IHg9IjUwIiB5PSI1MCIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjE0IiBmaWxsPSIjNmM3NTdkIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBkeT0iMC4zZW0iPkVycm9yPC90ZXh0Pjwvc3ZnPg==';
                        label.innerHTML = `<strong>Sayfa ${i + 1} ❌</strong><br><small>Yüklenemedi</small>`;
                    };
                    
                    img.src = proxyUrl;
                    
                    imgContainer.appendChild(label);
                    imgContainer.appendChild(img);
                    previewContainer.appendChild(imgContainer);
                } else {
                    const errorDiv = document.createElement('div');
                    errorDiv.textContent = `Sayfa ${i + 1}: Geçersiz Google Drive link`;
                    errorDiv.style.color = 'red';
                    previewContainer.appendChild(errorDiv);
                }
            }
            
            document.getElementById('images-preview').style.display = 'block';
            toggleLoading(false);
        }

        // Form submissions
        document.getElementById('series-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData);
            
            // Client-side validasyon
            if (!data.title || data.title.trim().length === 0) {
                showStatus('Seri başlığı gerekli', 'error');
                return;
            }
            
            if (!data.seriesId || data.seriesId.trim().length === 0) {
                showStatus('Seri ID gerekli', 'error');
                return;
            }
            
            // Seri ID normalize et (sadece alfanumerik karakterler)
            data.seriesId = data.seriesId.toLowerCase().replace(/[^a-z0-9]/g, '');
            
            if (data.seriesId.length < 3) {
                showStatus('Seri ID en az 3 karakter olmalı', 'error');
                return;
            }
            
            if (!data.coverImageUrl || data.coverImageUrl.trim().length === 0) {
                showStatus('Kapak görseli gerekli', 'error');
                return;
            }
            
            // Google Drive link kontrolü
            if (!data.coverImageUrl.includes('drive.google.com') || !data.coverImageUrl.includes('/file/d/')) {
                showStatus('Geçerli bir Google Drive linki girin', 'error');
                return;
            }
            
            // Parse genre
            if (data.genre) {
                data.genre = data.genre.split(',').map(g => g.trim());
            }
            
            toggleLoading(true);
            
            try {
                const response = await fetch(`${API_BASE}/admin/create-series`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                const result = await response.json();
                
                if (result.success) {
                    showStatus('Seri başarıyla oluşturuldu!', 'success');
                    e.target.reset();
                    document.getElementById('cover-preview').style.display = 'none';
                } else {
                    // Detaylı hata mesajı göster
                    let errorMessage = result.error || 'Seri oluşturulamadı';
                    if (result.details && Array.isArray(result.details)) {
                        errorMessage += ':\n' + result.details.join('\n');
                    }
                    if (result.existingTitle) {
                        errorMessage += '\nMevcut seri: ' + result.existingTitle;
                    }
                    showStatus(errorMessage, 'error');
                }
            } catch (error) {
                showStatus('Bağlantı hatası', 'error');
                console.error('Series creation error:', error);
            }
            
            toggleLoading(false);
        });

        document.getElementById('chapter-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const imageInputs = document.querySelectorAll('#image-inputs input');
            const imageUrls = Array.from(imageInputs).map(input => input.value).filter(url => url);
            
            // Client-side validasyon
            if (!formData.get('seriesId') || formData.get('seriesId').trim().length === 0) {
                showStatus('Seri ID gerekli', 'error');
                return;
            }
            
            if (!formData.get('chapterNumber') || isNaN(parseInt(formData.get('chapterNumber')))) {
                showStatus('Geçerli bir bölüm numarası gerekli', 'error');
                return;
            }
            
            if (parseInt(formData.get('chapterNumber')) <= 0) {
                showStatus('Bölüm numarası 0\'dan büyük olmalı', 'error');
                return;
            }
            
            if (imageUrls.length === 0) {
                showStatus('Lütfen en az bir görsel linki girin', 'error');
                return;
            }
            
            // Google Drive linklerini kontrol et
            for (let i = 0; i < imageUrls.length; i++) {
                const url = imageUrls[i];
                if (!url.includes('drive.google.com') || !url.includes('/file/d/')) {
                    showStatus(`${i + 1}. görsel için geçerli bir Google Drive linki girin`, 'error');
                    return;
                }
            }
            
            const data = {
                seriesId: formData.get('seriesId').toLowerCase().replace(/[^a-z0-9]/g, ''),
                chapterNumber: parseInt(formData.get('chapterNumber')),
                title: formData.get('title') || `Bölüm ${formData.get('chapterNumber')}`,
                imageUrls: imageUrls
            };
            
            toggleLoading(true);
            
            try {
                const response = await fetch(`${API_BASE}/admin/create-chapter-with-images`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                const result = await response.json();
                
                if (result.success) {
                    showStatus(`Bölüm başarıyla oluşturuldu! (${result.imageCount} görsel)`, 'success');
                    e.target.reset();
                    document.getElementById('image-inputs').innerHTML = `
                        <div class="image-input-item">
                            <input type="url" placeholder="Sayfa 1 Google Drive linki" required>
                            <button type="button" class="btn btn-danger btn-small" onclick="removeImageInput(this)">Sil</button>
                        </div>
                    `;
                    document.getElementById('images-preview').style.display = 'none';
                } else {
                    // Detaylı hata mesajı göster
                    let errorMessage = result.error || 'Bölüm oluşturulamadı';
                    if (result.details && Array.isArray(result.details)) {
                        errorMessage += ':\n' + result.details.join('\n');
                    }
                    if (result.validIds && Array.isArray(result.validIds)) {
                        errorMessage += '\nGeçerli seri ID\'leri: ' + result.validIds.join(', ');
                    }
                    showStatus(errorMessage, 'error');
                }
            } catch (error) {
                showStatus('Bağlantı hatası', 'error');
                console.error('Chapter creation error:', error);
            }
            
            toggleLoading(false);
        });

        document.getElementById('validate-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const driveUrl = formData.get('driveUrl');
            
            toggleLoading(true);
            
            try {
                const response = await fetch(`${API_BASE}/admin/validate-drive-link`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${getAuthToken()}`
                    },
                    body: JSON.stringify({ driveUrl })
                });

                const result = await response.json();
                
                const resultDiv = document.getElementById('validation-details');
                resultDiv.innerHTML = `
                    <p><strong>Geçerli:</strong> ${result.isValid ? '✅ Evet' : '❌ Hayır'}</p>
                    <p><strong>Direct URL:</strong> <a href="${result.directUrl}" target="_blank">${result.directUrl}</a></p>
                    <p><strong>Thumbnail URL:</strong> <a href="${result.thumbnailUrl}" target="_blank">${result.thumbnailUrl}</a></p>
                    ${result.isValid ? `<img src="${result.directUrl}" class="preview-image" style="max-width: 300px; margin-top: 15px;">` : ''}
                `;
                
                document.getElementById('validation-result').style.display = 'block';
                
                showStatus(result.isValid ? 'Link geçerli!' : 'Link geçersiz!', result.isValid ? 'success' : 'error');
            } catch (error) {
                showStatus('Doğrulama hatası', 'error');
                console.error('Validation error:', error);
            }
            
            toggleLoading(false);
        });

        // Auto-generate series ID from title
        document.getElementById('series-title').addEventListener('input', (e) => {
            const title = e.target.value;
            const seriesId = title.toLowerCase()
                .replace(/[^a-z0-9\s]/g, '')
                .replace(/\s+/g, '');
            document.getElementById('series-id').value = seriesId;
        });

        // Bölüm Yönetimi Fonksiyonları
        async function loadSeriesList() {
            try {
                const response = await fetch(`${API_BASE}/admin/series-list`);
                const series = await response.json();
                
                const select = document.getElementById('manage-series');
                select.innerHTML = '<option value="">-- Seri Seçin --</option>';
                
                series.forEach(s => {
                    const option = document.createElement('option');
                    option.value = s.seriesId;
                    option.textContent = `${s.title} (${s.chapterCount} bölüm)`;
                    select.appendChild(option);
                });
                
            } catch (error) {
                showStatus('Seriler yüklenirken hata oluştu', 'error');
                console.error('Load series error:', error);
            }
        }

        // Yeni Bölüm Ekleme için serileri yükle
        async function loadChapterSeriesList() {
            try {
                const response = await fetch(`${API_BASE}/admin/series-list`);
                const series = await response.json();
                
                const select = document.getElementById('chapter-series');
                select.innerHTML = '<option value="">-- Seri Seçin --</option>';
                
                series.forEach(s => {
                    const option = document.createElement('option');
                    option.value = s.seriesId;
                    option.textContent = `${s.title} (${s.chapterCount} bölüm)`;
                    select.appendChild(option);
                });
                
            } catch (error) {
                showStatus('Seriler yüklenirken hata oluştu', 'error');
                console.error('Load chapter series error:', error);
            }
        }

        async function loadSeriesChapters(seriesId) {
            if (!seriesId) {
                document.getElementById('chapters-list-container').style.display = 'none';
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/admin/series/${seriesId}/chapters`);
                const data = await response.json();
                
                if (data.success) {
                    displayChaptersList(data.chapters, seriesId);
                    document.getElementById('chapters-list-container').style.display = 'block';
                } else {
                    showStatus('Bölümler yüklenirken hata oluştu', 'error');
                }
                
            } catch (error) {
                showStatus('Bölümler yüklenirken hata oluştu', 'error');
                console.error('Load chapters error:', error);
            }
        }

        function displayChaptersList(chapters, seriesId) {
            const container = document.getElementById('chapters-list');
            
            if (!chapters || chapters.length === 0) {
                container.innerHTML = '<p class="no-chapters">Bu seride henüz bölüm yok.</p>';
                return;
            }

            const chaptersHtml = chapters.map(chapter => `
                <div class="chapter-card">
                    <h4>Bölüm ${chapter.number}: ${chapter.title || 'Başlıksız'}</h4>
                    <div class="chapter-info">
                        📅 ${new Date(chapter.uploadDate).toLocaleDateString('tr-TR')}<br>
                        🖼️ ${chapter.imageCount} görsel<br>
                        📁 ${chapter.filename}
                    </div>
                    <div class="chapter-actions">
                        <button class="btn btn-small" onclick="editChapter('${seriesId}', ${chapter.number})">✏️ Düzenle</button>
                        <button class="btn btn-danger btn-small" onclick="confirmDeleteChapter('${seriesId}', ${chapter.number})">🗑️ Sil</button>
                    </div>
                </div>
            `).join('');

            container.innerHTML = `<div class="chapters-grid">${chaptersHtml}</div>`;
        }

        async function editChapter(seriesId, chapterNumber) {
            try {
                const response = await fetch(`${API_BASE}/admin/series/${seriesId}/chapters/${chapterNumber}`);
                const data = await response.json();
                
                if (data.success) {
                    showEditForm(data.chapter, seriesId);
                } else {
                    showStatus('Bölüm bilgileri alınamadı', 'error');
                }
                
            } catch (error) {
                showStatus('Bölüm bilgileri alınırken hata oluştu', 'error');
                console.error('Edit chapter error:', error);
            }
        }

        function showEditForm(chapter, seriesId) {
            document.getElementById('edit-series-id').value = seriesId;
            document.getElementById('edit-chapter-original-number').value = chapter.number;
            document.getElementById('edit-chapter-number').value = chapter.number;
            document.getElementById('edit-chapter-title').value = chapter.title || '';
            
            // Görsel URL'lerini yükle
            const imageContainer = document.getElementById('edit-image-inputs');
            imageContainer.innerHTML = '';
            
            if (chapter.imageUrls && chapter.imageUrls.length > 0) {
                chapter.imageUrls.forEach((url, index) => {
                    addEditImageInput(url);
                });
            } else {
                addEditImageInput();
            }
            
            document.getElementById('chapter-edit-form').style.display = 'block';
            document.getElementById('chapter-edit-form').scrollIntoView({ behavior: 'smooth' });
        }

        function addEditImageInput(url = '') {
            const container = document.getElementById('edit-image-inputs');
            const inputCount = container.children.length;
            
            const newInputDiv = document.createElement('div');
            newInputDiv.className = 'edit-image-input-item';
            newInputDiv.innerHTML = `
                <input type="url" placeholder="Sayfa ${inputCount + 1} Google Drive linki" value="${url}" oninput="updateImagePreview(this)">
                <button type="button" class="btn btn-danger btn-small" onclick="removeEditImageInput(this)">Sil</button>
                <img src="${url ? getPreviewUrl(url) : ''}" class="image-preview" style="max-width:60px; max-height:60px; vertical-align:middle; margin-left:8px; display:${url ? 'inline-block' : 'none'};" onclick="showImageModal(this.src)" title="Önizle">
            `;
            container.appendChild(newInputDiv);
        }

        function getPreviewUrl(url) {
            // Google Drive linkinden fileId çıkarıp thumbnail oluştur
            const fileId = extractFileId(url);
            if (fileId) {
                return `https://drive.google.com/thumbnail?id=${fileId}&sz=s400`;
            }
            return url;
        }

        function updateImagePreview(input) {
            const url = input.value;
            const img = input.parentElement.querySelector('.image-preview');
            if (url) {
                img.src = getPreviewUrl(url);
                img.style.display = 'inline-block';
            } else {
                img.src = '';
                img.style.display = 'none';
            }
        }

        function showImageModal(src) {
            // Basit modal: yeni sekmede aç
            window.open(src, '_blank');
        }

        function cancelEdit() {
            document.getElementById('chapter-edit-form').style.display = 'none';
        }

        async function confirmDeleteChapter(seriesId, chapterNumber) {
            if (confirm(`Bölüm ${chapterNumber}'ü silmek istediğinizden emin misiniz? Bu işlem geri alınamaz.`)) {
                await deleteChapterConfirmed(seriesId, chapterNumber);
            }
        }

        async function deleteChapterConfirmed(seriesId, chapterNumber) {
            toggleLoading(true);
            
            try {
                const response = await fetch(`${API_BASE}/moderator/delete-chapter/${seriesId}/${chapterNumber}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }
                
                const result = await response.json();
                
                if (result.success) {
                    showStatus('Bölüm başarıyla silindi!', 'success');
                    loadSeriesChapters(seriesId); // Listeyi yenile
                } else {
                    showStatus(result.error || 'Bölüm silinemedi', 'error');
                }
                
            } catch (error) {
                showStatus('Bölüm silinirken hata oluştu', 'error');
                console.error('Delete chapter error:', error);
            }
            
            toggleLoading(false);
        }

        async function deleteChapter() {
            const seriesId = document.getElementById('edit-series-id').value;
            const chapterNumber = document.getElementById('edit-chapter-original-number').value;
            await confirmDeleteChapter(seriesId, chapterNumber);
        }

        // Edit Chapter Form Submit
        document.getElementById('edit-chapter-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const imageInputs = document.querySelectorAll('#edit-image-inputs input');
            const imageUrls = Array.from(imageInputs).map(input => input.value).filter(url => url);
            
            if (imageUrls.length === 0) {
                showStatus('Lütfen en az bir görsel linki girin', 'error');
                return;
            }
            
            const data = {
                seriesId: document.getElementById('edit-series-id').value,
                originalChapterNumber: document.getElementById('edit-chapter-original-number').value,
                newChapterNumber: document.getElementById('edit-chapter-number').value,
                title: document.getElementById('edit-chapter-title').value,
                imageUrls: imageUrls
            };
            
            toggleLoading(true);
            
            try {
                const response = await fetch(`${API_BASE}/admin/update-chapter`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                const result = await response.json();
                
                if (result.success) {
                    showStatus('Bölüm başarıyla güncellendi!', 'success');
                    cancelEdit();
                    loadSeriesChapters(data.seriesId); // Listeyi yenile
                } else {
                    showStatus(result.error || 'Bölüm güncellenemedi', 'error');
                }
            } catch (error) {
                showStatus('Bağlantı hatası', 'error');
                console.error('Update chapter error:', error);
            }
            
            toggleLoading(false);
        });

        // Seri Silme Fonksiyonları
        document.getElementById('confirm-delete').addEventListener('input', function() {
            const deleteBtn = document.getElementById('delete-btn');
            deleteBtn.disabled = this.value !== 'SİL';
        });

        async function deleteSeries() {
            const seriesId = document.getElementById('delete-series').value;
            const confirmText = document.getElementById('confirm-delete').value.toUpperCase();
            if (!seriesId) {
                showStatus('Lütfen silinecek seriyi seçin', 'error');
                return;
            }
            if (confirmText !== 'SİL') {
                showStatus('Silme işlemini onaylamak için "SİL" yazın', 'error');
                return;
            }
            const seriesTitle = document.getElementById('delete-series').selectedOptions[0].textContent;
            if (!confirm(`"${seriesTitle}" serisini silmek istediğinizden emin misiniz? Bu işlem geri alınamaz!`)) {
                return;
            }
            toggleLoading(true);
            document.getElementById('delete-result').style.display = 'none';
            try {
                // Eğer backend auth isterse token ekleyin:
                // const token = getAuthToken();
                const response = await fetch(`${API_BASE}/admin/delete-series/${seriesId}`, {
                    method: 'DELETE',
                    // headers: { 'Authorization': `Bearer ${token}` }
                });
                let result;
                try {
                    result = await response.json();
                } catch (jsonErr) {
                    showStatus('Sunucudan geçersiz yanıt alındı', 'error');
                    toggleLoading(false);
                    return;
                }
                if (result && result.success) {
                    showStatus(`"${result.deletedSeries.title}" serisi başarıyla silindi!`, 'success');
                    document.getElementById('delete-series').value = '';
                    document.getElementById('confirm-delete').value = '';
                    document.getElementById('delete-btn').disabled = true;
                    document.getElementById('delete-btn').style.opacity = '0.5';
                    const resultDiv = document.getElementById('delete-result');
                    const detailsDiv = document.getElementById('delete-details');
                    detailsDiv.innerHTML = `
                        <div style="color: green;">
                            <strong>✅ Başarıyla silindi:</strong><br>
                            📚 Seri: ${result.deletedSeries.title}<br>
                            🔗 ID: ${result.deletedSeries.seriesId}<br>
                            📁 Klasörler ve dosyalar temizlendi<br>
                            🗄️ Veritabanı kayıtları silindi
                        </div>
                    `;
                    resultDiv.style.display = 'block';
                    loadDeleteSeriesList();
                } else {
                    showStatus(result && result.error ? result.error : 'Seri silinemedi', 'error');
                }
            } catch (error) {
                showStatus(`Seri silinirken hata oluştu: ${error.message}`, 'error');
            }
            toggleLoading(false);
        }

        // Delete tab için serileri yükle
        async function loadDeleteSeriesList() {
            try {
                console.log('Loading series list...');
                const response = await fetch('data/manhwalar.json');
                console.log('Response status:', response.status);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const seriesList = await response.json();
                console.log('Series loaded:', seriesList.length);
                
                const selectElement = document.getElementById('delete-series');
                selectElement.innerHTML = '<option value="">-- Seri Seçin --</option>';
                
                seriesList.forEach(series => {
                    const option = document.createElement('option');
                    option.value = series.seriesId;
                    option.textContent = `${series.title} (${series.seriesId})`;
                    selectElement.appendChild(option);
                });
                
                console.log('Series list loaded successfully');
            } catch (error) {
                console.error('Error loading series list:', error);
                showStatus(`Seri listesi yüklenirken hata oluştu: ${error.message}`, 'error');
            }
        }

        // Silme onayı kontrolü
        document.getElementById('confirm-delete').addEventListener('input', function() {
            const confirmText = this.value.toUpperCase();
            const deleteBtn = document.getElementById('delete-btn');
            const seriesSelected = document.getElementById('delete-series').value;
            
            if (confirmText === 'SİL' && seriesSelected) {
                deleteBtn.disabled = false;
                deleteBtn.style.opacity = '1';
            } else {
                deleteBtn.disabled = true;
                deleteBtn.style.opacity = '0.5';
            }
        });

        // Seri Düzenleme Fonksiyonları
        
        // Edit sekmesi için seri listesini yükle
        async function loadEditSeriesList() {
            try {
                const response = await fetch('https://toonnekoauth-api.onrender.com/client/data/manhwalar.json');
                const series = await response.json();
                
                const select = document.getElementById('edit-series-select');
                select.innerHTML = '<option value="">-- Seri Seçin --</option>';
                
                series.forEach(serie => {
                    const option = document.createElement('option');
                    option.value = serie.seriesId;
                    option.textContent = serie.title;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Seri listesi yüklenirken hata:', error);
                showStatus('Seri listesi yüklenemedi', 'error');
            }
        }

        // Etiket ayarları görünürlük kontrolü
        function toggleLabelSettings() {
            const labelValue = document.getElementById('edit-series-label-enabled').value;
            const labelSettings = document.getElementById('label-settings');
            
            // Sadece "true" (Etiketi Göster) durumunda ayarları göster
            labelSettings.style.display = labelValue === 'true' ? 'block' : 'none';
            updateLabelPreview();
        }

        // Etiket önizleme güncelleme
        function updateLabelPreview() {
            const labelValue = document.getElementById('edit-series-label-enabled').value;
            const text = document.getElementById('edit-series-label-text').value;
            const color = document.getElementById('edit-series-label-color').value;
            const preview = document.getElementById('label-preview-badge');
            
            if (labelValue === 'true') {
                // Etiketi göster
                preview.textContent = text;
                preview.style.background = color;
                preview.style.display = 'inline-block';
            } else if (labelValue === 'false') {
                // Etiket var ama gizli (önizlemede göster ama soluk)
                preview.textContent = text + ' (Gizli)';
                preview.style.background = color;
                preview.style.opacity = '0.5';
                preview.style.display = 'inline-block';
            } else {
                // Etiket yok
                preview.style.display = 'none';
                preview.style.opacity = '1';
            }
        }

        // Seçilen seriyi düzenleme formuna yükle
        async function loadSeriesForEdit() {
            const seriesId = document.getElementById('edit-series-select').value;
            const formContainer = document.getElementById('edit-series-form-container');
            
            if (!seriesId) {
                formContainer.style.display = 'none';
                return;
            }

            try {
                const response = await fetch('https://toonnekoauth-api.onrender.com/client/data/manhwalar.json');
                const series = await response.json();
                const selectedSeries = series.find(s => s.seriesId === seriesId);

                if (!selectedSeries) {
                    showStatus('Seri bulunamadı', 'error');
                    return;
                }

                // Form alanlarını doldur
                document.getElementById('edit-series-title').value = selectedSeries.title || '';
                document.getElementById('edit-series-status').value = selectedSeries.status || 'Devam Ediyor';
                document.getElementById('edit-series-summary').value = selectedSeries.summary || '';
                document.getElementById('edit-series-cover').value = selectedSeries.image || '';
                document.getElementById('edit-series-author').value = selectedSeries.author || '';
                document.getElementById('edit-series-artist').value = selectedSeries.artist || '';
                document.getElementById('edit-series-publisher').value = selectedSeries.publisher || '';
                
                // Genres array'ini virgülle ayrılmış string'e çevir
                const genresString = selectedSeries.genres ? selectedSeries.genres.join(', ') : '';
                document.getElementById('edit-series-genres').value = genresString;

                // Etiket bilgilerini yükle
                const label = selectedSeries.label;
                let labelStatus = 'none'; // Varsayılan: Etiket yok
                
                if (label) {
                    if (label.enabled === true) {
                        labelStatus = 'true'; // Etiketi göster
                    } else if (label.enabled === false) {
                        labelStatus = 'false'; // Etiketi gizle
                    }
                    // Etiket var ise text ve color'ı yükle
                    document.getElementById('edit-series-label-text').value = label.text || 'Yeni';
                    document.getElementById('edit-series-label-color').value = label.color || '#4CAF50';
                } else {
                    // Etiket yok ise varsayılan değerler
                    document.getElementById('edit-series-label-text').value = 'Yeni';
                    document.getElementById('edit-series-label-color').value = '#4CAF50';
                }
                
                document.getElementById('edit-series-label-enabled').value = labelStatus;
                toggleLabelSettings();

                // Kapak önizlemesini göster
                if (selectedSeries.image) {
                    document.getElementById('edit-preview-image').src = selectedSeries.image;
                    document.getElementById('edit-cover-preview').style.display = 'block';
                }

                formContainer.style.display = 'block';
            } catch (error) {
                console.error('Seri yüklenirken hata:', error);
                showStatus('Seri bilgileri yüklenemedi', 'error');
            }
        }

        // Kapak görselini doğrula (düzenleme formu için)
        function validateEditCoverImage() {
            const url = document.getElementById('edit-series-cover').value;
            const previewContainer = document.getElementById('edit-cover-preview');
            const previewImage = document.getElementById('edit-preview-image');

            if (!url) {
                showStatus('Lütfen bir görsel URL\'si girin', 'error');
                previewContainer.style.display = 'none';
                return;
            }

            // Google Drive linkini proxy URL'ye dönüştür
            let imageUrl = url;
            const driveMatch = url.match(/\/file\/d\/([a-zA-Z0-9_-]+)/);
            if (driveMatch) {
                const fileId = driveMatch[1];
                imageUrl = `https://toonnekoauth-api.onrender.com/image/proxy-image/${fileId}`;
            }

            // Loading göster
            previewImage.src = '';
            previewContainer.style.display = 'block';
            previewImage.style.display = 'none';
            
            // Temporary loading message
            const loadingMsg = document.createElement('div');
            loadingMsg.innerHTML = '🔄 Görsel yükleniyor...';
            loadingMsg.style.padding = '20px';
            loadingMsg.style.textAlign = 'center';
            loadingMsg.id = 'temp-loading';
            previewContainer.appendChild(loadingMsg);

            previewImage.onload = function() {
                const tempLoading = document.getElementById('temp-loading');
                if (tempLoading) tempLoading.remove();
                
                previewImage.style.display = 'block';
                showStatus('Görsel başarıyla yüklendi', 'success');
            };
            
            previewImage.onerror = function() {
                const tempLoading = document.getElementById('temp-loading');
                if (tempLoading) tempLoading.remove();
                
                previewContainer.style.display = 'none';
                showStatus('Görsel yüklenemedi. URL\'yi kontrol edin', 'error');
            };
            
            previewImage.src = imageUrl;
        }

        // Düzenleme formunu temizle ve gizle
        function cancelEdit() {
            document.getElementById('edit-series-select').value = '';
            document.getElementById('edit-series-form-container').style.display = 'none';
            document.getElementById('edit-cover-preview').style.display = 'none';
            document.getElementById('edit-series-form').reset();
        }

        // Seri düzenleme form submit
        document.getElementById('edit-series-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const seriesId = document.getElementById('edit-series-select').value;
            if (!seriesId) {
                showStatus('Lütfen bir seri seçin', 'error');
                return;
            }

            // Loading göster
            showLoading(true);
            
            // Status mesajını temizle
            const statusDiv = document.getElementById('status-message');
            statusDiv.style.display = 'none';

            try {
                // Form verilerini manuel olarak topla
                const editData = {
                    seriesId: seriesId,
                    title: document.getElementById('edit-series-title').value,
                    status: document.getElementById('edit-series-status').value,
                    summary: document.getElementById('edit-series-summary').value,
                    image: document.getElementById('edit-series-cover').value,
                    author: document.getElementById('edit-series-author').value,
                    artist: document.getElementById('edit-series-artist').value,
                    publisher: document.getElementById('edit-series-publisher').value,
                    genres: document.getElementById('edit-series-genres').value.split(',').map(g => g.trim()).filter(g => g)
                };

                // Etiket işleme
                const labelValue = document.getElementById('edit-series-label-enabled').value;
                if (labelValue === 'none') {
                    // Etiket tamamen kaldır
                    editData.removeLabel = true;
                } else {
                    // Etiket ekle/güncelle
                    editData.label = {
                        enabled: labelValue === 'true',
                        text: document.getElementById('edit-series-label-text').value,
                        color: document.getElementById('edit-series-label-color').value
                    };
                }

                // Zorunlu alanları kontrol et
                if (!editData.title || !editData.status || !editData.image) {
                    showLoading(false);
                    showStatus('Lütfen tüm zorunlu alanları doldurun (Başlık, Durum, Kapak Görseli)', 'error');
                    return;
                }

                // Google Drive linkini proxy URL'ye dönüştür
                const driveMatch = editData.image.match(/\/file\/d\/([a-zA-Z0-9_-]+)/);
                if (driveMatch) {
                    const fileId = driveMatch[1];
                    editData.image = `https://toonnekoauth-api.onrender.com/api/image/proxy-image/${fileId}`;
                }

                console.log('Gönderilen veri:', editData); // Debug için

                const response = await fetch('https://toonnekoauth-api.onrender.com/api/manhwa/edit', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(editData)
                });

                const result = await response.json();
                console.log('Sunucu yanıtı:', result); // Debug için

                if (response.ok) {
                    showStatus('Seri başarıyla güncellendi!', 'success');
                    // Edit sekmesindeki seri listesini yenile
                    loadEditSeriesList();
                    // Seçili seriyi yeniden yükle
                    loadSeriesForEdit();
                } else {
                    showStatus(result.error || 'Seri güncellenirken hata oluştu', 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showStatus('Beklenmeyen bir hata oluştu: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        });

        // Görsel URL alanında değişiklik olduğunda otomatik önizleme
        document.getElementById('edit-series-cover').addEventListener('input', function() {
            // 1 saniye bekle sonra otomatik doğrula
            clearTimeout(this.previewTimeout);
            this.previewTimeout = setTimeout(() => {
                if (this.value.trim()) {
                    validateEditCoverImage();
                }
            }, 1000);
        });

        // Seri seçimi değiştiğinde onay kontrolü
        document.getElementById('delete-series').addEventListener('change', function() {
            const confirmText = document.getElementById('confirm-delete').value.toUpperCase();
            const deleteBtn = document.getElementById('delete-btn');
            
            if (confirmText === 'SİL' && this.value) {
                deleteBtn.disabled = false;
                deleteBtn.style.opacity = '1';
            } else {
                deleteBtn.disabled = true;
                deleteBtn.style.opacity = '0.5';
            }
        });

        // ===== KULLANICI YÖNETİMİ FONKSİYONLARI =====
        
        let allUsers = [];

        // Kullanıcıları yükle
        async function loadUsers() {
            try {
                console.log('Kullanıcıları yüklemeye çalışıyor...');

                // Test endpoint kullan (geçici çözüm)
                const response = await fetch('https://toonnekoauth-api.onrender.com/api/admin/test-users', {
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                console.log('Response status:', response.status);
                console.log('Response ok:', response.ok);

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Server error response:', errorText);
                    throw new Error(`Server error ${response.status}: ${errorText}`);
                }

                const data = await response.json();
                console.log('Response data:', JSON.stringify(data, null, 2));
                
                // API direkt kullanıcı array'i döndürüyor
                if (Array.isArray(data)) {
                    allUsers = data;
                    renderUsers(allUsers);
                    updateUserStats(allUsers);
                } else if (data.success) {
                    allUsers = data.users;
                    renderUsers(allUsers);
                    updateUserStats(allUsers);
                } else {
                    throw new Error(data.error || data.details || 'Kullanıcılar yüklenemedi');
                }
            } catch (error) {
                console.error('Kullanıcıları yükleme hatası:', error);
                document.getElementById('users-loading').innerHTML = `
                    <div style="color: #dc3545; font-size: 16px;">
                        ❌ Kullanıcılar yüklenemedi: ${error.message}
                        <br><small>Detaylar için tarayıcı console'unu kontrol edin.</small>
                    </div>
                `;
            }
        }

        // Kullanıcı istatistiklerini güncelle
        function updateUserStats(users) {
            const totalUsers = users.length;
            const adminUsers = users.filter(u => u.isAdmin).length;
            const moderatorUsers = users.filter(u => u.isModerator).length;
            const blockedUsers = users.filter(u => u.isBlocked).length;

            document.getElementById('total-users-count').textContent = totalUsers;
            document.getElementById('admin-users-count').textContent = adminUsers;
            document.getElementById('moderator-users-count').textContent = moderatorUsers;
            document.getElementById('blocked-users-count').textContent = blockedUsers;
        }

        // Kullanıcıları render et
        function renderUsers(users) {
            const container = document.getElementById('users-list');
            const loadingDiv = document.getElementById('users-loading');
            
            loadingDiv.style.display = 'none';
            container.style.display = 'block';

            if (users.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: #666; padding: 40px;">Kullanıcı bulunamadı</div>';
                return;
            }

            const usersHTML = users.map(user => {
                const statusBadges = [];
                if (user.isAdmin) statusBadges.push('<span style="background: #28a745; color: white; padding: 4px 8px; border-radius: 12px; font-size: 12px; margin-left: 8px;">Admin</span>');
                if (user.isModerator) statusBadges.push('<span style="background: #ffc107; color: black; padding: 4px 8px; border-radius: 12px; font-size: 12px; margin-left: 8px;">Moderatör</span>');
                if (user.isBlocked) statusBadges.push('<span style="background: #dc3545; color: white; padding: 4px 8px; border-radius: 12px; font-size: 12px; margin-left: 8px;">Engelli</span>');
                
                return `
                    <div class="user-card" style="background: #f8f9fa; border-radius: 10px; padding: 20px; margin-bottom: 15px; border-left: 4px solid ${user.isAdmin ? '#28a745' : user.isModerator ? '#ffc107' : user.isBlocked ? '#dc3545' : '#667eea'};">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <h4 style="margin-bottom: 8px;">
                                    👤 ${user.username}
                                    ${statusBadges.join('')}
                                </h4>
                                <p style="color: #666; margin-bottom: 8px;">📧 ${user.email}</p>
                                <div style="font-size: 14px; color: #888;">
                                    <span>📅 Kayıt: ${new Date(user.createdAt).toLocaleDateString('tr-TR')}</span>
                                    <span style="margin-left: 20px;">⭐ ${user.ratings ? user.ratings.length : 0} puan</span>
                                    <span style="margin-left: 20px;">❤️ ${user.favorites ? user.favorites.length : 0} favori</span>
                                    <span style="margin-left: 20px;">📖 ${user.readSeries ? user.readSeries.length : 0} okunan</span>
                                    ${user.isModerator ? `<span style="margin-left: 20px;">🛡️ ${user.moderatorSeries ? user.moderatorSeries.length : 0} seri</span>` : ''}
                                </div>
                            </div>
                            <div style="display: flex; gap: 10px;">
                                <button onclick="viewUserDetails('${user._id}')" style="background: #17a2b8; color: white; border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer;">👁️ Detay</button>
                                <button onclick="toggleUserAdmin('${user._id}', ${!user.isAdmin})" 
                                        style="background: ${user.isAdmin ? '#6c757d' : '#28a745'}; color: white; border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer;">
                                    ${user.isAdmin ? '👤 Admin Al' : '⭐ Admin Yap'}
                                </button>
                                <button onclick="toggleUserBlock('${user._id}', ${!user.isBlocked})" 
                                        style="background: ${user.isBlocked ? '#28a745' : '#ffc107'}; color: ${user.isBlocked ? 'white' : 'black'}; border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer;">
                                    ${user.isBlocked ? '✅ Engel Kaldır' : '🚫 Engelle'}
                                </button>
                                <button onclick="deleteUser('${user._id}', '${user.username}')" style="background: #dc3545; color: white; border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer;">🗑️ Sil</button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = usersHTML;
        }

        // Kullanıcı arama
        function filterUsers() {
            const searchTerm = document.getElementById('user-search').value.toLowerCase();
            const filteredUsers = allUsers.filter(user => 
                user.username.toLowerCase().includes(searchTerm) || 
                user.email.toLowerCase().includes(searchTerm)
            );
            renderUsers(filteredUsers);
        }

        // Admin yetkisi değiştir - GEÇİCİ MOCK
        async function toggleUserAdmin(userId, makeAdmin) {
            if (!confirm(`Bu kullanıcıyı ${makeAdmin ? 'admin yapmak' : 'admin yetkisini almak'} istediğinizden emin misiniz?`)) {
                return;
            }

            try {
                // GEÇİCİ: Mock response döndür
                console.log(`🔧 Mock işlem: Kullanıcı ${userId} ${makeAdmin ? 'admin yapıldı' : 'admin yetkisi kaldırıldı'}`);
                alert(`Kullanıcı ${makeAdmin ? 'admin yapıldı' : 'admin yetkisi kaldırıldı'} (Mock işlem)`);
                await loadUsers(); // Listeyi yenile
            } catch (error) {
                console.error('Mock admin işlemi hatası:', error);
                alert('Hata: ' + error.message);
            }
        }

        // Kullanıcı engelleme - GEÇİCİ MOCK
        async function toggleUserBlock(userId, blockUser) {
            if (!confirm(`Bu kullanıcıyı ${blockUser ? 'engellemek' : 'engel kaldırmak'} istediğinizden emin misiniz?`)) {
                return;
            }

            try {
                // GEÇİCİ: Mock response döndür
                console.log(`🔧 Mock işlem: Kullanıcı ${userId} ${blockUser ? 'engellendi' : 'engeli kaldırıldı'}`);
                alert(`Kullanıcı ${blockUser ? 'engellendi' : 'engeli kaldırıldı'} (Mock işlem)`);
                await loadUsers(); // Listeyi yenile
            } catch (error) {
                console.error('Mock block işlemi hatası:', error);
                alert('Hata: ' + error.message);
            }
        }

        // Kullanıcı silme - GEÇİCİ MOCK
        async function deleteUser(userId, username) {
            if (!confirm(`"${username}" kullanıcısını kalıcı olarak silmek istediğinizden emin misiniz?\n\nBu işlem geri alınamaz!`)) {
                return;
            }

            try {
                // GEÇİCİ: Mock response döndür
                console.log(`🔧 Mock işlem: Kullanıcı ${username} (${userId}) silindi`);
                alert(`Kullanıcı "${username}" silindi (Mock işlem)`);
                await loadUsers(); // Listeyi yenile
                await loadUsers(); // Listeyi yenile
            } catch (error) {
                console.error('Mock silme işlemi hatası:', error);
                alert('Hata: ' + error.message);
            }
        }

        // Kullanıcı detaylarını görüntüle
        async function viewUserDetails(userId) {
            try {
                // allUsers array'inden kullanıcıyı bul
                const user = allUsers.find(u => u._id === userId);
                
                if (!user) {
                    throw new Error('Kullanıcı bulunamadı');
                }
                
                const modalContent = document.getElementById('user-detail-content');
                    
                    modalContent.innerHTML = `
                        <div style="margin-bottom: 20px;">
                            <h4>👤 ${user.username}</h4>
                            <p><strong>📧 E-posta:</strong> ${user.email}</p>
                            <p><strong>📅 Kayıt Tarihi:</strong> ${new Date(user.createdAt).toLocaleString('tr-TR')}</p>
                            <p><strong>🔄 Son Güncelleme:</strong> ${new Date(user.updatedAt).toLocaleString('tr-TR')}</p>
                            <p><strong>🕐 Son Giriş:</strong> ${user.lastLoginAt ? new Date(user.lastLoginAt).toLocaleString('tr-TR') : 'Bilinmiyor'}</p>
                            <p><strong>⭐ Admin:</strong> ${user.isAdmin ? '✅ Evet' : '❌ Hayır'}</p>
                            <p><strong>�️ Moderatör:</strong> ${user.isModerator ? '✅ Evet' : '❌ Hayır'}</p>
                            ${user.isModerator && user.moderatorSeries ? `<p><strong>📚 Atanmış Seriler:</strong> ${user.moderatorSeries.length} seri</p>` : ''}
                            <p><strong>�🚫 Engelli:</strong> ${user.isBlocked ? '✅ Evet' : '❌ Hayır'}</p>
                        </div>
                        
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                            <h5>📊 Kullanıcı Aktivitesi</h5>
                            <p><strong>⭐ Verilen Puanlar:</strong> ${user.ratings ? user.ratings.length : 0}</p>
                            <p><strong>❤️ Favoriler:</strong> ${user.favorites ? user.favorites.length : 0}</p>
                            <p><strong>📖 Okunan Seriler:</strong> ${user.readSeries ? user.readSeries.length : 0}</p>
                            <p><strong>📈 Okuma İlerlemesi:</strong> ${user.readingProgress ? user.readingProgress.length : 0} seri</p>
                        </div>
                        
                        ${user.favorites && user.favorites.length > 0 ? `
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                                <h5>❤️ Favori Seriler</h5>
                                <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px;">
                                    ${user.favorites.map(fav => `<span style="background: #667eea; color: white; padding: 4px 8px; border-radius: 12px; font-size: 12px;">${fav}</span>`).join('')}
                                </div>
                            </div>
                        ` : ''}
                    `;
                    
                    // Moderatör yönetimi bölümünü göster (admin olmayan kullanıcılar için)
                    const moderatorSection = document.getElementById('moderator-assignment-section');
                    if (!user.isAdmin) {
                        moderatorSection.style.display = 'block';
                        // Önce serileri yükle, sonra moderatör atamasını ayarla
                        await loadSeriesForUserModeratorAssignment();
                        setupModeratorAssignment(user);
                    } else {
                        moderatorSection.style.display = 'none';
                    }
                    
                    document.getElementById('user-detail-modal').style.display = 'block';
            } catch (error) {
                alert('Kullanıcı detayları yüklenemedi: ' + error.message);
            }
        }

        // Modal kapatma
        function closeUserModal() {
            document.getElementById('user-detail-modal').style.display = 'none';
        }

        // Tab değiştiğinde kullanıcıları yükle
        const originalSwitchTab = switchTab;
        switchTab = function(tabName) {
            originalSwitchTab(tabName);
            if (tabName === 'users') {
                loadUsers();
                loadSeriesForUserModeratorAssignment();
            }
            if (tabName === 'moderators') {
                loadModerators();
                loadSeriesForModeratorAssignment();
            }
        };

        // Sayfa yüklendiğinde giriş kontrolü
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Admin panel loading...');
            
            // URL parametresi ile localStorage temizleme
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('clear') === 'true') {
                localStorage.clear();
                console.log('localStorage cleared');
            }
            
            // Debug: localStorage durumunu kontrol et
            const currentToken = localStorage.getItem('token');
            console.log('Current token:', currentToken);
            
            // Eğer token yoksa veya geçersizse giriş formu göster
            if (!currentToken) {
                console.log('No token found, showing login form');
                document.querySelector('.admin-container').style.display = 'none';
                showLoginForm();
            } else {
                console.log('Token found, verifying...');
                // Token'ı verify et
                verifyToken(currentToken);
            }

            // Etiket ayarları event listener'ları
            const labelTextSelect = document.getElementById('edit-series-label-text');
            const labelColorSelect = document.getElementById('edit-series-label-color');
            
            if (labelTextSelect) {
                labelTextSelect.addEventListener('change', updateLabelPreview);
            }
            if (labelColorSelect) {
                labelColorSelect.addEventListener('change', updateLabelPreview);
            }
        });
        
        // Token doğrulama fonksiyonu
        async function verifyToken(token) {
            try {
                const response = await fetch('https://toonnekoauth-api.onrender.com/api/admin/test-users', {
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    console.log('Token valid, showing admin panel');
                    document.querySelector('.admin-container').style.display = 'block';
                } else {
                    console.log('Token invalid, clearing and showing login');
                    localStorage.removeItem('token');
                    document.querySelector('.admin-container').style.display = 'none';
                    showLoginForm();
                }
            } catch (error) {
                console.log('Token verification failed:', error);
                localStorage.removeItem('token');
                document.querySelector('.admin-container').style.display = 'none';
                showLoginForm();
            }
        }

        // Yorum Yönetimi Fonksiyonları
        let currentReportsPage = 1;
        let currentCommentsPage = 1;

        // Rapor istatistiklerini yükle
        async function loadReportsStats() {
            try {
                const response = await fetch(`${API_BASE}/reports/admin/stats`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                
                if (response.ok) {
                    const stats = await response.json();
                    document.getElementById('pending-reports').textContent = stats.pendingReports;
                    document.getElementById('total-reports').textContent = stats.totalReports;
                    document.getElementById('reported-comments').textContent = stats.reportedComments;
                }
            } catch (error) {
                console.error('Stats yüklenirken hata:', error);
            }
        }

        // Raporları yükle
        async function loadReports(page = 1) {
            try {
                const status = document.getElementById('report-status-filter').value;
                const seriesId = document.getElementById('series-filter').value;
                
                const params = new URLSearchParams({
                    page,
                    status,
                    limit: 10
                });
                
                if (seriesId) params.append('seriesId', seriesId);
                
                const response = await fetch(`${API_BASE}/reports/admin/reports?${params}`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    renderReports(data.reports);
                    renderReportsPagination(data.page, data.totalPages);
                    currentReportsPage = data.page;
                }
            } catch (error) {
                console.error('Raporlar yüklenirken hata:', error);
            }
        }

        // Raporları render et
        function renderReports(reports) {
            const listDiv = document.getElementById('reports-list');
            
            if (reports.length === 0) {
                listDiv.innerHTML = '<p style="text-align: center; color: #666;">Rapor bulunamadı.</p>';
                return;
            }

            listDiv.innerHTML = reports.map(report => `
                <div class="report-item" style="border: 1px solid #ddd; border-radius: 8px; padding: 20px; margin-bottom: 15px; background: white;">
                    <div style="display: flex; justify-content: between; align-items: start; margin-bottom: 15px;">
                        <div style="flex: 1;">
                            <h4 style="margin: 0 0 8px 0; color: #333;">
                                ${report.seriesTitle} - ${report.replyId ? 'Yanıt' : 'Yorum'}
                                <span class="report-status status-${report.status}" style="
                                    padding: 4px 8px; 
                                    border-radius: 4px; 
                                    font-size: 0.8rem; 
                                    margin-left: 10px;
                                    background: ${getStatusColor(report.status)};
                                    color: white;
                                ">${getStatusText(report.status)}</span>
                            </h4>
                            <p style="margin: 5px 0; color: #666; font-size: 0.9rem;">
                                <strong>Rapor Eden:</strong> ${report.reportedBy} | 
                                <strong>Neden:</strong> ${getReasonText(report.reason)} | 
                                <strong>Tarih:</strong> ${new Date(report.reportDate).toLocaleString('tr-TR')}
                            </p>
                            ${report.description ? `<p style="margin: 5px 0; color: #666;"><strong>Açıklama:</strong> ${report.description}</p>` : ''}
                        </div>
                    </div>
                    
                    ${report.commentId ? `
                        <div style="background: #f9f9f9; padding: 15px; border-radius: 6px; margin: 15px 0;">
                            <p style="margin: 0; font-size: 0.9rem;"><strong>Yorum İçeriği:</strong></p>
                            <p style="margin: 5px 0 0 0; font-style: italic;">${report.commentId.text || 'Yorum içeriği yüklenemedi'}</p>
                            <p style="margin: 5px 0 0 0; font-size: 0.8rem; color: #666;">
                                <strong>Yazan:</strong> ${report.commentId.author || 'Bilinmiyor'}
                            </p>
                        </div>
                    ` : ''}
                    
                    <div style="display: flex; gap: 10px; margin-top: 15px;">
                        ${report.status === 'pending' ? `
                            <button onclick="updateReportStatus('${report._id}', 'reviewed', 'none')" 
                                style="background: #4CAF50; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer;">
                                ✅ İncelendi
                            </button>
                            <button onclick="deleteCommentFromReport('${report.commentId._id}', '${report.replyId || ''}', '${report._id}')" 
                                style="background: #f44336; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer;">
                                🗑️ Yorumu Sil
                            </button>
                            <button onclick="updateReportStatus('${report._id}', 'dismissed', 'none')" 
                                style="background: #9E9E9E; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer;">
                                ❌ Reddet
                            </button>
                        ` : `
                            <span style="color: #666; font-size: 0.9rem;">
                                ${report.reviewedBy ? `${report.reviewedBy} tarafından ${new Date(report.reviewedAt).toLocaleString('tr-TR')} tarihinde işlendi` : 'İşlendi'}
                            </span>
                        `}
                    </div>
                </div>
            `).join('');
        }

        // Rapor durumunu güncelle
        async function updateReportStatus(reportId, status, action) {
            try {
                const response = await fetch(`${API_BASE}/reports/admin/reports/${reportId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify({ status, action })
                });
                
                if (response.ok) {
                    showStatus('Rapor durumu güncellendi', 'success');
                    loadReports(currentReportsPage);
                    loadReportsStats();
                } else {
                    showStatus('Rapor güncellenirken hata oluştu', 'error');
                }
            } catch (error) {
                console.error('Rapor güncelleme hatası:', error);
                showStatus('Rapor güncellenirken hata oluştu', 'error');
            }
        }

        // Yorumu rapordan sil
        async function deleteCommentFromReport(commentId, replyId, reportId) {
            if (!confirm('Bu yorumu/yanıtı silmek istediğinizden emin misiniz?')) return;
            
            try {
                const url = `${API_BASE}/reports/admin/comment/${commentId}${replyId ? `?replyId=${replyId}` : ''}`;
                const response = await fetch(url, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                
                if (response.ok) {
                    // Raporu da çözümlendi olarak işaretle
                    await updateReportStatus(reportId, 'resolved', 'comment_deleted');
                    showStatus('Yorum silindi ve rapor çözümlendi', 'success');
                } else {
                    showStatus('Yorum silinirken hata oluştu', 'error');
                }
            } catch (error) {
                console.error('Yorum silme hatası:', error);
                showStatus('Yorum silinirken hata oluştu', 'error');
            }
        }

        // Yorum yönetimi için seri listesini yükle
        async function loadCommentsSeriesList() {
            try {
                const response = await fetch(`${API_BASE}/admin/series-list`);
                const series = await response.json();
                
                const seriesFilter = document.getElementById('series-filter');
                const commentSeriesSelect = document.getElementById('comment-series-select');
                
                // Filtre için
                seriesFilter.innerHTML = '<option value="">Tüm Seriler</option>';
                series.forEach(s => {
                    const option = document.createElement('option');
                    option.value = s.seriesId;
                    option.textContent = `${s.title} (${s.chapterCount} bölüm)`;
                    seriesFilter.appendChild(option);
                });
                
                // Yorum yönetimi için
                commentSeriesSelect.innerHTML = '<option value="">-- Seri Seçin --</option>';
                series.forEach(s => {
                    const option = document.createElement('option');
                    option.value = s.seriesId;
                    option.textContent = `${s.title} (${s.chapterCount} bölüm)`;
                    commentSeriesSelect.appendChild(option);
                });
                
            } catch (error) {
                console.error('Seri listesi yüklenirken hata:', error);
            }
        }

        // Seri bazında yorumları yükle
        async function loadSeriesComments(page = 1) {
            const seriesId = document.getElementById('comment-series-select').value;
            if (!seriesId) {
                document.getElementById('series-comments').style.display = 'none';
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/reports/admin/comments/${seriesId}?page=${page}&limit=10`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    renderSeriesComments(data.comments);
                    renderSeriesCommentsPagination(data.page, data.totalPages);
                    document.getElementById('series-comments').style.display = 'block';
                }
            } catch (error) {
                console.error('Seri yorumları yüklenirken hata:', error);
            }
        }

        // Seri yorumlarını render et
        function renderSeriesComments(comments) {
            const listDiv = document.getElementById('series-comments-list');
            
            if (comments.length === 0) {
                listDiv.innerHTML = '<p style="text-align: center; color: #666;">Bu seride yorum bulunamadı.</p>';
                return;
            }

            listDiv.innerHTML = comments.map(comment => {
                // Yorum konumunu belirle
                let location = 'Ana Seri Sayfası';
                if (comment.chapterNumber) {
                    location = `Bölüm ${comment.chapterNumber}`;
                } else if (comment.seriesId && comment.seriesId.includes('-chapter-')) {
                    // Eski sistemde seriesId'den bölüm numarasını çıkar
                    const chapterMatch = comment.seriesId.match(/-chapter-(\d+)$/);
                    if (chapterMatch) {
                        location = `Bölüm ${chapterMatch[1]}`;
                    }
                }
                
                return `
                <div class="comment-item" style="border: 1px solid #ddd; border-radius: 8px; padding: 15px; margin-bottom: 10px; background: white;">
                    <div style="display: flex; justify-content: between; align-items: start;">
                        <div style="flex: 1;">
                            <p style="margin: 0 0 8px 0;">
                                <strong>${comment.author}</strong> - 
                                <span style="color: #666; font-size: 0.9rem;">${new Date(comment.date).toLocaleString('tr-TR')}</span>
                                <span style="background: #2196F3; color: white; padding: 2px 6px; border-radius: 3px; font-size: 0.8rem; margin-left: 10px;">${location}</span>
                                ${comment.deleted ? '<span style="color: red; font-size: 0.8rem; margin-left: 10px;">[SİLİNDİ]</span>' : ''}
                                ${comment.reported ? '<span style="background: #ff4444; color: white; padding: 2px 6px; border-radius: 3px; font-size: 0.8rem; margin-left: 10px;">RAPORLANDI</span>' : ''}
                            </p>
                            <p style="margin: 0; font-style: italic;">${comment.text}</p>
                            <p style="margin: 8px 0 0 0; font-size: 0.8rem; color: #666;">
                                👍 ${comment.likes} | 👎 ${comment.dislikes} | 💬 ${comment.replies ? comment.replies.length : 0} yanıt
                            </p>
                        </div>
                        <div style="margin-left: 15px;">
                            ${!comment.deleted ? `
                                <button onclick="deleteComment('${comment._id}')" 
                                    style="background: #f44336; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">
                                    🗑️ Sil
                                </button>
                            ` : ''}
                        </div>
                    </div>
                    
                    ${comment.replies && comment.replies.length > 0 ? `
                        <div style="margin-top: 15px; padding-left: 20px; border-left: 3px solid #eee;">
                            <h5 style="margin: 0 0 10px 0; color: #666;">Yanıtlar:</h5>
                            ${comment.replies.map(reply => `
                                <div style="background: #f9f9f9; padding: 10px; border-radius: 4px; margin-bottom: 8px;">
                                    <p style="margin: 0 0 5px 0; font-size: 0.9rem;">
                                        <strong>${reply.author}</strong> - 
                                        <span style="color: #666; font-size: 0.8rem;">${new Date(reply.date).toLocaleString('tr-TR')}</span>
                                        ${reply.deleted ? '<span style="color: red; font-size: 0.8rem; margin-left: 10px;">[SİLİNDİ]</span>' : ''}
                                    </p>
                                    <p style="margin: 0; font-size: 0.9rem; font-style: italic;">${reply.text}</p>
                                    ${!reply.deleted ? `
                                        <button onclick="deleteReply('${comment._id}', '${reply._id}')" 
                                            style="background: #f44336; color: white; border: none; padding: 3px 8px; border-radius: 3px; cursor: pointer; font-size: 0.7rem; margin-top: 5px;">
                                            🗑️ Sil
                                        </button>
                                    ` : ''}
                                </div>
                            `).join('')}
                        </div>
                    ` : ''}
                </div>
            `;
            }).join('');
        }

        // Yorum sil
        async function deleteComment(commentId) {
            if (!confirm('Bu yorumu silmek istediğinizden emin misiniz?')) return;
            
            try {
                const response = await fetch(`${API_BASE}/reports/admin/comment/${commentId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                
                if (response.ok) {
                    showStatus('Yorum silindi', 'success');
                    loadSeriesComments(currentCommentsPage);
                } else {
                    showStatus('Yorum silinirken hata oluştu', 'error');
                }
            } catch (error) {
                console.error('Yorum silme hatası:', error);
                showStatus('Yorum silinirken hata oluştu', 'error');
            }
        }

        // Yanıt sil
        async function deleteReply(commentId, replyId) {
            if (!confirm('Bu yanıtı silmek istediğinizden emin misiniz?')) return;
            
            try {
                const response = await fetch(`${API_BASE}/reports/admin/comment/${commentId}?replyId=${replyId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                
                if (response.ok) {
                    showStatus('Yanıt silindi', 'success');
                    loadSeriesComments(currentCommentsPage);
                } else {
                    showStatus('Yanıt silinirken hata oluştu', 'error');
                }
            } catch (error) {
                console.error('Yanıt silme hatası:', error);
                showStatus('Yanıt silinirken hata oluştu', 'error');
            }
        }

        // Pagination render fonksiyonları
        function renderReportsPagination(currentPage, totalPages) {
            const paginationDiv = document.getElementById('reports-pagination');
            if (totalPages <= 1) {
                paginationDiv.innerHTML = '';
                return;
            }
            
            let html = '';
            for (let i = 1; i <= totalPages; i++) {
                html += `<button onclick="loadReports(${i})" 
                    style="margin: 0 2px; padding: 5px 10px; border: 1px solid #ddd; background: ${i === currentPage ? '#667eea' : 'white'}; color: ${i === currentPage ? 'white' : 'black'}; cursor: pointer; border-radius: 3px;">
                    ${i}
                </button>`;
            }
            paginationDiv.innerHTML = html;
        }

        function renderSeriesCommentsPagination(currentPage, totalPages) {
            const paginationDiv = document.getElementById('series-comments-pagination');
            if (totalPages <= 1) {
                paginationDiv.innerHTML = '';
                return;
            }
            
            let html = '';
            for (let i = 1; i <= totalPages; i++) {
                html += `<button onclick="loadSeriesComments(${i})" 
                    style="margin: 0 2px; padding: 5px 10px; border: 1px solid #ddd; background: ${i === currentPage ? '#667eea' : 'white'}; color: ${i === currentPage ? 'white' : 'black'}; cursor: pointer; border-radius: 3px;">
                    ${i}
                </button>`;
            }
            paginationDiv.innerHTML = html;
        }

        // Yardımcı fonksiyonlar
        function getStatusColor(status) {
            const colors = {
                'pending': '#ff4444',
                'reviewed': '#4CAF50',
                'resolved': '#2196F3',
                'dismissed': '#9E9E9E'
            };
            return colors[status] || '#666';
        }

        function getStatusText(status) {
            const texts = {
                'pending': 'Bekliyor',
                'reviewed': 'İncelendi',
                'resolved': 'Çözüldü',
                'dismissed': 'Reddedildi'
            };
            return texts[status] || status;
        }

        function getReasonText(reason) {
            const reasons = {
                'spam': 'Spam/Reklam',
                'harassment': 'Taciz/Zorbalık',
                'hate-speech': 'Nefret Söylemi',
                'inappropriate': 'Uygunsuz İçerik',
                'misinformation': 'Yanlış Bilgi',
                'other': 'Diğer'
            };
            return reasons[reason] || reason;
        }

        // Duyuru Yönetimi Fonksiyonları
        let announcementCurrentPage = 1;
        let announcementTotalPages = 1;
        const announcementItemsPerPage = 10;

        // Duyuru formu submit event listener
        document.getElementById('announcement-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            await createAnnouncement();
        });

        // Duyuru filtreleme
        document.getElementById('announcement-filter').addEventListener('change', function() {
            announcementCurrentPage = 1;
            loadAnnouncements();
        });

        // Duyuru listesi yenileme
        document.getElementById('refresh-announcements').addEventListener('click', function() {
            loadAnnouncements();
        });

        // Duyuru formu temizleme
        document.getElementById('clear-announcement-form').addEventListener('click', function() {
            clearAnnouncementForm();
        });

        async function createAnnouncement() {
            const form = document.getElementById('announcement-form');
            const formData = new FormData(form);
            
            const announcementData = {
                title: formData.get('title'),
                content: formData.get('content'),
                type: formData.get('type'),
                isActive: formData.has('isActive')
            };

            try {
                showStatus('Duyuru ekleniyor...', 'info');
                
                const response = await fetch('https://toonnekoauth-api.onrender.com/api/announcements', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + localStorage.getItem('token')
                    },
                    body: JSON.stringify(announcementData)
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    showStatus('✅ Duyuru başarıyla eklendi!', 'success');
                    clearAnnouncementForm();
                    loadAnnouncements();
                } else {
                    showStatus('❌ ' + (result.message || 'Duyuru eklenirken hata oluştu'), 'error');
                }
            } catch (error) {
                console.error('Duyuru ekleme hatası:', error);
                showStatus('❌ Duyuru eklenirken hata oluştu', 'error');
            }
        }

        async function loadAnnouncements() {
            try {
                const filter = document.getElementById('announcement-filter').value;
                const response = await fetch(`https://toonnekoauth-api.onrender.com/api/announcements?page=${announcementCurrentPage}&limit=${announcementItemsPerPage}&filter=${filter}`, {
                    headers: {
                        'Authorization': 'Bearer ' + localStorage.getItem('token')
                    }
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    displayAnnouncements(result.announcements);
                    updateAnnouncementPagination(result.pagination);
                } else {
                    showStatus('❌ Duyurular yüklenirken hata oluştu', 'error');
                }
            } catch (error) {
                console.error('Duyuru yükleme hatası:', error);
                showStatus('❌ Duyurular yüklenirken hata oluştu', 'error');
            }
        }

        function displayAnnouncements(announcements) {
            const container = document.getElementById('announcements-list');
            
            if (!announcements || announcements.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 40px; color: #888;">Henüz duyuru bulunmuyor.</div>';
                return;
            }

            container.innerHTML = announcements.map(announcement => `
                <div class="announcement-item">
                    <div class="announcement-header-item">
                        <h4 class="announcement-title-item">${escapeHtml(announcement.title)}</h4>
                        <div>
                            <span class="announcement-type-badge announcement-type-${announcement.type}">
                                ${getTypeLabel(announcement.type)}
                            </span>
                            <span class="announcement-status-badge ${announcement.isActive ? 'announcement-active' : 'announcement-inactive'}">
                                ${announcement.isActive ? 'Aktif' : 'Pasif'}
                            </span>
                        </div>
                    </div>
                    <div class="announcement-content-item">${escapeHtml(announcement.content)}</div>
                    <div class="announcement-meta">
                        <span class="announcement-date">${formatDate(announcement.createdAt)}</span>
                        <div class="announcement-actions">
                            <button class="btn-edit-announcement" onclick="editAnnouncement('${announcement._id}')">
                                ✏️ Düzenle
                            </button>
                            <button class="btn-toggle-announcement" onclick="toggleAnnouncement('${announcement._id}', ${!announcement.isActive})">
                                ${announcement.isActive ? '🔴 Pasifleştir' : '🟢 Aktifleştir'}
                            </button>
                            <button class="btn-delete-announcement" onclick="deleteAnnouncement('${announcement._id}')">
                                🗑️ Sil
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function updateAnnouncementPagination(pagination) {
            announcementTotalPages = pagination.totalPages;
            announcementCurrentPage = pagination.currentPage;

            const container = document.getElementById('announcements-pagination');
            
            if (announcementTotalPages <= 1) {
                container.innerHTML = '';
                return;
            }

            let paginationHTML = '';
            
            // Previous button
            paginationHTML += `
                <button class="pagination-btn" onclick="changeAnnouncementPage(${announcementCurrentPage - 1})" 
                        ${announcementCurrentPage <= 1 ? 'disabled' : ''}>
                    ← Önceki
                </button>
            `;

            // Page numbers
            for (let i = 1; i <= announcementTotalPages; i++) {
                if (i === 1 || i === announcementTotalPages || (i >= announcementCurrentPage - 2 && i <= announcementCurrentPage + 2)) {
                    paginationHTML += `
                        <button class="pagination-btn ${i === announcementCurrentPage ? 'active' : ''}" 
                                onclick="changeAnnouncementPage(${i})">
                            ${i}
                        </button>
                    `;
                } else if (i === announcementCurrentPage - 3 || i === announcementCurrentPage + 3) {
                    paginationHTML += '<span class="pagination-ellipsis">...</span>';
                }
            }

            // Next button
            paginationHTML += `
                <button class="pagination-btn" onclick="changeAnnouncementPage(${announcementCurrentPage + 1})" 
                        ${announcementCurrentPage >= announcementTotalPages ? 'disabled' : ''}>
                    Sonraki →
                </button>
            `;

            container.innerHTML = paginationHTML;
        }

        function changeAnnouncementPage(page) {
            if (page >= 1 && page <= announcementTotalPages) {
                announcementCurrentPage = page;
                loadAnnouncements();
            }
        }

        async function toggleAnnouncement(announcementId, isActive) {
            try {
                const response = await fetch(`https://toonnekoauth-api.onrender.com/api/announcements/${announcementId}/toggle`, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': 'Bearer ' + localStorage.getItem('token')
                    }
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    showStatus(`✅ Duyuru ${isActive ? 'aktifleştirildi' : 'pasifleştirildi'}!`, 'success');
                    loadAnnouncements();
                } else {
                    showStatus('❌ ' + (result.message || 'Duyuru güncellenirken hata oluştu'), 'error');
                }
            } catch (error) {
                console.error('Duyuru güncelleme hatası:', error);
                showStatus('❌ Duyuru güncellenirken hata oluştu', 'error');
            }
        }

        async function deleteAnnouncement(announcementId) {
            if (!confirm('Bu duyuruyu silmek istediğinizden emin misiniz?')) {
                return;
            }

            try {
                const response = await fetch(`https://toonnekoauth-api.onrender.com/api/announcements/${announcementId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': 'Bearer ' + localStorage.getItem('token')
                    }
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    showStatus('✅ Duyuru başarıyla silindi!', 'success');
                    loadAnnouncements();
                } else {
                    showStatus('❌ ' + (result.message || 'Duyuru silinirken hata oluştu'), 'error');
                }
            } catch (error) {
                console.error('Duyuru silme hatası:', error);
                showStatus('❌ Duyuru silinirken hata oluştu', 'error');
            }
        }

        async function editAnnouncement(announcementId) {
            try {
                const response = await fetch(`https://toonnekoauth-api.onrender.com/api/announcements/${announcementId}`, {
                    headers: {
                        'Authorization': 'Bearer ' + localStorage.getItem('token')
                    }
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    // Form alanlarını doldur
                    document.getElementById('announcement-title').value = result.announcement.title;
                    document.getElementById('announcement-content').value = result.announcement.content;
                    document.getElementById('announcement-type').value = result.announcement.type;
                    document.getElementById('announcement-active').checked = result.announcement.isActive;

                    // Form submit handler'ını güncelleme moduna çevir
                    const form = document.getElementById('announcement-form');
                    form.onsubmit = async function(e) {
                        e.preventDefault();
                        await updateAnnouncement(announcementId);
                    };

                    // Form butonunu güncelle
                    const submitBtn = form.querySelector('button[type="submit"]');
                    submitBtn.textContent = '✏️ Duyuru Güncelle';
                    submitBtn.style.background = '#ff9800';

                    // Sayfayı yukarı kaydır
                    form.scrollIntoView({ behavior: 'smooth' });
                } else {
                    showStatus('❌ Duyuru bilgileri yüklenirken hata oluştu', 'error');
                }
            } catch (error) {
                console.error('Duyuru yükleme hatası:', error);
                showStatus('❌ Duyuru bilgileri yüklenirken hata oluştu', 'error');
            }
        }

        async function updateAnnouncement(announcementId) {
            const form = document.getElementById('announcement-form');
            const formData = new FormData(form);
            
            const announcementData = {
                title: formData.get('title'),
                content: formData.get('content'),
                type: formData.get('type'),
                isActive: formData.has('isActive')
            };

            try {
                showStatus('Duyuru güncelleniyor...', 'info');
                
                const response = await fetch(`https://toonnekoauth-api.onrender.com/api/announcements/${announcementId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + localStorage.getItem('token')
                    },
                    body: JSON.stringify(announcementData)
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    showStatus('✅ Duyuru başarıyla güncellendi!', 'success');
                    clearAnnouncementForm();
                    loadAnnouncements();
                } else {
                    showStatus('❌ ' + (result.message || 'Duyuru güncellenirken hata oluştu'), 'error');
                }
            } catch (error) {
                console.error('Duyuru güncelleme hatası:', error);
                showStatus('❌ Duyuru güncellenirken hata oluştu', 'error');
            }
        }

        function clearAnnouncementForm() {
            const form = document.getElementById('announcement-form');
            form.reset();
            
            // Form submit handler'ını yeni duyuru moduna çevir
            form.onsubmit = async function(e) {
                e.preventDefault();
                await createAnnouncement();
            };

            // Form butonunu sıfırla
            const submitBtn = form.querySelector('button[type="submit"]');
            submitBtn.textContent = '📢 Duyuru Ekle';
            submitBtn.style.background = '#667eea';
        }

        function getTypeLabel(type) {
            switch (type) {
                case 'info': return 'ℹ️ Bilgi';
                case 'warning': return '⚠️ Uyarı';
                case 'success': return '✅ Başarı';
                default: return 'ℹ️ Bilgi';
            }
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('tr-TR', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // İstatistikler için fonksiyonlar
        
        // Ana istatistikleri yükle
        async function loadStatsOverview() {
            try {
                // Seri bazında istatistikler
                const seriesResponse = await fetch(`${API_BASE}/stats/series-stats`);
                const seriesData = await seriesResponse.json();
                
                if (seriesData.success) {
                    const stats = seriesData.data;
                    
                    // Toplam okuma hesapla
                    const totalReads = stats.reduce((sum, series) => sum + series.totalReads, 0);
                    const weeklyReads = stats.reduce((sum, series) => sum + series.weeklyReads, 0);
                    const totalSeries = stats.length;
                    
                    // Bugünkü okuma sayısını al (haftalık veriden tahmin et)
                    const todayReads = Math.round(weeklyReads / 7);
                    
                    // İstatistik kartlarını güncelle
                    document.getElementById('total-reads-today').textContent = formatNumber(todayReads);
                    document.getElementById('total-reads-week').textContent = formatNumber(weeklyReads);
                    document.getElementById('total-reads-all').textContent = formatNumber(totalReads);
                    document.getElementById('total-series-read').textContent = totalSeries;
                    
                    // En popüler seriler tablosunu güncelle
                    updatePopularSeriesTable(stats);
                }
            } catch (error) {
                console.error('Stats overview error:', error);
                showStatus('İstatistik verileri yüklenirken hata oluştu', 'error');
            }
        }
        
        // Detaylı istatistikleri yükle
        async function loadDetailedStats(page = 1) {
            try {
                const seriesFilter = document.getElementById('stats-series-filter').value;
                const periodFilter = document.getElementById('stats-period-filter').value;
                
                let url = `${API_BASE}/stats/admin/detailed-stats?page=${page}&limit=20`;
                if (seriesFilter) {
                    url += `&seriesId=${encodeURIComponent(seriesFilter)}`;
                }
                
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.success) {
                    updateDetailedStatsTable(data.data);
                    updateStatsPagination(data.pagination);
                }
            } catch (error) {
                console.error('Detailed stats error:', error);
                showStatus('Detaylı istatistikler yüklenirken hata oluştu', 'error');
            }
        }
        
        // İstatistikler için seri listesini yükle
        async function loadStatsSeriesList() {
            try {
                const response = await fetch(`${API_BASE}/stats/series-stats`);
                const data = await response.json();
                
                if (data.success) {
                    const select = document.getElementById('stats-series-filter');
                    select.innerHTML = '<option value="">Tüm Seriler</option>';
                    
                    data.data.forEach(series => {
                        const option = document.createElement('option');
                        option.value = series._id;
                        option.textContent = `${series.seriesTitle} (${formatNumber(series.totalReads)} okuma)`;
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Stats series list error:', error);
            }
        }
        
        // En popüler seriler tablosunu güncelle
        function updatePopularSeriesTable(seriesStats) {
            const tbody = document.getElementById('popular-series-table');
            
            if (!seriesStats || seriesStats.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="padding: 20px; text-align: center; color: #666;">Henüz okuma verisi yok</td></tr>';
                return;
            }
            
            const sortedSeries = seriesStats
                .sort((a, b) => b.totalReads - a.totalReads)
                .slice(0, 20);
            
            tbody.innerHTML = sortedSeries.map((series, index) => {
                const avgReads = Math.round(series.avgReadsPerChapter || 0);
                const lastRead = series.lastRead ? formatDate(series.lastRead) : 'Hiç okunmadı';
                
                return `
                    <tr style="border-bottom: 1px solid #dee2e6;">
                        <td style="padding: 12px; font-weight: bold; color: #666;">${index + 1}</td>
                        <td style="padding: 12px; font-weight: 500;">${escapeHtml(series.seriesTitle)}</td>
                        <td style="padding: 12px; text-align: center; font-weight: bold; color: #007bff;">${formatNumber(series.totalReads)}</td>
                        <td style="padding: 12px; text-align: center; color: #ff6f61;">${formatNumber(series.weeklyReads)}</td>
                        <td style="padding: 12px; text-align: center;">${series.chapterCount}</td>
                        <td style="padding: 12px; text-align: center; color: #28a745;">${formatNumber(avgReads)}</td>
                        <td style="padding: 12px; text-align: center; font-size: 0.9rem; color: #666;">${lastRead}</td>
                    </tr>
                `;
            }).join('');
        }
        
        // Detaylı istatistikler tablosunu güncelle
        function updateDetailedStatsTable(statsData) {
            const tbody = document.getElementById('detailed-stats-table');
            
            if (!statsData || statsData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="padding: 20px; text-align: center; color: #666;">Veri bulunamadı</td></tr>';
                return;
            }
            
            tbody.innerHTML = statsData.map(stat => {
                const lastRead = stat.lastRead ? formatDate(stat.lastRead) : 'Hiç okunmadı';
                
                return `
                    <tr style="border-bottom: 1px solid #dee2e6;">
                        <td style="padding: 12px; font-weight: 500;">${escapeHtml(stat.seriesTitle)}</td>
                        <td style="padding: 12px; text-align: center;">Bölüm ${stat.chapterNumber}</td>
                        <td style="padding: 12px; text-align: center; font-weight: bold; color: #007bff;">${formatNumber(stat.totalReads)}</td>
                        <td style="padding: 12px; text-align: center; color: #ff6f61;">${formatNumber(stat.weeklyReads)}</td>
                        <td style="padding: 12px; text-align: center; color: #ffc107;">${formatNumber(stat.dailyReads)}</td>
                        <td style="padding: 12px; text-align: center; font-size: 0.9rem; color: #666;">${lastRead}</td>
                    </tr>
                `;
            }).join('');
        }
        
        // Pagination güncelle
        function updateStatsPagination(pagination) {
            const container = document.getElementById('stats-pagination');
            
            if (!pagination || pagination.pages <= 1) {
                container.innerHTML = '';
                return;
            }
            
            const { page, pages } = pagination;
            let html = '<div style="display: flex; gap: 5px; justify-content: center; align-items: center;">';
            
            // Previous button
            if (page > 1) {
                html += `<button onclick="loadDetailedStats(${page - 1})" style="padding: 8px 12px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">‹ Önceki</button>`;
            }
            
            // Page numbers
            const maxVisible = 5;
            let startPage = Math.max(1, page - Math.floor(maxVisible / 2));
            let endPage = Math.min(pages, startPage + maxVisible - 1);
            
            if (endPage - startPage + 1 < maxVisible) {
                startPage = Math.max(1, endPage - maxVisible + 1);
            }
            
            for (let i = startPage; i <= endPage; i++) {
                const isActive = i === page;
                html += `<button onclick="loadDetailedStats(${i})" style="padding: 8px 12px; background: ${isActive ? '#6c757d' : '#fff'}; color: ${isActive ? 'white' : '#007bff'}; border: 1px solid ${isActive ? '#6c757d' : '#007bff'}; border-radius: 4px; cursor: pointer;">${i}</button>`;
            }
            
            // Next button
            if (page < pages) {
                html += `<button onclick="loadDetailedStats(${page + 1})" style="padding: 8px 12px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">Sonraki ›</button>`;
            }
            
            html += `<span style="margin-left: 15px; color: #666;">Sayfa ${page} / ${pages}</span>`;
            html += '</div>';
            
            container.innerHTML = html;
        }
        
        // Sayı formatlama
        function formatNumber(num) {
            if (num >= 1000000) {
                return (num / 1000000).toFixed(1) + 'M';
            } else if (num >= 1000) {
                return (num / 1000).toFixed(1) + 'K';
            }
            return num.toString();
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Token alma fonksiyonu
        function getToken() {
            return localStorage.getItem('token') || 'test-admin-token-for-development';
        }

        // ========== MODERATÖR YÖNETİMİ FONKSİYONLARI ==========

        // Moderatörleri yükle
        async function loadModerators() {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`${API_BASE}/admin/moderators`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) throw new Error('Moderatörler yüklenemedi');

                const moderators = await response.json();
                displayModerators(moderators);
                updateModeratorStats(moderators);
            } catch (error) {
                console.error('Moderatörleri yükleme hatası:', error);
                showErrorAlert('Moderatörleri yüklerken hata oluştu');
            }
        }

        // Moderatörleri görüntüle
        function displayModerators(moderators) {
            const container = document.getElementById('moderators-list');
            const loading = document.getElementById('moderators-loading');

            loading.style.display = 'none';
            container.style.display = 'block';

            if (moderators.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 40px; color: #666;">Henüz moderatör atanmamış</div>';
                return;
            }

            container.innerHTML = moderators.map(moderator => `
                <div class="moderator-card" style="background: white; border: 1px solid #e0e0e0; border-radius: 10px; padding: 20px; margin-bottom: 15px;">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                        <div style="flex: 1;">
                            <h4 style="margin-bottom: 8px; color: #333;">🛡️ ${escapeHtml(moderator.username)}</h4>
                            <p style="color: #666; margin-bottom: 8px;">${escapeHtml(moderator.email)}</p>
                            <div style="margin-bottom: 10px;">
                                <span style="background: #28a745; color: white; padding: 3px 8px; border-radius: 12px; font-size: 12px;">
                                    Moderatör
                                </span>
                            </div>
                            <div>
                                <strong style="color: #667eea;">Atanmış Seriler (${moderator.moderatorSeries.length}):</strong>
                                <div style="margin-top: 5px;">
                                    ${moderator.moderatorSeries.length > 0 
                                        ? moderator.moderatorSeries.map(seriesId => 
                                            `<span style="background: #f8f9fa; border: 1px solid #dee2e6; padding: 2px 6px; border-radius: 4px; margin-right: 5px; font-size: 12px;">${seriesId}</span>`
                                          ).join('') 
                                        : '<span style="color: #999; font-style: italic;">Seri atanmamış</span>'
                                    }
                                </div>
                            </div>
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <button onclick="editModerator('${moderator._id}')" style="background: #667eea; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; font-size: 12px;">
                                ✏️ Düzenle
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Moderatör istatistiklerini güncelle
        function updateModeratorStats(moderators) {
            const totalModerators = moderators.length;
            const activeModerators = moderators.filter(m => m.moderatorSeries.length > 0).length;
            const totalManagedSeries = new Set(moderators.flatMap(m => m.moderatorSeries)).size;

            document.getElementById('total-moderators-count').textContent = totalModerators;
            document.getElementById('active-moderators-count').textContent = activeModerators;
            document.getElementById('managed-series-count').textContent = totalManagedSeries;
        }

        // Moderatör atama için serileri yükle
        async function loadSeriesForModeratorAssignment() {
            try {
                // Test endpoint kullan (geçici çözüm)
                const response = await fetch(`${API_BASE}/admin/test-available-series`, {
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) throw new Error('Seriler yüklenemedi');

                const data = await response.json();
                console.log('Moderatör atama için gelen seri verisi:', data);
                
                let series = [];
                if (data.success && Array.isArray(data.series)) {
                    series = data.series;
                } else if (Array.isArray(data)) {
                    series = data;
                } else {
                    console.error('Beklenmeyen veri formatı:', data);
                    throw new Error('Seri verisi yanlış formatta');
                }
                
                const editSeriesSelect = document.getElementById('edit-series-select');
                
                const seriesOptions = series.map(s => 
                    `<option value="${s.id}">${escapeHtml(s.title)} ${s.status ? `(${s.status})` : ''}</option>`
                ).join('');
                
                editSeriesSelect.innerHTML = seriesOptions;
            } catch (error) {
                console.error('Serileri yükleme hatası:', error);
            }
        }

        // Moderatör düzenle
        async function editModerator(moderatorId) {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`${API_BASE}/admin/users`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) throw new Error('Kullanıcı bilgileri alınamadı');

                const users = await response.json();
                const moderator = users.find(u => u._id === moderatorId);
                
                if (!moderator) {
                    showErrorAlert('Moderatör bulunamadı');
                    return;
                }

                // Modal içeriğini doldur
                document.getElementById('edit-moderator-id').value = moderatorId;
                document.getElementById('edit-moderator-info').innerHTML = `
                    <div><strong>Kullanıcı Adı:</strong> ${escapeHtml(moderator.username)}</div>
                    <div><strong>E-posta:</strong> ${escapeHtml(moderator.email)}</div>
                    <div><strong>Kayıt Tarihi:</strong> ${new Date(moderator.createdAt).toLocaleDateString('tr-TR')}</div>
                `;

                // Mevcut serileri seçili yap
                const editSeriesSelect = document.getElementById('edit-series-select');
                Array.from(editSeriesSelect.options).forEach(option => {
                    option.selected = moderator.moderatorSeries.includes(option.value);
                });

                // Modalı göster
                document.getElementById('moderator-edit-modal').style.display = 'block';
            } catch (error) {
                console.error('Moderatör düzenleme hatası:', error);
                showErrorAlert('Moderatör bilgileri alınamadı');
            }
        }

        // Moderatör modalını kapat
        function closeModeratorModal() {
            document.getElementById('moderator-edit-modal').style.display = 'none';
        }

        // Moderatör güncelle
        document.getElementById('edit-moderator-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const moderatorId = document.getElementById('edit-moderator-id').value;
            const seriesSelect = document.getElementById('edit-series-select');
            const selectedSeries = Array.from(seriesSelect.selectedOptions).map(option => option.value);
            
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`${API_BASE}/admin/update-moderator-series`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        userId: moderatorId,
                        seriesIds: selectedSeries
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Moderatör güncelleme başarısız');
                }

                showSuccessAlert('Moderatör serileri başarıyla güncellendi');
                closeModeratorModal();
                loadModerators();
            } catch (error) {
                console.error('Moderatör güncelleme hatası:', error);
                showErrorAlert(error.message);
            }
        });

        // Moderatör kaldır
        async function removeModerator() {
            const moderatorId = document.getElementById('edit-moderator-id').value;
            
            if (!confirm('Bu kullanıcının moderatör yetkilerini kaldırmak istediğinizden emin misiniz?')) {
                return;
            }
            
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`${API_BASE}/admin/remove-moderator`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        userId: moderatorId
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Moderatör kaldırma başarısız');
                }

                showSuccessAlert('Moderatör yetkileri başarıyla kaldırıldı');
                closeModeratorModal();
                loadModerators();
                loadUsersForModeratorAssignment();
            } catch (error) {
                console.error('Moderatör kaldırma hatası:', error);
                showErrorAlert(error.message);
            }
        }

        // ========== KULLANICI YÖNETİMİNDE MODERATÖR FONKSİYONLARI ==========

        // Kullanıcı için seri yükleme
        async function loadSeriesForUserModeratorAssignment() {
            try {
                // Test endpoint kullan (geçici çözüm)
                const response = await fetch(`${API_BASE}/admin/test-available-series`, {
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) throw new Error('Seriler yüklenemedi');

                const data = await response.json();
                console.log('Gelen seri verisi:', data);
                
                let series = [];
                if (data.success && Array.isArray(data.series)) {
                    series = data.series;
                } else if (Array.isArray(data)) {
                    series = data;
                } else {
                    console.error('Beklenmeyen veri formatı:', data);
                    throw new Error('Seri verisi yanlış formatta');
                }
                
                const userSeriesSelect = document.getElementById('user-series-select');
                
                const seriesOptions = series.map(s => 
                    `<option value="${s.id}">${escapeHtml(s.title)} ${s.status ? `(${s.status})` : ''}</option>`
                ).join('');
                
                userSeriesSelect.innerHTML = seriesOptions;
            } catch (error) {
                console.error('Serileri yükleme hatası:', error);
            }
        }

        // Moderatör atama işlemini ayarla
        function setupModeratorAssignment(user) {
            document.getElementById('selected-user-id').value = user._id;
            
            // Butonları kullanıcı durumuna göre ayarla
            const makeModerator = document.getElementById('make-moderator-btn');
            const updateModerator = document.getElementById('update-moderator-btn');
            const removeModerator = document.getElementById('remove-moderator-btn');
            const seriesSelect = document.getElementById('user-series-select');
            
            if (user.isModerator) {
                // Kullanıcı zaten moderatör
                makeModerator.style.display = 'none';
                updateModerator.style.display = 'inline-block';
                removeModerator.style.display = 'inline-block';
                
                // Mevcut serileri seçili yap
                Array.from(seriesSelect.options).forEach(option => {
                    option.selected = user.moderatorSeries && user.moderatorSeries.includes(option.value);
                });
            } else {
                // Kullanıcı henüz moderatör değil
                makeModerator.style.display = 'inline-block';
                updateModerator.style.display = 'none';
                removeModerator.style.display = 'none';
                
                // Tüm seçimleri temizle
                Array.from(seriesSelect.options).forEach(option => {
                    option.selected = false;
                });
            }
        }

        // Kullanıcıyı moderatör yap
        async function makeUserModerator() {
            const userId = document.getElementById('selected-user-id').value;
            const seriesSelect = document.getElementById('user-series-select');
            const selectedSeries = Array.from(seriesSelect.selectedOptions).map(option => option.value);
            
            if (!userId) {
                showErrorAlert('Kullanıcı ID bulunamadı');
                return;
            }
            
            try {
                const token = getToken();
                const response = await fetch(`${API_BASE}/admin/make-moderator`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        userId: userId,
                        seriesIds: selectedSeries
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Moderatör atama başarısız');
                }

                showSuccessAlert('Kullanıcı başarıyla moderatör yapıldı');
                closeUserModal();
                loadUsers(); // Kullanıcı listesini yenile
            } catch (error) {
                console.error('Moderatör atama hatası:', error);
                showErrorAlert(error.message);
            }
        }

        // Kullanıcının moderatör serilerini güncelle
        async function updateUserModeratorSeries() {
            const userId = document.getElementById('selected-user-id').value;
            const seriesSelect = document.getElementById('user-series-select');
            const selectedSeries = Array.from(seriesSelect.selectedOptions).map(option => option.value);
            
            if (!userId) {
                showErrorAlert('Kullanıcı ID bulunamadı');
                return;
            }
            
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`${API_BASE}/admin/update-moderator-series`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        userId: userId,
                        seriesIds: selectedSeries
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Moderatör güncelleme başarısız');
                }

                showSuccessAlert('Moderatör serileri başarıyla güncellendi');
                closeUserModal();
                loadUsers(); // Kullanıcı listesini yenile
            } catch (error) {
                console.error('Moderatör güncelleme hatası:', error);
                showErrorAlert(error.message);
            }
        }

        // Kullanıcının moderatör yetkilerini kaldır
        async function removeUserModerator() {
            const userId = document.getElementById('selected-user-id').value;
            
            if (!confirm('Bu kullanıcının moderatör yetkilerini kaldırmak istediğinizden emin misiniz?')) {
                return;
            }
            
            if (!userId) {
                showErrorAlert('Kullanıcı ID bulunamadı');
                return;
            }
            
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`${API_BASE}/admin/remove-moderator`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        userId: userId
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Moderatör kaldırma başarısız');
                }

                showSuccessAlert('Moderatör yetkileri başarıyla kaldırıldı');
                closeUserModal();
                loadUsers(); // Kullanıcı listesini yenile
            } catch (error) {
                console.error('Moderatör kaldırma hatası:', error);
                showErrorAlert(error.message);
            }
        }
    </script>
</body>
</html>

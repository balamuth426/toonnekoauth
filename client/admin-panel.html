<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ToonNeko Admin Panel</title>
    <link rel="stylesheet" href="admin-panel.css">
</head>
<body>
    <div class="admin-container">
        <div class="admin-header">
            <h1>ü¶∏‚Äç‚ôÇÔ∏è ToonNeko Admin Panel</h1>
            <p>Google Drive ile Manhwa Y√∂netimi (Proxy Desteƒüi)</p>
        </div>

        <div class="admin-content">
            <div class="tab-container">
                <button class="tab-btn active" onclick="switchTab('series')">üìö Yeni Seri</button>
                <button class="tab-btn" onclick="switchTab('chapter')">üìñ Yeni B√∂l√ºm</button>
                <button class="tab-btn" onclick="switchTab('edit')">‚úèÔ∏è Seri D√ºzenle</button>
                <button class="tab-btn" onclick="switchTab('manage')">‚öôÔ∏è B√∂l√ºm Y√∂netimi</button>
                <button class="tab-btn" onclick="switchTab('stats')">üìä Okuma ƒ∞statistikleri</button>
                <button class="tab-btn" onclick="switchTab('comments')">üí¨ Yorum Y√∂netimi</button>
                <button class="tab-btn" onclick="switchTab('announcements')">üì¢ Duyuru Y√∂netimi</button>
                <button class="tab-btn" onclick="switchTab('users')">üë• Kullanƒ±cƒ± Y√∂netimi</button>
                <button class="tab-btn" onclick="switchTab('moderators')">üõ°Ô∏è Moderat√∂r Y√∂netimi</button>
                <button class="tab-btn" onclick="switchTab('delete')">üóëÔ∏è Seri Sil</button>
                <button class="tab-btn" onclick="switchTab('validate')">üîó Link Doƒürula</button>
            </div>

            <div id="status-message" class="status-message"></div>
            <div id="loading" class="loading">
                <div class="spinner"></div>
                <p>ƒ∞≈ülem ger√ßekle≈ütiriliyor...</p>
            </div>

            <!-- Dinamik i√ßerik alanƒ± -->
            <div id="dynamic-tab-content"></div>
        </div>
    </div>

    <script src="config.js?v=5"></script>

     

    <script>
    /*    
        // API Base URL - local development i√ßin
        const API_BASE = location.hostname === 'localhost'
  ? 'http://localhost:5506/api'
  : 'https://toonnekoauth-api.onrender.com/api';
        
        // Giri≈ü kontrol√º
        function checkAuthentication() {
            const token = localStorage.getItem('token');
            if (!token) {
                // Ana i√ßeriƒüi gizle
                document.querySelector('.admin-container').style.display = 'none';
                // Giri≈ü sayfasƒ±na y√∂nlendir veya giri≈ü modalƒ± g√∂ster
                showLoginForm();
                return false;
            }
            return true;
        }
         
        // Basit giri≈ü formu g√∂ster
        function showLoginForm() {
            const loginHtml = `
                <div id="login-overlay" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 9999; display: flex; align-items: center; justify-content: center;">
                    <div style="background: white; padding: 30px; border-radius: 15px; width: 400px; max-width: 90%;">
                        <h2 style="text-align: center; margin-bottom: 20px; color: #333;">Admin Paneli Giri≈üi</h2>
                        <form id="admin-login-form">
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Kullanƒ±cƒ± Adƒ± veya Email:</label>
                                <input type="text" id="admin-username" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;" required>
                            </div>
                            <div style="margin-bottom: 20px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: bold;">≈ûifre:</label>
                                <input type="password" id="admin-password" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;" required>
                            </div>
                            <button type="submit" style="width: 100%; padding: 12px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 5px; font-size: 16px; cursor: pointer;">Giri≈ü Yap</button>
                            <div id="login-error" style="color: #dc3545; text-align: center; margin-top: 10px; display: none;"></div>
                        </form>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', loginHtml);
            
            document.getElementById('admin-login-form').addEventListener('submit', handleAdminLogin);
        }
        
        // Admin giri≈üi i≈üle
        async function handleAdminLogin(e) {
            e.preventDefault();
            
            const username = document.getElementById('admin-username').value;
            const password = document.getElementById('admin-password').value;
            const errorDiv = document.getElementById('login-error');
            
        try {
            const response = await fetch('http://localhost:5506/api/auth/login', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ identifier: username, password })
            });
            
            const data = await response.json();
            
            if (response.ok && data.token) {
                // Admin kontrol√º
                if (!data.user.isAdmin) {
                    errorDiv.textContent = 'Bu hesap admin yetkisine sahip deƒüil.';
                    errorDiv.style.display = 'block';
                    return;
                }
                
                localStorage.setItem('token', data.token);
                document.getElementById('login-overlay').remove();
                
                // Ana i√ßeriƒüi g√∂ster
                document.querySelector('.admin-container').style.display = 'block';
                
                // Ho≈ü geldin mesajƒ±
                alert(`Ho≈ü geldiniz, ${data.user.username}!`);
            } else {
                errorDiv.textContent = data.message || 'Giri≈ü ba≈üarƒ±sƒ±z';
                errorDiv.style.display = 'block';
            }
        } 
        catch (error) {
            errorDiv.textContent = 'Giri≈ü yapƒ±lƒ±rken hata olu≈ütu: ' + error.message;
            errorDiv.style.display = 'block';
        }
        
        // Google Drive Helper Functions
        function extractFileId(driveUrl) {
            const match = driveUrl.match(/\/file\/d\/([a-zA-Z0-9_-]+)/);
            return match ? match[1] : null;
        }
        
        function createProxyUrl(fileId) {
            return `${API_BASE}/image/proxy-image/${fileId}`;
        }
        
        function createDirectUrls(fileId) {
            return {
                proxy: `${API_BASE}/image/proxy-image/${fileId}`,
                high: `https://drive.google.com/uc?export=view&id=${fileId}`,
                download: `https://drive.usercontent.google.com/download?id=${fileId}&authuser=0`,
                medium: `https://drive.google.com/uc?id=${fileId}`,
                thumbnail: `https://drive.google.com/thumbnail?id=${fileId}&sz=s1600`
            }
        }
        
        // Tab switching
        function switchTab(tabName) {
            // Remove active class from all tabs
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
                content.style.display = 'none';
            });
            
            // Add active class to selected tab
            event.target.classList.add('active');
            const targetTab = document.getElementById(tabName + '-tab');
            targetTab.classList.add('active');
            targetTab.style.display = 'block';
            
            // Manage tab a√ßƒ±ldƒ±ƒüƒ±nda serileri y√ºkle
            if (tabName === 'manage') {
                loadSeriesList();
            }
            
            // Chapter tab a√ßƒ±ldƒ±ƒüƒ±nda serileri y√ºkle
            if (tabName === 'chapter') {
                loadChapterSeriesList();
            }
            
            // Edit tab a√ßƒ±ldƒ±ƒüƒ±nda serileri y√ºkle
            if (tabName === 'edit') {
                loadEditSeriesList();
            }
            
            // Delete tab a√ßƒ±ldƒ±ƒüƒ±nda serileri y√ºkle
            if (tabName === 'delete') {
                loadDeleteSeriesList();
            }
            
            // Comments tab a√ßƒ±ldƒ±ƒüƒ±nda verileri y√ºkle
            if (tabName === 'comments') {
                loadReportsStats();
                loadReports();
                loadCommentsSeriesList();
            }
            
            // Stats tab a√ßƒ±ldƒ±ƒüƒ±nda istatistikleri y√ºkle
            if (tabName === 'stats') {
                loadStatsOverview();
                loadDetailedStats();
                loadStatsSeriesList();
            }
            
            // Announcements tab a√ßƒ±ldƒ±ƒüƒ±nda duyurularƒ± y√ºkle
            if (tabName === 'announcements') {
                loadAnnouncements();
            }
        }

        // Show status message
        function showStatus(message, type) {
            const statusDiv = document.getElementById('status-message');
            statusDiv.textContent = message;
            statusDiv.className = `status-message ${type}`;
            statusDiv.style.display = 'block';
            
            setTimeout(() => {
                statusDiv.style.display = 'none';
            }, 5000);
        }

        // Show/hide loading
        function toggleLoading(show) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
        }

        // Show/hide loading (alias for consistency)
        function showLoading(show) {
            toggleLoading(show);
        }

        // Get auth token (assuming it's stored in localStorage)
        function getAuthToken() {
            // Test i√ßin varsayƒ±lan token
            return localStorage.getItem('token') || 'test-admin-token-for-development';
        }

        // Image input management
        function addImageInput() {
            const container = document.getElementById('image-inputs');
            const inputCount = container.children.length;
            
            const newInputDiv = document.createElement('div');
            newInputDiv.className = 'image-input-item';
            newInputDiv.innerHTML = `
                <input type="url" placeholder="Sayfa ${inputCount + 1} Google Drive linki" required>
                <button type="button" class="btn btn-danger btn-small" onclick="removeImageInput(this)">Sil</button>
            `;
            
            container.appendChild(newInputDiv);
        }

        function removeImageInput(button) {
            const container = document.getElementById('image-inputs');
            if (container.children.length > 1) {
                button.parentElement.remove();
                
                // Update placeholders
                const inputs = container.querySelectorAll('input');
                inputs.forEach((input, index) => {
                    input.placeholder = `Sayfa ${index + 1} Google Drive linki`;
                });
            }
        }

        // Cover image validation
        async function validateCoverImage() {
            const coverUrl = document.getElementById('series-cover').value;
            if (!coverUrl) {
                showStatus('L√ºtfen kapak g√∂rseli linkini girin', 'error');
                return;
            }

            const fileId = extractFileId(coverUrl);
            if (!fileId) {
                showStatus('Ge√ßersiz Google Drive link formatƒ±!', 'error');
                return;
            }

            toggleLoading(true);
            showStatus(`File ID: ${fileId} - Test ba≈ülatƒ±lƒ±yor...`, 'info');
            
            try {
                // Test multiple URL formats
                const proxyUrl = `${API_BASE}/image/proxy-image/${fileId}`;
                const directUrls = createDirectUrls(fileId);
                
                console.log('Testing URLs:', { proxyUrl, directUrls });
                
                // Clear previous preview
                const previewDiv = document.getElementById('cover-preview');
                previewDiv.innerHTML = `
                    <h4>G√∂rsel Test Sonu√ßlarƒ±:</h4>
                    <div id="test-results"></div>
                `;
                previewDiv.style.display = 'block';
                
                const resultsDiv = document.getElementById('test-results');
                
                // Test proxy URL first (recommended)
                await testImageFormat(resultsDiv, 'Server Proxy (√ñnerilen)', proxyUrl, true);
                
                // Test direct formats
                await testImageFormat(resultsDiv, 'High Quality Direct', directUrls.high, false);
                await testImageFormat(resultsDiv, 'Download Format', directUrls.download, false);
                await testImageFormat(resultsDiv, 'Medium Quality', directUrls.medium, false);
                
            } catch (error) {
                showStatus('Doƒürulama sƒ±rasƒ±nda hata olu≈ütu: ' + error.message, 'error');
                console.error('Validation error:', error);
            }
            
            toggleLoading(false);
        }
        
        async function testImageFormat(container, formatName, url, isRecommended) {
            return new Promise((resolve) => {
                const testDiv = document.createElement('div');
                testDiv.style.cssText = `
                    margin: 10px 0; 
                    padding: 10px; 
                    border: 1px solid #ddd; 
                    border-radius: 5px;
                    background: ${isRecommended ? '#e8f5e8' : '#f8f9fa'};
                `;
                
                testDiv.innerHTML = `
                    <h5>${isRecommended ? 'üõ°Ô∏è' : 'üåê'} ${formatName}</h5>
                    <div style="font-size: 12px; color: #666; word-break: break-all; margin: 5px 0;">${url}</div>
                    <p id="status-${formatName.replace(/\s+/g, '-').toLowerCase()}">Test ediliyor...</p>
                    <div id="image-container-${formatName.replace(/\s+/g, '-').toLowerCase()}"></div>
                `;
                
                container.appendChild(testDiv);
                
                const statusEl = document.getElementById(`status-${formatName.replace(/\s+/g, '-').toLowerCase()}`);
                const imgContainer = document.getElementById(`image-container-${formatName.replace(/\s+/g, '-').toLowerCase()}`);
                
                const img = new Image();
                img.style.cssText = 'max-width: 200px; max-height: 200px; border: 2px solid #ddd; border-radius: 5px; margin-top: 10px;';
                
                const startTime = Date.now();
                
                img.onload = function() {
                    const loadTime = Date.now() - startTime;
                    img.style.borderColor = '#28a745';
                    statusEl.innerHTML = `‚úÖ Ba≈üarƒ±lƒ±! (${loadTime}ms)<br><small>${img.naturalWidth} x ${img.naturalHeight}px</small>`;
                    imgContainer.appendChild(img);
                    
                    if (isRecommended) {
                        showStatus(`‚úÖ Kapak g√∂rseli ba≈üarƒ±yla y√ºklendi! (${formatName})`, 'success');
                    }
                    resolve(true);
                };
                
                img.onerror = function() {
                    const loadTime = Date.now() - startTime;
                    img.style.borderColor = '#dc3545';
                    statusEl.innerHTML = `‚ùå Y√ºklenemedi (${loadTime}ms)<br><small>CORS veya eri≈üim hatasƒ±</small>`;
                    
                    // Show error placeholder
                    img.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgZmlsbD0iI2Y4ZjlmYSIvPjx0ZXh0IHg9IjUwIiB5PSI1MCIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjE0IiBmaWxsPSIjNmM3NTdkIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBkeT0iMC4zZW0iPkVycm9yPC90ZXh0Pjwvc3ZnPg==';
                    imgContainer.appendChild(img);
                    resolve(false);
                };
                
                img.src = url;
                
                // Timeout after 10 seconds
                setTimeout(() => {
                    if (statusEl.textContent === 'Test ediliyor...') {
                        statusEl.innerHTML = '‚è∞ Zaman a≈üƒ±mƒ± (10s+)';
                        resolve(false);
                    }
                }, 10000);
            });
        }

        // Preview chapter images
        async function previewImages() {
            const imageInputs = document.querySelectorAll('#image-inputs input');
            const urls = Array.from(imageInputs).map(input => input.value).filter(url => url);
            
            if (urls.length === 0) {
                showStatus('L√ºtfen en az bir g√∂rsel linki girin', 'error');
                return;
            }

            toggleLoading(true);
            
            const previewContainer = document.getElementById('preview-images-container');
            previewContainer.innerHTML = '';
            
            // Convert URLs to proxy format and display images
            for (let i = 0; i < urls.length; i++) {
                const fileId = extractFileId(urls[i]);
                
                if (fileId) {
                    const proxyUrl = createProxyUrl(fileId);
                    
                    const imgContainer = document.createElement('div');
                    imgContainer.style.cssText = 'margin: 10px; text-align: center; border: 1px solid #ddd; padding: 10px; border-radius: 5px;';
                    
                    const img = document.createElement('img');
                    img.className = 'preview-image';
                    img.alt = `Sayfa ${i + 1}`;
                    img.style.cssText = 'max-width: 150px; border: 2px solid #28a745; border-radius: 5px;';
                    
                    const label = document.createElement('p');
                    label.innerHTML = `<strong>Sayfa ${i + 1}</strong><br><small>Proxy URL</small>`;
                    
                    img.onload = function() {
                        img.style.borderColor = '#28a745';
                        label.innerHTML = `<strong>Sayfa ${i + 1} ‚úÖ</strong><br><small>${img.naturalWidth}x${img.naturalHeight}px</small>`;
                    };
                    
                    img.onerror = function() {
                        img.style.borderColor = '#dc3545';
                        img.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgeG1zbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgZmlsbD0iI2Y4ZjlmYSIvPjx0ZXh0IHg9IjUwIiB5PSI1MCIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjE0IiBmaWxsPSIjNmM3NTdkIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBkeT0iMC4zZW0iPkVycm9yPC90ZXh0Pjwvc3ZnPg==';
                        label.innerHTML = `<strong>Sayfa ${i + 1} ‚ùå</strong><br><small>Y√ºklenemedi</small>`;
                    };
                    
                    img.src = proxyUrl;
                    
                    imgContainer.appendChild(label);
                    imgContainer.appendChild(img);
                    previewContainer.appendChild(imgContainer);
                } else {
                    const errorDiv = document.createElement('div');
                    errorDiv.textContent = `Sayfa ${i + 1}: Ge√ßersiz Google Drive link`;
                    errorDiv.style.color = 'red';
                    previewContainer.appendChild(errorDiv);
                }
            }
            
            document.getElementById('images-preview').style.display = 'block';
            toggleLoading(false);
        }

        // Form submissions
        document.getElementById('series-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData);
            
            // Client-side validasyon
            if (!data.title || data.title.trim().length === 0) {
                showStatus('Seri ba≈ülƒ±ƒüƒ± gerekli', 'error');
                return;
            }
            
            if (!data.seriesId || data.seriesId.trim().length === 0) {
                showStatus('Seri ID gerekli', 'error');
                return;
            }
            
            // Seri ID normalize et (sadece alfanumerik karakterler)
            data.seriesId = data.seriesId.toLowerCase().replace(/[^a-z0-9]/g, '');
            
            if (data.seriesId.length < 3) {
                showStatus('Seri ID en az 3 karakter olmalƒ±', 'error');
                return;
            }
            
            if (!data.coverImageUrl || data.coverImageUrl.trim().length === 0) {
                showStatus('Kapak g√∂rseli gerekli', 'error');
                return;
            }
            
            // Google Drive link kontrol√º
            if (!data.coverImageUrl.includes('drive.google.com') || !data.coverImageUrl.includes('/file/d/')) {
                showStatus('Ge√ßerli bir Google Drive linki girin', 'error');
                return;
            }
            
            // Parse genre
            if (data.genre) {
                data.genre = data.genre.split(',').map(g => g.trim());
            }
            
            toggleLoading(true);
            
            try {
                const response = await fetch(`${API_BASE}/admin/create-series`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                const result = await response.json();
                
                if (result.success) {
                    showStatus('Seri ba≈üarƒ±yla olu≈üturuldu!', 'success');
                    e.target.reset();
                    document.getElementById('cover-preview').style.display = 'none';
                } else {
                    // Detaylƒ± hata mesajƒ± g√∂ster
                    let errorMessage = result.error || 'Seri olu≈üturulamadƒ±';
                    if (result.details && Array.isArray(result.details)) {
                        errorMessage += ':\n' + result.details.join('\n');
                    }
                    if (result.existingTitle) {
                        errorMessage += '\nMevcut seri: ' + result.existingTitle;
                    }
                    showStatus(errorMessage, 'error');
                }
            } catch (error) {
                showStatus('Baƒülantƒ± hatasƒ±', 'error');
                console.error('Series creation error:', error);
            }
            
            toggleLoading(false);
        });

        document.getElementById('chapter-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const imageInputs = document.querySelectorAll('#image-inputs input');
            const imageUrls = Array.from(imageInputs).map(input => input.value).filter(url => url);
            
            // Client-side validasyon
            if (!formData.get('seriesId') || formData.get('seriesId').trim().length === 0) {
                showStatus('Seri ID gerekli', 'error');
                return;
            }
            
            if (!formData.get('chapterNumber') || isNaN(parseInt(formData.get('chapterNumber')))) {
                showStatus('Ge√ßerli bir b√∂l√ºm numarasƒ± gerekli', 'error');
                return;
            }
            
            if (parseInt(formData.get('chapterNumber')) <= 0) {
                showStatus('B√∂l√ºm numarasƒ± 0\'dan b√ºy√ºk olmalƒ±', 'error');
                return;
            }
            
            if (imageUrls.length === 0) {
                showStatus('L√ºtfen en az bir g√∂rsel linki girin', 'error');
                return;
            }
            
            // Google Drive linklerini kontrol et
            for (let i = 0; i < imageUrls.length; i++) {
                const url = imageUrls[i];
                if (!url.includes('drive.google.com') || !url.includes('/file/d/')) {
                    showStatus(`${i + 1}. g√∂rsel i√ßin ge√ßerli bir Google Drive linki girin`, 'error');
                    return;
                }
            }
            
            const data = {
                seriesId: formData.get('seriesId').toLowerCase().replace(/[^a-z0-9]/g, ''),
                chapterNumber: parseInt(formData.get('chapterNumber')),
                title: formData.get('title') || `B√∂l√ºm ${formData.get('chapterNumber')}`,
                imageUrls: imageUrls
            };
            
            toggleLoading(true);
            
            try {
                const response = await fetch(`${API_BASE}/admin/create-chapter-with-images`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                const result = await response.json();
                
                if (result.success) {
                    showStatus(`B√∂l√ºm ba≈üarƒ±yla olu≈üturuldu! (${result.imageCount} g√∂rsel)`, 'success');
                    e.target.reset();
                    document.getElementById('image-inputs').innerHTML = `
                        <div class="image-input-item">
                            <input type="url" placeholder="Sayfa 1 Google Drive linki" required>
                            <button type="button" class="btn btn-danger btn-small" onclick="removeImageInput(this)">Sil</button>
                        </div>
                    `;
                    document.getElementById('images-preview').style.display = 'none';
                } else {
                    // Detaylƒ± hata mesajƒ± g√∂ster
                    let errorMessage = result.error || 'B√∂l√ºm olu≈üturulamadƒ±';
                    if (result.details && Array.isArray(result.details)) {
                        errorMessage += ':\n' + result.details.join('\n');
                    }
                    if (result.validIds && Array.isArray(result.validIds)) {
                        errorMessage += '\nGe√ßerli seri ID\'leri: ' + result.validIds.join(', ');
                    }
                    showStatus(errorMessage, 'error');
                }
            } catch (error) {
                showStatus('Baƒülantƒ± hatasƒ±', 'error');
                console.error('Chapter creation error:', error);
            }
            
            toggleLoading(false);
        });

        document.getElementById('validate-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const driveUrl = formData.get('driveUrl');
            
            toggleLoading(true);
            
            try {
                const response = await fetch(`${API_BASE}/admin/validate-drive-link`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${getAuthToken()}`
                    },
                    body: JSON.stringify({ driveUrl })
                });

                const result = await response.json();
                
                const resultDiv = document.getElementById('validation-details');
                resultDiv.innerHTML = `
                    <p><strong>Ge√ßerli:</strong> ${result.isValid ? '‚úÖ Evet' : '‚ùå Hayƒ±r'}</p>
                    <p><strong>Direct URL:</strong> <a href="${result.directUrl}" target="_blank">${result.directUrl}</a></p>
                    <p><strong>Thumbnail URL:</strong> <a href="${result.thumbnailUrl}" target="_blank">${result.thumbnailUrl}</a></p>
                    ${result.isValid ? `<img src="${result.directUrl}" class="preview-image" style="max-width: 300px; margin-top: 15px;">` : ''}
                `;
                
                document.getElementById('validation-result').style.display = 'block';
                
                showStatus(result.isValid ? 'Link ge√ßerli!' : 'Link ge√ßersiz!', result.isValid ? 'success' : 'error');
            } catch (error) {
                showStatus('Doƒürulama hatasƒ±', 'error');
                console.error('Validation error:', error);
            }
            
            toggleLoading(false);
        });

        // Auto-generate series ID from title
        document.getElementById('series-title').addEventListener('input', (e) => {
            const title = e.target.value;
            const seriesId = title.toLowerCase()
                .replace(/[^a-z0-9\s]/g, '')
                .replace(/\s+/g, '');
            document.getElementById('series-id').value = seriesId;
        });

        // B√∂l√ºm Y√∂netimi Fonksiyonlarƒ±
        async function loadSeriesList() {
            try {
                const response = await fetch(`${API_BASE}/admin/series-list`);
                const series = await response.json();
                
                const select = document.getElementById('manage-series');
                select.innerHTML = '<option value="">-- Seri Se√ßin --</option>';
                
                series.forEach(s => {
                    const option = document.createElement('option');
                    option.value = s.seriesId;
                    option.textContent = `${s.title} (${s.chapterCount} b√∂l√ºm)`;
                    select.appendChild(option);
                });
                
            } catch (error) {
                showStatus('Seriler y√ºklenirken hata olu≈ütu', 'error');
                console.error('Load series error:', error);
            }
        }

        // Yeni B√∂l√ºm Ekleme i√ßin serileri y√ºkle
        async function loadChapterSeriesList() {
            try {
                const response = await fetch(`${API_BASE}/admin/series-list`);
                const series = await response.json();
                
                const select = document.getElementById('chapter-series');
                select.innerHTML = '<option value="">-- Seri Se√ßin --</option>';
                
                series.forEach(s => {
                    const option = document.createElement('option');
                    option.value = s.seriesId;
                    option.textContent = `${s.title} (${s.chapterCount} b√∂l√ºm)`;
                    select.appendChild(option);
                });
                
            } catch (error) {
                showStatus('Seriler y√ºklenirken hata olu≈ütu', 'error');
                console.error('Load chapter series error:', error);
            }
        }

        async function loadSeriesChapters(seriesId) {
            if (!seriesId) {
                document.getElementById('chapters-list-container').style.display = 'none';
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/admin/series/${seriesId}/chapters`);
                const data = await response.json();
                
                if (data.success) {
                    displayChaptersList(data.chapters, seriesId);
                    document.getElementById('chapters-list-container').style.display = 'block';
                } else {
                    showStatus('B√∂l√ºmler y√ºklenirken hata olu≈ütu', 'error');
                }
                
            } catch (error) {
                showStatus('B√∂l√ºmler y√ºklenirken hata olu≈ütu', 'error');
                console.error('Load chapters error:', error);
            }
        }

        function displayChaptersList(chapters, seriesId) {
            const container = document.getElementById('chapters-list');
            
            if (!chapters || chapters.length === 0) {
                container.innerHTML = '<p class="no-chapters">Bu seride hen√ºz b√∂l√ºm yok.</p>';
                return;
            }

            const chaptersHtml = chapters.map(chapter => `
                <div class="chapter-card">
                    <h4>B√∂l√ºm ${chapter.number}: ${chapter.title || 'Ba≈ülƒ±ksƒ±z'}</h4>
                    <div class="chapter-info">
                        üìÖ ${new Date(chapter.uploadDate).toLocaleDateString('tr-TR')}<br>
                        üñºÔ∏è ${chapter.imageCount} g√∂rsel<br>
                        üìÅ ${chapter.filename}
                    </div>
                    <div class="chapter-actions">
                        <button class="btn btn-small" onclick="editChapter('${seriesId}', ${chapter.number})">‚úèÔ∏è D√ºzenle</button>
                        <button class="btn btn-danger btn-small" onclick="confirmDeleteChapter('${seriesId}', ${chapter.number})">üóëÔ∏è Sil</button>
                    </div>
                </div>
            `).join('');

            container.innerHTML = `<div class="chapters-grid">${chaptersHtml}</div>`;
        }

        async function editChapter(seriesId, chapterNumber) {
            try {
                const response = await fetch(`${API_BASE}/admin/series/${seriesId}/chapters/${chapterNumber}`);
                const data = await response.json();
                
                if (data.success) {
                    showEditForm(data.chapter, seriesId);
                } else {
                    showStatus('B√∂l√ºm bilgileri alƒ±namadƒ±', 'error');
                }
                
            } catch (error) {
                showStatus('B√∂l√ºm bilgileri alƒ±nƒ±rken hata olu≈ütu', 'error');
                console.error('Edit chapter error:', error);
            }
        }

        function showEditForm(chapter, seriesId) {
            document.getElementById('edit-series-id').value = seriesId;
            document.getElementById('edit-chapter-original-number').value = chapter.number;
            document.getElementById('edit-chapter-number').value = chapter.number;
            document.getElementById('edit-chapter-title').value = chapter.title || '';
            
            // G√∂rsel URL'lerini y√ºkle
            const imageContainer = document.getElementById('edit-image-inputs');
            imageContainer.innerHTML = '';
            
            if (chapter.imageUrls && chapter.imageUrls.length > 0) {
                chapter.imageUrls.forEach((url, index) => {
                    addEditImageInput(url);
                });
            } else {
                addEditImageInput();
            }
            
            document.getElementById('chapter-edit-form').style.display = 'block';
            document.getElementById('chapter-edit-form').scrollIntoView({ behavior: 'smooth' });
        }

        function addEditImageInput(url = '') {
            const container = document.getElementById('edit-image-inputs');
            const inputCount = container.children.length;
            
            const newInputDiv = document.createElement('div');
            newInputDiv.className = 'edit-image-input-item';
            newInputDiv.innerHTML = `
                <input type="url" placeholder="Sayfa ${inputCount + 1} Google Drive linki" value="${url}" oninput="updateImagePreview(this)">
                <button type="button" class="btn btn-danger btn-small" onclick="removeEditImageInput(this)">Sil</button>
                <img src="${url ? getPreviewUrl(url) : ''}" class="image-preview" style="max-width:60px; max-height:60px; vertical-align:middle; margin-left:8px; display:${url ? 'inline-block' : 'none'};" onclick="showImageModal(this.src)" title="√ñnizle">
            `;
            container.appendChild(newInputDiv);
        }

        function getPreviewUrl(url) {
            // Google Drive linkinden fileId √ßƒ±karƒ±p thumbnail olu≈ütur
            const fileId = extractFileId(url);
            if (fileId) {
                return `https://drive.google.com/thumbnail?id=${fileId}&sz=s400`;
            }
            return url;
        }

        function updateImagePreview(input) {
            const url = input.value;
            const img = input.parentElement.querySelector('.image-preview');
            if (url) {
                img.src = getPreviewUrl(url);
                img.style.display = 'inline-block';
            } else {
                img.src = '';
                img.style.display = 'none';
            }
        }

        function showImageModal(src) {
            // Basit modal: yeni sekmede a√ß
            window.open(src, '_blank');
        }

        function cancelEdit() {
            document.getElementById('chapter-edit-form').style.display = 'none';
        }

        async function confirmDeleteChapter(seriesId, chapterNumber) {
            if (confirm(`B√∂l√ºm ${chapterNumber}'√º silmek istediƒüinizden emin misiniz? Bu i≈ülem geri alƒ±namaz.`)) {
                await deleteChapterConfirmed(seriesId, chapterNumber);
            }
        }

        async function deleteChapterConfirmed(seriesId, chapterNumber) {
            toggleLoading(true);
            
            try {
                const response = await fetch(`${API_BASE}/moderator/delete-chapter/${seriesId}/${chapterNumber}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }
                
                const result = await response.json();
                
                if (result.success) {
                    showStatus('B√∂l√ºm ba≈üarƒ±yla silindi!', 'success');
                    loadSeriesChapters(seriesId); // Listeyi yenile
                } else {
                    showStatus(result.error || 'B√∂l√ºm silinemedi', 'error');
                }
            } catch (error) {
                showStatus('B√∂l√ºm silinirken hata olu≈ütu', 'error');
                console.error('Delete chapter error:', error);
            }
            
            toggleLoading(false);
        }

        async function deleteChapter() {
            const seriesId = document.getElementById('edit-series-id').value;
            const chapterNumber = document.getElementById('edit-chapter-original-number').value;
            await confirmDeleteChapter(seriesId, chapterNumber);
        }

        // Edit Chapter Form Submit
        document.getElementById('edit-chapter-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const imageInputs = document.querySelectorAll('#edit-image-inputs input');
            const imageUrls = Array.from(imageInputs).map(input => input.value).filter(url => url);
            
            if (imageUrls.length === 0) {
                showStatus('L√ºtfen en az bir g√∂rsel linki girin', 'error');
                return;
            }
            
            const data = {
                seriesId: document.getElementById('edit-series-id').value,
                originalChapterNumber: document.getElementById('edit-chapter-original-number').value,
                newChapterNumber: document.getElementById('edit-chapter-number').value,
                title: document.getElementById('edit-chapter-title').value,
                imageUrls: imageUrls
            };
            
            toggleLoading(true);
            
            try {
                const response = await fetch(`${API_BASE}/admin/update-chapter`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                const result = await response.json();
                
                if (result.success) {
                    showStatus('B√∂l√ºm ba≈üarƒ±yla g√ºncellendi!', 'success');
                    cancelEdit();
                    loadSeriesChapters(data.seriesId); // Listeyi yenile
                } else {
                    showStatus(result.error || 'B√∂l√ºm g√ºncellenemedi', 'error');
                }
            } catch (error) {
                showStatus('Baƒülantƒ± hatasƒ±', 'error');
                console.error('Update chapter error:', error);
            }
        });

        // Seri Silme Fonksiyonlarƒ±
        document.getElementById('confirm-delete').addEventListener('input', function() {
            const deleteBtn = document.getElementById('delete-btn');
            deleteBtn.disabled = this.value !== 'Sƒ∞L';
        });

        async function deleteSeries() {
            const seriesId = document.getElementById('delete-series').value;
            const confirmText = document.getElementById('confirm-delete').value.toUpperCase();
            if (!seriesId) {
                showStatus('L√ºtfen silinecek seriyi se√ßin', 'error');
                return;
            }
            if (confirmText !== 'Sƒ∞L') {
                showStatus('Silme i≈ülemini onaylamak i√ßin "Sƒ∞L" yazƒ±n', 'error');
                return;
            }
            const seriesTitle = document.getElementById('delete-series').selectedOptions[0].textContent;
            if (!confirm(`"${seriesTitle}" serisini silmek istediƒüinizden emin misiniz? Bu i≈ülem geri alƒ±namaz!`)) {
                return;
            }
            toggleLoading(true);
            document.getElementById('delete-result').style.display = 'none';
            try {
                // Eƒüer backend auth isterse token ekleyin:
                // const token = getAuthToken();
                const response = await fetch(`${API_BASE}/admin/series/${seriesId}`, {
                    method: 'DELETE',
                    // headers: { 'Authorization': `Bearer ${token}` }
                });
                let result;
                try {
                    result = await response.json();
                } catch (jsonErr) {
                    showStatus('Sunucudan ge√ßersiz yanƒ±t alƒ±ndƒ±', 'error');
                    toggleLoading(false);
                    return;
                }
                if (result && (result.success || result.message)) {
                    showStatus(result.message || 'Seri ba≈üarƒ±yla silindi!', 'success');
                    document.getElementById('delete-series').value = '';
                    document.getElementById('confirm-delete').value = '';
                    document.getElementById('delete-btn').disabled = true;
                    document.getElementById('delete-btn').style.opacity = '0.5';
                    const resultDiv = document.getElementById('delete-result');
                    const detailsDiv = document.getElementById('delete-details');
                    detailsDiv.innerHTML = `
                        <div style="color: green;">
                            <strong>‚úÖ Ba≈üarƒ±yla silindi:</strong><br>
                            üìö Seri ID: ${seriesId}<br>
                            üìÅ Klas√∂rler ve dosyalar temizlendi<br>
                            üóÑÔ∏è Veritabanƒ± kayƒ±tlarƒ± silindi
                        </div>
                    `;
                    resultDiv.style.display = 'block';
                    loadDeleteSeriesList();
                } else {
                    showStatus(result && result.error ? result.error : 'Seri silinemedi', 'error');
                }
            } catch (error) {
                showStatus(`Seri silinirken hata olu≈ütu: ${error.message}`, 'error');
            }
            toggleLoading(false);
        }

        // Delete tab i√ßin serileri y√ºkle
        async function loadDeleteSeriesList() {
            try {
                console.log('Loading series list...');
                const response = await fetch('data/manhwalar.json');
                console.log('Response status:', response.status);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const seriesList = await response.json();
                console.log('Series loaded:', seriesList.length);
                
                const selectElement = document.getElementById('delete-series');
                selectElement.innerHTML = '<option value="">-- Seri Se√ßin --</option>';
                
                seriesList.forEach(series => {
                    const option = document.createElement('option');
                    option.value = series.seriesId;
                    option.textContent = `${series.title} (${series.seriesId})`;
                    selectElement.appendChild(option);
                });
                
                console.log('Series list loaded successfully');
            } catch (error) {
                console.error('Error loading series list:', error);
                showStatus(`Seri listesi y√ºklenirken hata olu≈ütu: ${error.message}`, 'error');
            }
        }

        // Silme onayƒ± kontrol√º
        document.getElementById('confirm-delete').addEventListener('input', function() {
            const confirmText = this.value.toUpperCase();
            const deleteBtn = document.getElementById('delete-btn');
            const seriesSelected = document.getElementById('delete-series').value;
            
            if (confirmText === 'Sƒ∞L' && seriesSelected) {
                deleteBtn.disabled = false;
                deleteBtn.style.opacity = '1';
            } else {
                deleteBtn.disabled = true;
                deleteBtn.style.opacity = '0.5';
            }
        });

        // Seri D√ºzenleme Fonksiyonlarƒ±
        
        // Edit sekmesi i√ßin seri listesini y√ºkle
        async function loadEditSeriesList() {
            try {
                const response = await fetch('http://localhost:5506/client/data/manhwalar.json');
                const series = await response.json();
                
                const select = document.getElementById('edit-series-select');
                select.innerHTML = '<option value="">-- Seri Se√ßin --</option>';
                
                series.forEach(serie => {
                    const option = document.createElement('option');
                    option.value = serie.seriesId;
                    option.textContent = serie.title;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Seri listesi y√ºklenirken hata:', error);
                showStatus('Seri listesi y√ºklenemedi', 'error');
            }
        }

        // Etiket ayarlarƒ± g√∂r√ºn√ºrl√ºk kontrol√º
        function toggleLabelSettings() {
            const labelValue = document.getElementById('edit-series-label-enabled').value;
            const labelSettings = document.getElementById('label-settings');
            
            // Sadece "true" (Etiketi G√∂ster) durumunda ayarlarƒ± g√∂ster
            labelSettings.style.display = labelValue === 'true' ? 'block' : 'none';
            updateLabelPreview();
        }

        // Etiket √∂nizleme g√ºncelleme
        function updateLabelPreview() {
            const labelValue = document.getElementById('edit-series-label-enabled').value;
            const text = document.getElementById('edit-series-label-text').value;
            const color = document.getElementById('edit-series-label-color').value;
            const preview = document.getElementById('label-preview-badge');
            
            if (labelValue === 'true') {
                // Etiketi g√∂ster
                preview.textContent = text;
                preview.style.background = color;
                preview.style.display = 'inline-block';
            } else if (labelValue === 'false') {
                // Etiket var ama gizli (√∂nizlemede g√∂ster ama soluk)
                preview.textContent = text + ' (Gizli)';
                preview.style.background = color;
                preview.style.opacity = '0.5';
                preview.style.display = 'inline-block';
            } else {
                // Etiket yok
                preview.style.display = 'none';
                preview.style.opacity = '1';
            }
        }

        // Se√ßilen seriyi d√ºzenleme formuna y√ºkle
        async function loadSeriesForEdit() {
            const seriesId = document.getElementById('edit-series-select').value;
            const formContainer = document.getElementById('edit-series-form-container');
            
            if (!seriesId) {
                formContainer.style.display = 'none';
                return;
            }

            try {
                const response = await fetch('http://localhost:5506/client/data/manhwalar.json');
                const series = await response.json();
                const selectedSeries = series.find(s => s.seriesId === seriesId);

                if (!selectedSeries) {
                    showStatus('Seri bulunamadƒ±', 'error');
                    return;
                }

                // Form alanlarƒ±nƒ± doldur
                document.getElementById('edit-series-title').value = selectedSeries.title || '';
                document.getElementById('edit-series-status').value = selectedSeries.status || 'Devam Ediyor';
                document.getElementById('edit-series-summary').value = selectedSeries.summary || '';
                document.getElementById('edit-series-cover').value = selectedSeries.image || '';
                document.getElementById('edit-series-author').value = selectedSeries.author || '';
                document.getElementById('edit-series-artist').value = selectedSeries.artist || '';
                document.getElementById('edit-series-publisher').value = selectedSeries.publisher || '';
                
                // Genres array'ini virg√ºlle ayrƒ±lmƒ±≈ü string'e √ßevir
                const genresString = selectedSeries.genres ? selectedSeries.genres.join(', ') : '';
                document.getElementById('edit-series-genres').value = genresString;

                // Etiket bilgilerini y√ºkle
                const label = selectedSeries.label;
                let labelStatus = 'none'; // Varsayƒ±lan: Etiket yok
                
                if (label) {
                    if (label.enabled === true) {
                        labelStatus = 'true'; // Etiketi g√∂ster
                    } else if (label.enabled === false) {
                        labelStatus = 'false'; // Etiketi gizle
                    }
                    // Etiket var ise text ve color'ƒ± y√ºkle
                    document.getElementById('edit-series-label-text').value = label.text || 'Yeni';
                    document.getElementById('edit-series-label-color').value = label.color || '#4CAF50';
                } else {
                    // Etiket yok ise varsayƒ±lan deƒüerler
                    document.getElementById('edit-series-label-text').value = 'Yeni';
                    document.getElementById('edit-series-label-color').value = '#4CAF50';
                }
                
                document.getElementById('edit-series-label-enabled').value = labelStatus;
                toggleLabelSettings();

                // Kapak √∂nizlemesini g√∂ster
                if (selectedSeries.image) {
                    document.getElementById('edit-preview-image').src = selectedSeries.image;
                    document.getElementById('edit-cover-preview').style.display = 'block';
                }

            formContainer.style.display = 'block';
        } catch (error) {
            console.error('Seri y√ºklenirken hata:', error);
            showStatus('Seri bilgileri y√ºklenemedi', 'error');
        }

        // Kapak g√∂rselini doƒürula (d√ºzenleme formu i√ßin)
        function validateEditCoverImage() {
            const url = document.getElementById('edit-series-cover').value;
            const previewContainer = document.getElementById('edit-cover-preview');
            const previewImage = document.getElementById('edit-preview-image');

            if (!url) {
                showStatus('L√ºtfen bir g√∂rsel URL\'si girin', 'error');
                previewContainer.style.display = 'none';
                return;
            }

            // Google Drive linkini proxy URL'ye d√∂n√º≈üt√ºr
            let imageUrl = url;
            const driveMatch = url.match(/\/file\/d\/([a-zA-Z0-9_-]+)/);
            if (driveMatch) {
                const fileId = driveMatch[1];
                imageUrl = `http://localhost:5506/api/image/proxy-image/${fileId}`;
            }

            // Loading g√∂ster
            previewImage.src = '';
            previewContainer.style.display = 'block';
            previewImage.style.display = 'none';
            
            // Temporary loading message
            const loadingMsg = document.createElement('div');
            loadingMsg.innerHTML = 'üîÑ G√∂rsel y√ºkleniyor...';
            loadingMsg.style.padding = '20px';
            loadingMsg.style.textAlign = 'center';
            loadingMsg.id = 'temp-loading';
            previewContainer.appendChild(loadingMsg);

            previewImage.onload = function() {
                const tempLoading = document.getElementById('temp-loading');
                if (tempLoading) tempLoading.remove();
                
                previewImage.style.display = 'block';
                showStatus('G√∂rsel ba≈üarƒ±yla y√ºklendi', 'success');
            };
            
            previewImage.onerror = function() {
                const tempLoading = document.getElementById('temp-loading');
                if (tempLoading) tempLoading.remove();
                
                previewContainer.style.display = 'none';
                showStatus('G√∂rsel y√ºklenemedi. URL\'yi kontrol edin', 'error');
            };
            
            previewImage.src = imageUrl;
        }

        // D√ºzenleme formunu temizle ve gizle
        function cancelEdit() {
            document.getElementById('edit-series-select').value = '';
            document.getElementById('edit-series-form-container').style.display = 'none';
            document.getElementById('edit-cover-preview').style.display = 'none';
            document.getElementById('edit-series-form').reset();
        }

        // Seri d√ºzenleme form submit
        document.getElementById('edit-series-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const seriesId = document.getElementById('edit-series-select').value;
            if (!seriesId) {
                showStatus('L√ºtfen bir seri se√ßin', 'error');
                return;
            }

            // Loading g√∂ster
            showLoading(true);
            
            // Status mesajƒ±nƒ± temizle
            const statusDiv = document.getElementById('status-message');
            statusDiv.style.display = 'none';

            try {
                // Form verilerini manuel olarak topla
                const editData = {
                    seriesId: seriesId,
                    title: document.getElementById('edit-series-title').value,
                    status: document.getElementById('edit-series-status').value,
                    summary: document.getElementById('edit-series-summary').value,
                    image: document.getElementById('edit-series-cover').value,
                    author: document.getElementById('edit-series-author').value,
                    artist: document.getElementById('edit-series-artist').value,
                    publisher: document.getElementById('edit-series-publisher').value,
                    genres: document.getElementById('edit-series-genres').value.split(',').map(g => g.trim()).filter(g => g)
                };

                // Etiket i≈üleme
                const labelValue = document.getElementById('edit-series-label-enabled').value;
                if (labelValue === 'none') {
                    // Etiket tamamen kaldƒ±r
                    editData.removeLabel = true;
                } else {
                    // Etiket ekle/g√ºncelle
                    editData.label = {
                        enabled: labelValue === 'true',
                        text: document.getElementById('edit-series-label-text').value,
                        color: document.getElementById('edit-series-label-color').value
                    };
                }

                // Zorunlu alanlarƒ± kontrol et
                if (!editData.title || !editData.status || !editData.image) {
                    showLoading(false);
                    showStatus('L√ºtfen t√ºm zorunlu alanlarƒ± doldurun (Ba≈ülƒ±k, Durum, Kapak G√∂rseli)', 'error');
                    return;
                }

                // Google Drive linkini proxy URL'ye d√∂n√º≈üt√ºr
                const driveMatch = editData.image.match(/\/file\/d\/([a-zA-Z0-9_-]+)/);
                if (driveMatch) {
                    const fileId = driveMatch[1];
                    editData.image = `http://localhost:5506/api/image/proxy-image/${fileId}`;
                }

                console.log('G√∂nderilen veri:', editData); // Debug i√ßin

                const response = await fetch('http://localhost:5506/api/manhwa/edit', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(editData)
                });

                const result = await response.json();
                console.log('Sunucu yanƒ±tƒ±:', result); // Debug i√ßin

                if (response.ok) {
                    showStatus('Seri ba≈üarƒ±yla g√ºncellendi!', 'success');
                    // Edit sekmesindeki seri listesini yenile
                    loadEditSeriesList();
                    // Se√ßili seriyi yeniden y√ºkle
                    loadSeriesForEdit();
                } else {
                    showStatus(result.error || 'Seri g√ºncellenirken hata olu≈ütu', 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showStatus('Beklenmeyen bir hata olu≈ütu: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        });

        // G√∂rsel URL alanƒ±nda deƒüi≈üiklik olduƒüunda otomatik √∂nizleme
        document.getElementById('edit-series-cover').addEventListener('input', function() {
            // 1 saniye bekle sonra otomatik doƒürula
            clearTimeout(this.previewTimeout);
            this.previewTimeout = setTimeout(() => {
                if (this.value.trim()) {
                    validateEditCoverImage();
                }
            }, 1000);
        });

        // Seri se√ßimi deƒüi≈ütiƒüinde onay kontrol√º
        document.getElementById('delete-series').addEventListener('change', function() {
            const confirmText = document.getElementById('confirm-delete').value.toUpperCase();
            const deleteBtn = document.getElementById('delete-btn');
            
            if (confirmText === 'Sƒ∞L' && this.value) {
                deleteBtn.disabled = false;
                deleteBtn.style.opacity = '1';
            } else {
                deleteBtn.disabled = true;
                deleteBtn.style.opacity = '0.5';
            }
        });

        // ===== KULLANICI Y√ñNETƒ∞Mƒ∞ FONKSƒ∞YONLARI =====
        
        // let allUsers = []; // Removed duplicate declaration

        // Kullanƒ±cƒ±larƒ± y√ºkle
        async function loadUsers() {
            try {
                console.log('Kullanƒ±cƒ±larƒ± y√ºklemeye √ßalƒ±≈üƒ±yor...');

                // Test endpoint kullan (ge√ßici √ß√∂z√ºm)
                const response = await fetch('http://localhost:5506/api/admin/test-users', {
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                console.log('Response status:', response.status);
                console.log('Response ok:', response.ok);

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Server error response:', errorText);
                    throw new Error(`Server error ${response.status}: ${errorText}`);
                }

                const data = await response.json();
                console.log('Response data:', JSON.stringify(data, null, 2));
                
                // API direkt kullanƒ±cƒ± array'i d√∂nd√ºr√ºyor
                if (Array.isArray(data)) {
                    allUsers = data;
                    renderUsers(allUsers);
                    updateUserStats(allUsers);
                } else if (data.success) {
                    allUsers = data.users;
                    renderUsers(allUsers);
                    updateUserStats(allUsers);
                } else {
                    throw new Error(data.error || data.details || 'Kullanƒ±cƒ±lar y√ºklenemedi');
                }
            } catch (error) {
                console.error('Kullanƒ±cƒ±larƒ± y√ºkleme hatasƒ±:', error);
                document.getElementById('users-loading').innerHTML = `
                    <div style="color: #dc3545; font-size: 16px;">
                        ‚ùå Kullanƒ±cƒ±lar y√ºklenemedi: ${error.message}
                        <br><small>Detaylar i√ßin tarayƒ±cƒ± console'unu kontrol edin.</small>
                    </div>
                `;
            }
        }

        // Kullanƒ±cƒ± istatistiklerini g√ºncelle
        function updateUserStats(users) {
            const totalUsers = users.length;
            const adminUsers = users.filter(u => u.isAdmin).length;
            const moderatorUsers = users.filter(u => u.isModerator).length;
            const blockedUsers = users.filter(u => u.isBlocked).length;

            document.getElementById('total-users-count').textContent = totalUsers;
            document.getElementById('admin-users-count').textContent = adminUsers;
            document.getElementById('moderator-users-count').textContent = moderatorUsers;
            document.getElementById('blocked-users-count').textContent = blockedUsers;
        }

        // Kullanƒ±cƒ±larƒ± render et
        function renderUsers(users) {
            const container = document.getElementById('users-list');
            const loadingDiv = document.getElementById('users-loading');
            
            loadingDiv.style.display = 'none';
            container.style.display = 'block';

            if (users.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: #666; padding: 40px;">Kullanƒ±cƒ± bulunamadƒ±</div>';
                return;
            }

            const usersHTML = users.map(user => {
                const statusBadges = [];
                if (user.isAdmin) statusBadges.push('<span style="background: #28a745; color: white; padding: 4px 8px; border-radius: 12px; font-size: 12px; margin-left: 8px;">Admin</span>');
                if (user.isModerator) statusBadges.push('<span style="background: #ffc107; color: black; padding: 4px 8px; border-radius: 12px; font-size: 12px; margin-left: 8px;">Moderat√∂r</span>');
                if (user.isBlocked) statusBadges.push('<span style="background: #dc3545; color: white; padding: 4px 8px; border-radius: 12px; font-size: 12px; margin-left: 8px;">Engelli</span>');
                
                return `
                    <div class="user-card" style="background: #f8f9fa; border-radius: 10px; padding: 20px; margin-bottom: 15px; border-left: 4px solid ${user.isAdmin ? '#28a745' : user.isModerator ? '#ffc107' : user.isBlocked ? '#dc3545' : '#667eea'};">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <h4 style="margin-bottom: 8px;">
                                    üë§ ${user.username}
                                    ${statusBadges.join('')}
                                </h4>
                                <p style="margin: 5px 0; color: #666; font-size: 0.9rem;">
                                    üìß ${user.email}
                                </p>
                                <div style="font-size: 14px; color: #888;">
                                    <span>üìÖ Kayƒ±t: ${new Date(user.createdAt).toLocaleDateString('tr-TR')}</span>
                                    <span style="margin-left: 20px;">‚≠ê ${user.ratings ? user.ratings.length : 0} puan</span>
                                    <span style="margin-left: 20px;">‚ù§Ô∏è ${user.favorites ? user.favorites.length : 0} favori</span>
                                    <span style="margin-left: 20px;">üìñ ${user.readSeries ? user.readSeries.length : 0} okunan</span>
                                    ${user.isModerator ? `<span style="margin-left: 20px;">üõ°Ô∏è ${user.moderatorSeries ? user.moderatorSeries.length : 0} seri</span>` : ''}
                                </div>
                            </div>
                            <div style="display: flex; gap: 10px;">
                                <button onclick="viewUserDetails('${user._id}')" style="background: #17a2b8; color: white; border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer;">üëÅÔ∏è Detay</button>
                                <button onclick="toggleUserAdmin('${user._id}', ${!user.isAdmin})" 
                                        style="background: ${user.isAdmin ? '#6c757d' : '#28a745'}; color: white; border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer;">
                                    ${user.isAdmin ? 'üë§ Admin Al' : '‚≠ê Admin Yap'}
                                </button>
                                <button onclick="toggleUserBlock('${user._id}', ${!user.isBlocked})" 
                                        style="background: ${user.isBlocked ? '#28a745' : '#ffc107'}; color: ${user.isBlocked ? 'white' : 'black'}; border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer;">
                                    ${user.isBlocked ? '‚úÖ Engel Kaldƒ±r' : 'üö´ Engelle'}
                                </button>
                                <button onclick="deleteUser('${user._id}', '${user.username}')" style="background: #dc3545; color: white; border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer;">üóëÔ∏è Sil</button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = usersHTML;
        }

        async function deleteChapterConfirmed(seriesId, chapterNumber) {
            toggleLoading(true);
            
            try {
                const response = await fetch(`${API_BASE}/moderator/delete-chapter/${seriesId}/${chapterNumber}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }
                
                const result = await response.json();
                
                if (result.success) {
                    showStatus('B√∂l√ºm ba≈üarƒ±yla silindi!', 'success');
                    loadSeriesChapters(seriesId); // Listeyi yenile
                } else {
                    showStatus(result.error || 'B√∂l√ºm silinemedi', 'error');
                }
            } catch (error) {
                showStatus('B√∂l√ºm silinirken hata olu≈ütu', 'error');
                console.error('Delete chapter error:', error);
            }
            
            toggleLoading(false);
        }

        async function deleteChapter() {
            const seriesId = document.getElementById('edit-series-id').value;
            const chapterNumber = document.getElementById('edit-chapter-original-number').value;
            await confirmDeleteChapter(seriesId, chapterNumber);
        }

        // Edit Chapter Form Submit
        document.getElementById('edit-chapter-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const imageInputs = document.querySelectorAll('#edit-image-inputs input');
            const imageUrls = Array.from(imageInputs).map(input => input.value).filter(url => url);
            
            if (imageUrls.length === 0) {
                showStatus('L√ºtfen en az bir g√∂rsel linki girin', 'error');
                return;
            }
            
            const data = {
                seriesId: document.getElementById('edit-series-id').value,
                originalChapterNumber: document.getElementById('edit-chapter-original-number').value,
                newChapterNumber: document.getElementById('edit-chapter-number').value,
                title: document.getElementById('edit-chapter-title').value,
                imageUrls: imageUrls
            };
            
            toggleLoading(true);
            
            try {
                const response = await fetch(`${API_BASE}/admin/update-chapter`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                const result = await response.json();
                
                if (result.success) {
                    showStatus('B√∂l√ºm ba≈üarƒ±yla g√ºncellendi!', 'success');
                    cancelEdit();
                    loadSeriesChapters(data.seriesId); // Listeyi yenile
                } else {
                    showStatus(result.error || 'B√∂l√ºm g√ºncellenemedi', 'error');
                }
            } catch (error) {
                showStatus('Baƒülantƒ± hatasƒ±', 'error');
                console.error('Update chapter error:', error);
            }
        });

        // Seri Silme Fonksiyonlarƒ±
        document.getElementById('confirm-delete').addEventListener('input', function() {
            const deleteBtn = document.getElementById('delete-btn');
            deleteBtn.disabled = this.value !== 'Sƒ∞L';
        });

        async function deleteSeries() {
            const seriesId = document.getElementById('delete-series').value;
            const confirmText = document.getElementById('confirm-delete').value.toUpperCase();
            if (!seriesId) {
                showStatus('L√ºtfen silinecek seriyi se√ßin', 'error');
                return;
            }
            if (confirmText !== 'Sƒ∞L') {
                showStatus('Silme i≈ülemini onaylamak i√ßin "Sƒ∞L" yazƒ±n', 'error');
                return;
            }
            const seriesTitle = document.getElementById('delete-series').selectedOptions[0].textContent;
            if (!confirm(`"${seriesTitle}" serisini silmek istediƒüinizden emin misiniz? Bu i≈ülem geri alƒ±namaz!`)) {
                return;
            }
            toggleLoading(true);
            document.getElementById('delete-result').style.display = 'none';
            try {
                // Eƒüer backend auth isterse token ekleyin:
                // const token = getAuthToken();
                const response = await fetch(`${API_BASE}/admin/series/${seriesId}`, {
                    method: 'DELETE',
                    // headers: { 'Authorization': `Bearer ${token}` }
                });
                let result;
                try {
                    result = await response.json();
                } catch (jsonErr) {
                    showStatus('Sunucudan ge√ßersiz yanƒ±t alƒ±ndƒ±', 'error');
                    toggleLoading(false);
                    return;
                }
                if (result && (result.success || result.message)) {
                    showStatus(result.message || 'Seri ba≈üarƒ±yla silindi!', 'success');
                    document.getElementById('delete-series').value = '';
                    document.getElementById('confirm-delete').value = '';
                    document.getElementById('delete-btn').disabled = true;
                    document.getElementById('delete-btn').style.opacity = '0.5';
                    const resultDiv = document.getElementById('delete-result');
                    const detailsDiv = document.getElementById('delete-details');
                    detailsDiv.innerHTML = `
                        <div style="color: green;">
                            <strong>‚úÖ Ba≈üarƒ±yla silindi:</strong><br>
                            üìö Seri ID: ${seriesId}<br>
                            üìÅ Klas√∂rler ve dosyalar temizlendi<br>
                            üóÑÔ∏è Veritabanƒ± kayƒ±tlarƒ± silindi
                        </div>
                    `;
                    resultDiv.style.display = 'block';
                    loadDeleteSeriesList();
                } else {
                    showStatus(result && result.error ? result.error : 'Seri silinemedi', 'error');
                }
            } catch (error) {
                showStatus(`Seri silinirken hata olu≈ütu: ${error.message}`, 'error');
            }
            toggleLoading(false);
        }

        // Delete tab i√ßin serileri y√ºkle
        async function loadDeleteSeriesList() {
            try {
                console.log('Loading series list...');
                const response = await fetch('data/manhwalar.json');
                console.log('Response status:', response.status);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const seriesList = await response.json();
                console.log('Series loaded:', seriesList.length);
                
                const selectElement = document.getElementById('delete-series');
                selectElement.innerHTML = '<option value="">-- Seri Se√ßin --</option>';
                
                seriesList.forEach(series => {
                    const option = document.createElement('option');
                    option.value = series.seriesId;
                    option.textContent = `${series.title} (${series.seriesId})`;
                    selectElement.appendChild(option);
                });
                
                console.log('Series list loaded successfully');
            } catch (error) {
                console.error('Error loading series list:', error);
                showStatus(`Seri listesi y√ºklenirken hata olu≈ütu: ${error.message}`, 'error');
            }
        }

        // Silme onayƒ± kontrol√º
        document.getElementById('confirm-delete').addEventListener('input', function() {
            const confirmText = this.value.toUpperCase();
            const deleteBtn = document.getElementById('delete-btn');
            const seriesSelected = document.getElementById('delete-series').value;
            
            if (confirmText === 'Sƒ∞L' && seriesSelected) {
                deleteBtn.disabled = false;
                deleteBtn.style.opacity = '1';
            } else {
                deleteBtn.disabled = true;
                deleteBtn.style.opacity = '0.5';
            }
        });

        // Seri D√ºzenleme Fonksiyonlarƒ±
        
        // Edit sekmesi i√ßin seri listesini y√ºkle
        async function loadEditSeriesList() {
            try {
                const response = await fetch('http://localhost:5506/client/data/manhwalar.json');
                const series = await response.json();
                
                const select = document.getElementById('edit-series-select');
                select.innerHTML = '<option value="">-- Seri Se√ßin --</option>';
                
                series.forEach(serie => {
                    const option = document.createElement('option');
                    option.value = serie.seriesId;
                    option.textContent = serie.title;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Seri listesi y√ºklenirken hata:', error);
                showStatus('Seri listesi y√ºklenemedi', 'error');
            }
        }

        // Etiket ayarlarƒ± g√∂r√ºn√ºrl√ºk kontrol√º
        function toggleLabelSettings() {
            const labelValue = document.getElementById('edit-series-label-enabled').value;
            const labelSettings = document.getElementById('label-settings');
            
            // Sadece "true" (Etiketi G√∂ster) durumunda ayarlarƒ± g√∂ster
            labelSettings.style.display = labelValue === 'true' ? 'block' : 'none';
            updateLabelPreview();
        }

        // Etiket √∂nizleme g√ºncelleme
        function updateLabelPreview() {
            const labelValue = document.getElementById('edit-series-label-enabled').value;
            const text = document.getElementById('edit-series-label-text').value;
            const color = document.getElementById('edit-series-label-color').value;
            const preview = document.getElementById('label-preview-badge');
            
            if (labelValue === 'true') {
                // Etiketi g√∂ster
                preview.textContent = text;
                preview.style.background = color;
                preview.style.display = 'inline-block';
            } else if (labelValue === 'false') {
                // Etiket var ama gizli (√∂nizlemede g√∂ster ama soluk)
                preview.textContent = text + ' (Gizli)';
                preview.style.background = color;
                preview.style.opacity = '0.5';
                preview.style.display = 'inline-block';
            } else {
                // Etiket yok
                preview.style.display = 'none';
                preview.style.opacity = '1';
            }
        }

        // Se√ßilen seriyi d√ºzenleme formuna y√ºkle
        async function loadSeriesForEdit() {
            const seriesId = document.getElementById('edit-series-select').value;
            const formContainer = document.getElementById('edit-series-form-container');
            
            if (!seriesId) {
                formContainer.style.display = 'none';
                return;
            }

            try {
                const response = await fetch('http://localhost:5506/client/data/manhwalar.json');
                const series = await response.json();
                const selectedSeries = series.find(s => s.seriesId === seriesId);

                if (!selectedSeries) {
                    showStatus('Seri bulunamadƒ±', 'error');
                    return;
                }

                // Form alanlarƒ±nƒ± doldur
                document.getElementById('edit-series-title').value = selectedSeries.title || '';
                document.getElementById('edit-series-status').value = selectedSeries.status || 'Devam Ediyor';
                document.getElementById('edit-series-summary').value = selectedSeries.summary || '';
                document.getElementById('edit-series-cover').value = selectedSeries.image || '';
                document.getElementById('edit-series-author').value = selectedSeries.author || '';
                document.getElementById('edit-series-artist').value = selectedSeries.artist || '';
                document.getElementById('edit-series-publisher').value = selectedSeries.publisher || '';
                
                // Genres array'ini virg√ºlle ayrƒ±lmƒ±≈ü string'e √ßevir
                const genresString = selectedSeries.genres ? selectedSeries.genres.join(', ') : '';
                document.getElementById('edit-series-genres').value = genresString;

                // Etiket bilgilerini y√ºkle
                const label = selectedSeries.label;
                let labelStatus = 'none'; // Varsayƒ±lan: Etiket yok
                
                if (label) {
                    if (label.enabled === true) {
                        labelStatus = 'true'; // Etiketi g√∂ster
                    } else if (label.enabled === false) {
                        labelStatus = 'false'; // Etiketi gizle
                    }
                    // Etiket var ise text ve color'ƒ± y√ºkle
                    document.getElementById('edit-series-label-text').value = label.text || 'Yeni';
                    document.getElementById('edit-series-label-color').value = label.color || '#4CAF50';
                } else {
                    // Etiket yok ise varsayƒ±lan deƒüerler
                    document.getElementById('edit-series-label-text').value = 'Yeni';
                    document.getElementById('edit-series-label-color').value = '#4CAF50';
                }
                
                document.getElementById('edit-series-label-enabled').value = labelStatus;
                toggleLabelSettings();

                // Kapak √∂nizlemesini g√∂ster
                if (selectedSeries.image) {
                    document.getElementById('edit-preview-image').src = selectedSeries.image;
                    document.getElementById('edit-cover-preview').style.display = 'block';
                }

                formContainer.style.display = 'block';
            } catch (error) {
                console.error('Seri y√ºklenirken hata:', error);
                showStatus('Seri bilgileri y√ºklenemedi', 'error');
            }
        }

        // Form submissions
        document.getElementById('series-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData);
            
            // Client-side validasyon
            if (!data.title || data.title.trim().length === 0) {
                showStatus('Seri ba≈ülƒ±ƒüƒ± gerekli', 'error');
                return;
            }
            
            if (!data.seriesId || data.seriesId.trim().length === 0) {
                showStatus('Seri ID gerekli', 'error');
                return;
            }
            
            // Seri ID normalize et (sadece alfanumerik karakterler)
            data.seriesId = data.seriesId.toLowerCase().replace(/[^a-z0-9]/g, '');
            
            if (data.seriesId.length < 3) {
                showStatus('Seri ID en az 3 karakter olmalƒ±', 'error');
                return;
            }
            
            if (!data.coverImageUrl || data.coverImageUrl.trim().length === 0) {
                showStatus('Kapak g√∂rseli gerekli', 'error');
                return;
            }
            
            // Google Drive link kontrol√º
            if (!data.coverImageUrl.includes('drive.google.com') || !data.coverImageUrl.includes('/file/d/')) {
                showStatus('Ge√ßerli bir Google Drive linki girin', 'error');
                return;
            }
            
            // Parse genre
            if (data.genre) {
                data.genre = data.genre.split(',').map(g => g.trim());
            }
            
            toggleLoading(true);
            
            try {
                const response = await fetch(`${API_BASE}/admin/create-series`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                const result = await response.json();
                
                if (result.success) {
                    showStatus('Seri ba≈üarƒ±yla olu≈üturuldu!', 'success');
                    e.target.reset();
                    document.getElementById('cover-preview').style.display = 'none';
                } else {
                    // Detaylƒ± hata mesajƒ± g√∂ster
                    let errorMessage = result.error || 'Seri olu≈üturulamadƒ±';
                    if (result.details && Array.isArray(result.details)) {
                        errorMessage += ':\n' + result.details.join('\n');
                    }
                    if (result.existingTitle) {
                        errorMessage += '\nMevcut seri: ' + result.existingTitle;
                    }
                    showStatus(errorMessage, 'error');
                }
            } catch (error) {
                showStatus('Baƒülantƒ± hatasƒ±', 'error');
                console.error('Series creation error:', error);
            }
            
            toggleLoading(false);
        });

        document.getElementById('chapter-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const imageInputs = document.querySelectorAll('#image-inputs input');
            const imageUrls = Array.from(imageInputs).map(input => input.value).filter(url => url);
            
            // Client-side validasyon
            if (!formData.get('seriesId') || formData.get('seriesId').trim().length === 0) {
                showStatus('Seri ID gerekli', 'error');
                return;
            }
            
            if (!formData.get('chapterNumber') || isNaN(parseInt(formData.get('chapterNumber')))) {
                showStatus('Ge√ßerli bir b√∂l√ºm numarasƒ± gerekli', 'error');
                return;
            }
            
            if (parseInt(formData.get('chapterNumber')) <= 0) {
                showStatus('B√∂l√ºm numarasƒ± 0\'dan b√ºy√ºk olmalƒ±', 'error');
                return;
            }
            
            if (imageUrls.length === 0) {
                showStatus('L√ºtfen en az bir g√∂rsel linki girin', 'error');
                return;
            }
            
            // Google Drive linklerini kontrol et
            for (let i = 0; i < imageUrls.length; i++) {
                const url = imageUrls[i];
                if (!url.includes('drive.google.com') || !url.includes('/file/d/')) {
                    showStatus(`${i + 1}. g√∂rsel i√ßin ge√ßerli bir Google Drive linki girin`, 'error');
                    return;
                }
            }
            
            const data = {
                seriesId: formData.get('seriesId').toLowerCase().replace(/[^a-z0-9]/g, ''),
                chapterNumber: parseInt(formData.get('chapterNumber')),
                title: formData.get('title') || `B√∂l√ºm ${formData.get('chapterNumber')}`,
                imageUrls: imageUrls
            };
            
            toggleLoading(true);
            
            try {
                const response = await fetch(`${API_BASE}/admin/create-chapter-with-images`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                const result = await response.json();
                
                if (result.success) {
                    showStatus(`B√∂l√ºm ba≈üarƒ±yla olu≈üturuldu! (${result.imageCount} g√∂rsel)`, 'success');
                    e.target.reset();
                    document.getElementById('image-inputs').innerHTML = `
                        <div class="image-input-item">
                            <input type="url" placeholder="Sayfa 1 Google Drive linki" required>
                            <button type="button" class="btn btn-danger btn-small" onclick="removeImageInput(this)">Sil</button>
                        </div>
                    `;
                    document.getElementById('images-preview').style.display = 'none';
                } else {
                    // Detaylƒ± hata mesajƒ± g√∂ster
                    let errorMessage = result.error || 'B√∂l√ºm olu≈üturulamadƒ±';
                    if (result.details && Array.isArray(result.details)) {
                        errorMessage += ':\n' + result.details.join('\n');
                    }
                    if (result.validIds && Array.isArray(result.validIds)) {
                        errorMessage += '\nGe√ßerli seri ID\'leri: ' + result.validIds.join(', ');
                    }
                    showStatus(errorMessage, 'error');
                }
            } catch (error) {
                showStatus('Baƒülantƒ± hatasƒ±', 'error');
                console.error('Chapter creation error:', error);
            }
            
            toggleLoading(false);
        });

        document.getElementById('validate-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const driveUrl = formData.get('driveUrl');
            
            toggleLoading(true);
            
            try {
                const response = await fetch(`${API_BASE}/admin/validate-drive-link`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${getAuthToken()}`
                    },
                    body: JSON.stringify({ driveUrl })
                });

                const result = await response.json();
                
                const resultDiv = document.getElementById('validation-details');
                resultDiv.innerHTML = `
                    <p><strong>Ge√ßerli:</strong> ${result.isValid ? '‚úÖ Evet' : '‚ùå Hayƒ±r'}</p>
                    <p><strong>Direct URL:</strong> <a href="${result.directUrl}" target="_blank">${result.directUrl}</a></p>
                    <p><strong>Thumbnail URL:</strong> <a href="${result.thumbnailUrl}" target="_blank">${result.thumbnailUrl}</a></p>
                    ${result.isValid ? `<img src="${result.directUrl}" class="preview-image" style="max-width: 300px; margin-top: 15px;">` : ''}
                `;
                
                document.getElementById('validation-result').style.display = 'block';
                
                showStatus(result.isValid ? 'Link ge√ßerli!' : 'Link ge√ßersiz!', result.isValid ? 'success' : 'error');
            } catch (error) {
                showStatus('Doƒürulama hatasƒ±', 'error');
                console.error('Validation error:', error);
            }
            
            toggleLoading(false);
        });

        // Auto-generate series ID from title
        document.getElementById('series-title').addEventListener('input', (e) => {
            const title = e.target.value;
            const seriesId = title.toLowerCase()
                .replace(/[^a-z0-9\s]/g, '')
                .replace(/\s+/g, '');
            document.getElementById('series-id').value = seriesId;
        });

        // B√∂l√ºm Y√∂netimi Fonksiyonlarƒ±
        async function loadSeriesList() {
            try {
                const response = await fetch(`${API_BASE}/admin/series-list`);
                const series = await response.json();
                
                const select = document.getElementById('manage-series');
                select.innerHTML = '<option value="">-- Seri Se√ßin --</option>';
                
                series.forEach(s => {
                    const option = document.createElement('option');
                    option.value = s.seriesId;
                    option.textContent = `${s.title} (${s.chapterCount} b√∂l√ºm)`;
                    select.appendChild(option);
                });
                
            } catch (error) {
                showStatus('Seriler y√ºklenirken hata olu≈ütu', 'error');
                console.error('Load series error:', error);
            }
        }

        // Yeni B√∂l√ºm Ekleme i√ßin serileri y√ºkle
        async function loadChapterSeriesList() {
            try {
                const response = await fetch(`${API_BASE}/admin/series-list`);
                const series = await response.json();
                
                const select = document.getElementById('chapter-series');
                select.innerHTML = '<option value="">-- Seri Se√ßin --</option>';
                
                series.forEach(s => {
                    const option = document.createElement('option');
                    option.value = s.seriesId;
                    option.textContent = `${s.title} (${s.chapterCount} b√∂l√ºm)`;
                    select.appendChild(option);
                });
                
            } catch (error) {
                showStatus('Seriler y√ºklenirken hata olu≈ütu', 'error');
                console.error('Load chapter series error:', error);
            }
        }

        async function loadSeriesChapters(seriesId) {
            if (!seriesId) {
                document.getElementById('chapters-list-container').style.display = 'none';
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/admin/series/${seriesId}/chapters`);
                const data = await response.json();
                
                if (data.success) {
                    displayChaptersList(data.chapters, seriesId);
                    document.getElementById('chapters-list-container').style.display = 'block';
                } else {
                    showStatus('B√∂l√ºmler y√ºklenirken hata olu≈ütu', 'error');
                }
                
            } catch (error) {
                showStatus('B√∂l√ºmler y√ºklenirken hata olu≈ütu', 'error');
                console.error('Load chapters error:', error);
            }
        }

        function displayChaptersList(chapters, seriesId) {
            const container = document.getElementById('chapters-list');
            
            if (!chapters || chapters.length === 0) {
                container.innerHTML = '<p class="no-chapters">Bu seride hen√ºz b√∂l√ºm yok.</p>';
                return;
            }

            const chaptersHtml = chapters.map(chapter => `
                <div class="chapter-card">
                    <h4>B√∂l√ºm ${chapter.number}: ${chapter.title || 'Ba≈ülƒ±ksƒ±z'}</h4>
                    <div class="chapter-info">
                        üìÖ ${new Date(chapter.uploadDate).toLocaleDateString('tr-TR')}<br>
                        üñºÔ∏è ${chapter.imageCount} g√∂rsel<br>
                        üìÅ ${chapter.filename}
                    </div>
                    <div class="chapter-actions">
                        <button class="btn btn-small" onclick="editChapter('${seriesId}', ${chapter.number})">‚úèÔ∏è D√ºzenle</button>
                        <button class="btn btn-danger btn-small" onclick="confirmDeleteChapter('${seriesId}', ${chapter.number})">üóëÔ∏è Sil</button>
                    </div>
                </div>
            `).join('');

            container.innerHTML = `<div class="chapters-grid">${chaptersHtml}</div>`;
        }

        async function editChapter(seriesId, chapterNumber) {
            try {
                const response = await fetch(`${API_BASE}/admin/series/${seriesId}/chapters/${chapterNumber}`);
                const data = await response.json();
                
                if (data.success) {
                    showEditForm(data.chapter, seriesId);
                } else {
                    showStatus('B√∂l√ºm bilgileri alƒ±namadƒ±', 'error');
                }
                
            } catch (error) {
                showStatus('B√∂l√ºm bilgileri alƒ±nƒ±rken hata olu≈ütu', 'error');
                console.error('Edit chapter error:', error);
            }
        }

        function showEditForm(chapter, seriesId) {
            document.getElementById('edit-series-id').value = seriesId;
            document.getElementById('edit-chapter-original-number').value = chapter.number;
            document.getElementById('edit-chapter-number').value = chapter.number;
            document.getElementById('edit-chapter-title').value = chapter.title || '';
            
            // G√∂rsel URL'lerini y√ºkle
            const imageContainer = document.getElementById('edit-image-inputs');
            imageContainer.innerHTML = '';
            
            if (chapter.imageUrls && chapter.imageUrls.length > 0) {
                chapter.imageUrls.forEach((url, index) => {
                    addEditImageInput(url);
                });
            } else {
                addEditImageInput();
            }
            
            document.getElementById('chapter-edit-form').style.display = 'block';
            document.getElementById('chapter-edit-form').scrollIntoView({ behavior: 'smooth' });
        }

        function addEditImageInput(url = '') {
            const container = document.getElementById('edit-image-inputs');
            const inputCount = container.children.length;
            
            const newInputDiv = document.createElement('div');
            newInputDiv.className = 'edit-image-input-item';
            newInputDiv.innerHTML = `
                <input type="url" placeholder="Sayfa ${inputCount + 1} Google Drive linki" value="${url}" oninput="updateImagePreview(this)">
                <button type="button" class="btn btn-danger btn-small" onclick="removeEditImageInput(this)">Sil</button>
                <img src="${url ? getPreviewUrl(url) : ''}" class="image-preview" style="max-width:60px; max-height:60px; vertical-align:middle; margin-left:8px; display:${url ? 'inline-block' : 'none'};" onclick="showImageModal(this.src)" title="√ñnizle">
            `;
            container.appendChild(newInputDiv);
        }

        function getPreviewUrl(url) {
            // Google Drive linkinden fileId √ßƒ±karƒ±p thumbnail olu≈ütur
            const fileId = extractFileId(url);
            if (fileId) {
                return `https://drive.google.com/thumbnail?id=${fileId}&sz=s400`;
            }
            return url;
        }

        function updateImagePreview(input) {
            const url = input.value;
            const img = input.parentElement.querySelector('.image-preview');
            if (url) {
                img.src = getPreviewUrl(url);
                img.style.display = 'inline-block';
            } else {
                img.src = '';
                img.style.display = 'none';
            }
        }

        function showImageModal(src) {
            // Basit modal: yeni sekmede a√ß
            window.open(src, '_blank');
        }

        function cancelEdit() {
            document.getElementById('chapter-edit-form').style.display = 'none';
        }

        async function confirmDeleteChapter(seriesId, chapterNumber) {
            if (confirm(`B√∂l√ºm ${chapterNumber}'√º silmek istediƒüinizden emin misiniz? Bu i≈ülem geri alƒ±namaz.`)) {
                await deleteChapterConfirmed(seriesId, chapterNumber);
            }
        }

        async function deleteChapterConfirmed(seriesId, chapterNumber) {
            toggleLoading(true);
            
            try {
                const response = await fetch(`${API_BASE}/moderator/delete-chapter/${seriesId}/${chapterNumber}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }
                
                const result = await response.json();
                
                if (result.success) {
                    showStatus('B√∂l√ºm ba≈üarƒ±yla silindi!', 'success');
                    loadSeriesChapters(seriesId); // Listeyi yenile
                } else {
                    showStatus(result.error || 'B√∂l√ºm silinemedi', 'error');
                }
                
            } catch (error) {
                showStatus('B√∂l√ºm silinirken hata olu≈ütu', 'error');
                console.error('Delete chapter error:', error);
            }
            
            toggleLoading(false);
        }

        async function deleteChapter() {
            const seriesId = document.getElementById('edit-series-id').value;
            const chapterNumber = document.getElementById('edit-chapter-original-number').value;
            await confirmDeleteChapter(seriesId, chapterNumber);
        }

        // Edit Chapter Form Submit
        document.getElementById('edit-chapter-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const imageInputs = document.querySelectorAll('#edit-image-inputs input');
            const imageUrls = Array.from(imageInputs).map(input => input.value).filter(url => url);
            
            if (imageUrls.length === 0) {
                showStatus('L√ºtfen en az bir g√∂rsel linki girin', 'error');
                return;
            }
            
            const data = {
                seriesId: document.getElementById('edit-series-id').value,
                originalChapterNumber: document.getElementById('edit-chapter-original-number').value,
                newChapterNumber: document.getElementById('edit-chapter-number').value,
                title: document.getElementById('edit-chapter-title').value,
                imageUrls: imageUrls
            };
            
            toggleLoading(true);
            
            try {
                const response = await fetch(`${API_BASE}/admin/update-chapter`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                const result = await response.json();
                
                if (result.success) {
                    showStatus('B√∂l√ºm ba≈üarƒ±yla g√ºncellendi!', 'success');
                    cancelEdit();
                    loadSeriesChapters(data.seriesId); // Listeyi yenile
                } else {
                    showStatus(result.error || 'B√∂l√ºm g√ºncellenemedi', 'error');
                }
            } catch (error) {
                showStatus('Baƒülantƒ± hatasƒ±', 'error');
                console.error('Update chapter error:', error);
            }
        });

        // Seri Silme Fonksiyonlarƒ±
        document.getElementById('confirm-delete').addEventListener('input', function() {
            const deleteBtn = document.getElementById('delete-btn');
            deleteBtn.disabled = this.value !== 'Sƒ∞L';
        });

        async function deleteSeries() {
            const seriesId = document.getElementById('delete-series').value;
            const confirmText = document.getElementById('confirm-delete').value.toUpperCase();
            if (!seriesId) {
                showStatus('L√ºtfen silinecek seriyi se√ßin', 'error');
                return;
            }
            if (confirmText !== 'Sƒ∞L') {
                showStatus('Silme i≈ülemini onaylamak i√ßin "Sƒ∞L" yazƒ±n', 'error');
                return;
            }
            const seriesTitle = document.getElementById('delete-series').selectedOptions[0].textContent;
            if (!confirm(`"${seriesTitle}" serisini silmek istediƒüinizden emin misiniz? Bu i≈ülem geri alƒ±namaz!`)) {
                return;
            }
            toggleLoading(true);
            document.getElementById('delete-result').style.display = 'none';
            try {
                // Eƒüer backend auth isterse token ekleyin:
                // const token = getAuthToken();
                const response = await fetch(`${API_BASE}/admin/series/${seriesId}`, {
                    method: 'DELETE',
                    // headers: { 'Authorization': `Bearer ${token}` }
                });
                let result;
                try {
                    result = await response.json();
                } catch (jsonErr) {
                    showStatus('Sunucudan ge√ßersiz yanƒ±t alƒ±ndƒ±', 'error');
                    toggleLoading(false);
                    return;
                }
                if (result && (result.success || result.message)) {
                    showStatus(result.message || 'Seri ba≈üarƒ±yla silindi!', 'success');
                    document.getElementById('delete-series').value = '';
                    document.getElementById('confirm-delete').value = '';
                    document.getElementById('delete-btn').disabled = true;
                    document.getElementById('delete-btn').style.opacity = '0.5';
                    const resultDiv = document.getElementById('delete-result');
                    const detailsDiv = document.getElementById('delete-details');
                    detailsDiv.innerHTML = `
                        <div style="color: green;">
                            <strong>‚úÖ Ba≈üarƒ±yla silindi:</strong><br>
                            üìö Seri ID: ${seriesId}<br>
                            üìÅ Klas√∂rler ve dosyalar temizlendi<br>
                            üóÑÔ∏è Veritabanƒ± kayƒ±tlarƒ± silindi
                        </div>
                    `;
                    resultDiv.style.display = 'block';
                    loadDeleteSeriesList();
                } else {
                    showStatus(result && result.error ? result.error : 'Seri silinemedi', 'error');
                }
            } catch (error) {
                showStatus(`Seri silinirken hata olu≈ütu: ${error.message}`, 'error');
            }
            toggleLoading(false);
        }

        // Delete tab i√ßin serileri y√ºkle
        async function loadDeleteSeriesList() {
            try {
                console.log('Loading series list...');
                const response = await fetch('data/manhwalar.json');
                console.log('Response status:', response.status);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const seriesList = await response.json();
                console.log('Series loaded:', seriesList.length);
                
                const selectElement = document.getElementById('delete-series');
                selectElement.innerHTML = '<option value="">-- Seri Se√ßin --</option>';
                
                seriesList.forEach(series => {
                    const option = document.createElement('option');
                    option.value = series.seriesId;
                    option.textContent = `${series.title} (${series.seriesId})`;
                    selectElement.appendChild(option);
                });
                
                console.log('Series list loaded successfully');
            } catch (error) {
                console.error('Error loading series list:', error);
                showStatus(`Seri listesi y√ºklenirken hata olu≈ütu: ${error.message}`, 'error');
            }
        }

        // Silme onayƒ± kontrol√º
        document.getElementById('confirm-delete').addEventListener('input', function() {
            const confirmText = this.value.toUpperCase();
            const deleteBtn = document.getElementById('delete-btn');
            const seriesSelected = document.getElementById('delete-series').value;
            
            if (confirmText === 'Sƒ∞L' && seriesSelected) {
                deleteBtn.disabled = false;
                deleteBtn.style.opacity = '1';
            } else {
                deleteBtn.disabled = true;
                deleteBtn.style.opacity = '0.5';
            }
        });

        // Seri D√ºzenleme Fonksiyonlarƒ±
        
        // Edit sekmesi i√ßin seri listesini y√ºkle
        async function loadEditSeriesList() {
            try {
                const response = await fetch('http://localhost:5506/client/data/manhwalar.json');
                const series = await response.json();
                
                const select = document.getElementById('edit-series-select');
                select.innerHTML = '<option value="">-- Seri Se√ßin --</option>';
                
                series.forEach(serie => {
                    const option = document.createElement('option');
                    option.value = serie.seriesId;
                    option.textContent = serie.title;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Seri listesi y√ºklenirken hata:', error);
                showStatus('Seri listesi y√ºklenemedi', 'error');
            }
        }

        // Etiket ayarlarƒ± g√∂r√ºn√ºrl√ºk kontrol√º
        function toggleLabelSettings() {
            const labelValue = document.getElementById('edit-series-label-enabled').value;
            const labelSettings = document.getElementById('label-settings');
            
            // Sadece "true" (Etiketi G√∂ster) durumunda ayarlarƒ± g√∂ster
            labelSettings.style.display = labelValue === 'true' ? 'block' : 'none';
            updateLabelPreview();
        }

        // Etiket √∂nizleme g√ºncelleme
        function updateLabelPreview() {
            const labelValue = document.getElementById('edit-series-label-enabled').value;
            const text = document.getElementById('edit-series-label-text').value;
            const color = document.getElementById('edit-series-label-color').value;
            const preview = document.getElementById('label-preview-badge');
            
            if (labelValue === 'true') {
                // Etiketi g√∂ster
                preview.textContent = text;
                preview.style.background = color;
                preview.style.display = 'inline-block';
            } else if (labelValue === 'false') {
                // Etiket var ama gizli (√∂nizlemede g√∂ster ama soluk)
                preview.textContent = text + ' (Gizli)';
                preview.style.background = color;
                preview.style.opacity = '0.5';
                preview.style.display = 'inline-block';
            } else {
                // Etiket yok
                preview.style.display = 'none';
                preview.style.opacity = '1';
            }
        }

        // Se√ßilen seriyi d√ºzenleme formuna y√ºkle
        async function loadSeriesForEdit() {
            const seriesId = document.getElementById('edit-series-select').value;
            const formContainer = document.getElementById('edit-series-form-container');
            
            if (!seriesId) {
                formContainer.style.display = 'none';
                return;
            }

            try {
                const response = await fetch('http://localhost:5506/client/data/manhwalar.json');
                const series = await response.json();
                const selectedSeries = series.find(s => s.seriesId === seriesId);

                if (!selectedSeries) {
                    showStatus('Seri bulunamadƒ±', 'error');
                    return;
                }

                // Form alanlarƒ±nƒ± doldur
                document.getElementById('edit-series-title').value = selectedSeries.title || '';
                document.getElementById('edit-series-status').value = selectedSeries.status || 'Devam Ediyor';
                document.getElementById('edit-series-summary').value = selectedSeries.summary || '';
                document.getElementById('edit-series-cover').value = selectedSeries.image || '';
                document.getElementById('edit-series-author').value = selectedSeries.author || '';
                document.getElementById('edit-series-artist').value = selectedSeries.artist || '';
                document.getElementById('edit-series-publisher').value = selectedSeries.publisher || '';
                
                // Genres array'ini virg√ºlle ayrƒ±lmƒ±≈ü string'e √ßevir
                const genresString = selectedSeries.genres ? selectedSeries.genres.join(', ') : '';
                document.getElementById('edit-series-genres').value = genresString;

                // Etiket bilgilerini y√ºkle
                const label = selectedSeries.label;
                let labelStatus = 'none'; // Varsayƒ±lan: Etiket yok
                
                if (label) {
                    if (label.enabled === true) {
                        labelStatus = 'true'; // Etiketi g√∂ster
                    } else if (label.enabled === false) {
                        labelStatus = 'false'; // Etiketi gizle
                    }
                    // Etiket var ise text ve color'ƒ± y√ºkle
                    document.getElementById('edit-series-label-text').value = label.text || 'Yeni';
                    document.getElementById('edit-series-label-color').value = label.color || '#4CAF50';
                } else {
                    // Etiket yok ise varsayƒ±lan deƒüerler
                    document.getElementById('edit-series-label-text').value = 'Yeni';
                    document.getElementById('edit-series-label-color').value = '#4CAF50';
                }
                
                document.getElementById('edit-series-label-enabled').value = labelStatus;
                toggleLabelSettings();

                // Kapak √∂nizlemesini g√∂ster
                if (selectedSeries.image) {
                    document.getElementById('edit-preview-image').src = selectedSeries.image;
                    document.getElementById('edit-cover-preview').style.display = 'block';
                }

                formContainer.style.display = 'block';
            } catch (error) {
                console.error('Seri y√ºklenirken hata:', error);
                showStatus('Seri bilgileri y√ºklenemedi', 'error');
            }
        }

        // Kapak g√∂rselini doƒürula (d√ºzenleme formu i√ßin)
        function validateEditCoverImage() {
            const url = document.getElementById('edit-series-cover').value;
            const previewContainer = document.getElementById('edit-cover-preview');
            const previewImage = document.getElementById('edit-preview-image');

            if (!url) {
                showStatus('L√ºtfen bir g√∂rsel URL\'si girin', 'error');
                previewContainer.style.display = 'none';
                return;
            }

            // Google Drive linkini proxy URL'ye d√∂n√º≈üt√ºr
            let imageUrl = url;
            const driveMatch = url.match(/\/file\/d\/([a-zA-Z0-9_-]+)/);
            if (driveMatch) {
                const fileId = driveMatch[1];
                imageUrl = `http://localhost:5506/api/image/proxy-image/${fileId}`;
            }

            // Loading g√∂ster
            previewImage.src = '';
            previewContainer.style.display = 'block';
            previewImage.style.display = 'none';
            
            // Temporary loading message
            const loadingMsg = document.createElement('div');
            loadingMsg.innerHTML = 'üîÑ G√∂rsel y√ºkleniyor...';
            loadingMsg.style.padding = '20px';
            loadingMsg.style.textAlign = 'center';
            loadingMsg.id = 'temp-loading';
            previewContainer.appendChild(loadingMsg);

            previewImage.onload = function() {
                const tempLoading = document.getElementById('temp-loading');
                if (tempLoading) tempLoading.remove();
                
                previewImage.style.display = 'block';
                showStatus('G√∂rsel ba≈üarƒ±yla y√ºklendi', 'success');
            };
            
            previewImage.onerror = function() {
                const tempLoading = document.getElementById('temp-loading');
                if (tempLoading) tempLoading.remove();
                
                previewContainer.style.display = 'none';
                showStatus('G√∂rsel y√ºklenemedi. URL\'yi kontrol edin', 'error');
            };
            
            previewImage.src = imageUrl;
        }

        // D√ºzenleme formunu temizle ve gizle
        function cancelEdit() {
            document.getElementById('edit-series-select').value = '';
            document.getElementById('edit-series-form-container').style.display = 'none';
            document.getElementById('edit-cover-preview').style.display = 'none';
            document.getElementById('edit-series-form').reset();
        }

        // Seri d√ºzenleme form submit
        document.getElementById('edit-series-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const seriesId = document.getElementById('edit-series-select').value;
            if (!seriesId) {
                showStatus('L√ºtfen bir seri se√ßin', 'error');
                return;
            }

            // Loading g√∂ster
            showLoading(true);
            
            // Status mesajƒ±nƒ± temizle
            const statusDiv = document.getElementById('status-message');
            statusDiv.style.display = 'none';

            try {
                // Form verilerini manuel olarak topla
                const editData = {
                    seriesId: seriesId,
                    title: document.getElementById('edit-series-title').value,
                    status: document.getElementById('edit-series-status').value,
                    summary: document.getElementById('edit-series-summary').value,
                    image: document.getElementById('edit-series-cover').value,
                    author: document.getElementById('edit-series-author').value,
                    artist: document.getElementById('edit-series-artist').value,
                    publisher: document.getElementById('edit-series-publisher').value,
                    genres: document.getElementById('edit-series-genres').value.split(',').map(g => g.trim()).filter(g => g)
                };

                // Etiket i≈üleme
                const labelValue = document.getElementById('edit-series-label-enabled').value;
                if (labelValue === 'none') {
                    // Etiket tamamen kaldƒ±r
                    editData.removeLabel = true;
                } else {
                    // Etiket ekle/g√ºncelle
                    editData.label = {
                        enabled: labelValue === 'true',
                        text: document.getElementById('edit-series-label-text').value,
                        color: document.getElementById('edit-series-label-color').value
                    };
                }

                // Zorunlu alanlarƒ± kontrol et
                if (!editData.title || !editData.status || !editData.image) {
                    showLoading(false);
                    showStatus('L√ºtfen t√ºm zorunlu alanlarƒ± doldurun (Ba≈ülƒ±k, Durum, Kapak G√∂rseli)', 'error');
                    return;
                }

                // Google Drive linkini proxy URL'ye d√∂n√º≈üt√ºr
                const driveMatch = editData.image.match(/\/file\/d\/([a-zA-Z0-9_-]+)/);
                if (driveMatch) {
                    const fileId = driveMatch[1];
                    editData.image = `http://localhost:5506/api/image/proxy-image/${fileId}`;
                }

                console.log('G√∂nderilen veri:', editData); // Debug i√ßin

                const response = await fetch('http://localhost:5506/api/manhwa/edit', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(editData)
                });

                const result = await response.json();
                console.log('Sunucu yanƒ±tƒ±:', result); // Debug i√ßin

                if (response.ok) {
                    showStatus('Seri ba≈üarƒ±yla g√ºncellendi!', 'success');
                    // Edit sekmesindeki seri listesini yenile
                    loadEditSeriesList();
                    // Se√ßili seriyi yeniden y√ºkle
                    loadSeriesForEdit();
                } else {
                    showStatus(result.error || 'Seri g√ºncellenirken hata olu≈ütu', 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showStatus('Beklenmeyen bir hata olu≈ütu: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        });

        // G√∂rsel URL alanƒ±nda deƒüi≈üiklik olduƒüunda otomatik √∂nizleme
        document.getElementById('edit-series-cover').addEventListener('input', function() {
            // 1 saniye bekle sonra otomatik doƒürula
            clearTimeout(this.previewTimeout);
            this.previewTimeout = setTimeout(() => {
                if (this.value.trim()) {
                    validateEditCoverImage();
                }
            }, 1000);
        });

        // Seri se√ßimi deƒüi≈ütiƒüinde onay kontrol√º
        document.getElementById('delete-series').addEventListener('change', function() {
            const confirmText = document.getElementById('confirm-delete').value.toUpperCase();
            const deleteBtn = document.getElementById('delete-btn');
            
            if (confirmText === 'Sƒ∞L' && this.value) {
                deleteBtn.disabled = false;
                deleteBtn.style.opacity = '1';
            } else {
                deleteBtn.disabled = true;
                deleteBtn.style.opacity = '0.5';
            }
        });

        // ===== KULLANICI Y√ñNETƒ∞Mƒ∞ FONKSƒ∞YONLARI =====
        
        let allUsers = [];

        // Kullanƒ±cƒ±larƒ± y√ºkle
        async function loadUsers() {
            try {
                console.log('Kullanƒ±cƒ±larƒ± y√ºklemeye √ßalƒ±≈üƒ±yor...');

                // Test endpoint kullan (ge√ßici √ß√∂z√ºm)
                const response = await fetch('http://localhost:5506/api/admin/test-users', {
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                console.log('Response status:', response.status);
                console.log('Response ok:', response.ok);

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Server error response:', errorText);
                    throw new Error(`Server error ${response.status}: ${errorText}`);
                }

                const data = await response.json();
                console.log('Response data:', JSON.stringify(data, null, 2));
                
                // API direkt kullanƒ±cƒ± array'i d√∂nd√ºr√ºyor
                if (Array.isArray(data)) {
                    allUsers = data;
                    renderUsers(allUsers);
                    updateUserStats(allUsers);
                } else if (data.success) {
                    allUsers = data.users;
                    renderUsers(allUsers);
                    updateUserStats(allUsers);
                } else {
                    throw new Error(data.error || data.details || 'Kullanƒ±cƒ±lar y√ºklenemedi');
                }
            } catch (error) {
                console.error('Kullanƒ±cƒ±larƒ± y√ºkleme hatasƒ±:', error);
                document.getElementById('users-loading').innerHTML = `
                    <div style="color: #dc3545; font-size: 16px;">
                        ‚ùå Kullanƒ±cƒ±lar y√ºklenemedi: ${error.message}
                        <br><small>Detaylar i√ßin tarayƒ±cƒ± console'unu kontrol edin.</small>
                    </div>
                `;
            }
        }

        // Kullanƒ±cƒ± istatistiklerini g√ºncelle
        function updateUserStats(users) {
            const totalUsers = users.length;
            const adminUsers = users.filter(u => u.isAdmin).length;
            const moderatorUsers = users.filter(u => u.isModerator).length;
            const blockedUsers = users.filter(u => u.isBlocked).length;

            document.getElementById('total-users-count').textContent = totalUsers;
            document.getElementById('admin-users-count').textContent = adminUsers;
            document.getElementById('moderator-users-count').textContent = moderatorUsers;
            document.getElementById('blocked-users-count').textContent = blockedUsers;
        }

        // Kullanƒ±cƒ±larƒ± render et
        function renderUsers(users) {
            const container = document.getElementById('users-list');
            const loadingDiv = document.getElementById('users-loading');
            
            loadingDiv.style.display = 'none';
            container.style.display = 'block';

            if (users.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: #666; padding: 40px;">Kullanƒ±cƒ± bulunamadƒ±</div>';
                return;
            }

            const usersHTML = users.map(user => {
                const statusBadges = [];
                if (user.isAdmin) statusBadges.push('<span style="background: #28a745; color: white; padding: 4px 8px; border-radius: 12px; font-size: 12px; margin-left: 8px;">Admin</span>');
                if (user.isModerator) statusBadges.push('<span style="background: #ffc107; color: black; padding: 4px 8px; border-radius: 12px; font-size: 12px; margin-left: 8px;">Moderat√∂r</span>');
                if (user.isBlocked) statusBadges.push('<span style="background: #dc3545; color: white; padding: 4px 8px; border-radius: 12px; font-size: 12px; margin-left: 8px;">Engelli</span>');
                
                return `
                    <div class="user-card" style="background: #f8f9fa; border-radius: 10px; padding: 20px; margin-bottom: 15px; border-left: 4px solid ${user.isAdmin ? '#28a745' : user.isModerator ? '#ffc107' : user.isBlocked ? '#dc3545' : '#667eea'};">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <h4 style="margin-bottom: 8px;">
                                    üë§ ${user.username}
                                    ${statusBadges.join('')}
                                </h4>
                                <p style="color: #666; margin-bottom: 8px;">üìß ${user.email}</p>
                                <div style="font-size: 14px; color: #888;">
                                    <span>üìÖ Kayƒ±t: ${new Date(user.createdAt).toLocaleDateString('tr-TR')}</span>
                                    <span style="margin-left: 20px;">‚≠ê ${user.ratings ? user.ratings.length : 0} puan</span>
                                    <span style="margin-left: 20px;">‚ù§Ô∏è ${user.favorites ? user.favorites.length : 0} favori</span>
                                    <span style="margin-left: 20px;">üìñ ${user.readSeries ? user.readSeries.length : 0} okunan</span>
                                    ${user.isModerator ? `<span style="margin-left: 20px;">üõ°Ô∏è ${user.moderatorSeries ? user.moderatorSeries.length : 0} seri</span>` : ''}
                                </div>
                            </div>
                            <div style="display: flex; gap: 10px;">
                                <button onclick="viewUserDetails('${user._id}')" style="background: #17a2b8; color: white; border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer;">üëÅÔ∏è Detay</button>
                                <button onclick="toggleUserAdmin('${user._id}', ${!user.isAdmin})" 
                                        style="background: ${user.isAdmin ? '#6c757d' : '#28a745'}; color: white; border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer;">
                                    ${user.isAdmin ? 'üë§ Admin Al' : '‚≠ê Admin Yap'}
                                </button>
                                <button onclick="toggleUserBlock('${user._id}', ${!user.isBlocked})" 
                                        style="background: ${user.isBlocked ? '#28a745' : '#ffc107'}; color: ${user.isBlocked ? 'white' : 'black'}; border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer;">
                                    ${user.isBlocked ? '‚úÖ Engel Kaldƒ±r' : 'üö´ Engelle'}
                                </button>
                                <button onclick="deleteUser('${user._id}', '${user.username}')" style="background: #dc3545; color: white; border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer;">üóëÔ∏è Sil</button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = usersHTML;
        }

        // Kullanƒ±cƒ± arama
        function filterUsers() {
            const searchTerm = document.getElementById('user-search').value.toLowerCase();
            const filteredUsers = allUsers.filter(user => 
                user.username.toLowerCase().includes(searchTerm) || 
                user.email.toLowerCase().includes(searchTerm)
            );
            renderUsers(filteredUsers);
        }

        // Admin yetkisi deƒüi≈ütir - GE√áƒ∞Cƒ∞ MOCK
        async function toggleUserAdmin(userId, makeAdmin) {
            if (!confirm(`Bu kullanƒ±cƒ±yƒ± ${makeAdmin ? 'admin yapmak' : 'admin yetkisini almak'} istediƒüinizden emin misiniz?`)) {
                return;
            }

            try {
                // GE√áƒ∞Cƒ∞: Mock response d√∂nd√ºr
                console.log(`üîß Mock i≈ülem: Kullanƒ±cƒ± ${userId} ${makeAdmin ? 'admin yapƒ±ldƒ±' : 'admin yetkisi kaldƒ±rƒ±ldƒ±'}`);
                alert(`Kullanƒ±cƒ± ${makeAdmin ? 'admin yapƒ±ldƒ±' : 'admin yetkisi kaldƒ±rƒ±ldƒ±'} (Mock i≈ülem)`);
                await loadUsers(); // Listeyi yenile
            } catch (error) {
                console.error('Mock admin i≈ülemi hatasƒ±:', error);
                alert('Hata: ' + error.message);
            }
        }

        // Kullanƒ±cƒ± engelleme - GE√áƒ∞Cƒ∞ MOCK
        async function toggleUserBlock(userId, blockUser) {
            if (!confirm(`Bu kullanƒ±cƒ±yƒ± ${blockUser ? 'engellemek' : 'engel kaldƒ±rmak'} istediƒüinizden emin misiniz?`)) {
                return;
            }

            try {
                // GE√áƒ∞Cƒ∞: Mock response d√∂nd√ºr
                console.log(`üîß Mock i≈ülem: Kullanƒ±cƒ± ${userId} ${blockUser ? 'engellendi' : 'engeli kaldƒ±rƒ±ldƒ±'}`);
                alert(`Kullanƒ±cƒ± ${blockUser ? 'engellendi' : 'engeli kaldƒ±rƒ±ldƒ±'} (Mock i≈ülem)`);
                await loadUsers(); // Listeyi yenile
            } catch (error) {
                console.error('Mock block i≈ülemi hatasƒ±:', error);
                alert('Hata: ' + error.message);
            }
        }

        // Kullanƒ±cƒ± silme - GE√áƒ∞Cƒ∞ MOCK
        async function deleteUser(userId, username) {
            if (!confirm(`"${username}" kullanƒ±cƒ±sƒ±nƒ± kalƒ±cƒ± olarak silmek istediƒüinizden emin misiniz?\n\nBu i≈ülem geri alƒ±namaz!`)) {
                return;
            }

            try {
                // GE√áƒ∞Cƒ∞: Mock response d√∂nd√ºr
                console.log(`üîß Mock i≈ülem: Kullanƒ±cƒ± ${username} (${userId}) silindi`);
                alert(`Kullanƒ±cƒ± "${username}" silindi (Mock i≈ülem)`);
                await loadUsers(); // Listeyi yenile
                await loadUsers(); // Listeyi yenile
            } catch (error) {
                console.error('Mock silme i≈ülemi hatasƒ±:', error);
                alert('Hata: ' + error.message);
            }
        }

        // Kullanƒ±cƒ± detaylarƒ±nƒ± g√∂r√ºnt√ºle
        async function viewUserDetails(userId) {
            try {
                // allUsers array'inden kullanƒ±cƒ±yƒ± bul
                const user = allUsers.find(u => u._id === userId);
                
                if (!user) {
                    throw new Error('Kullanƒ±cƒ± bulunamadƒ±');
                }
                
                const modalContent = document.getElementById('user-detail-content');
                    
                    modalContent.innerHTML = `
                        <div style="margin-bottom: 20px;">
                            <h4>üë§ ${user.username}</h4>
                            <p><strong>üìß E-posta:</strong> ${user.email}</p>
                            <p><strong>üìÖ Kayƒ±t Tarihi:</strong> ${new Date(user.createdAt).toLocaleString('tr-TR')}</p>
                            <p><strong>üîÑ Son G√ºncelleme:</strong> ${new Date(user.updatedAt).toLocaleString('tr-TR')}</p>
                            <p><strong>üïê Son Giri≈ü:</strong> ${user.lastLoginAt ? new Date(user.lastLoginAt).toLocaleString('tr-TR') : 'Bilinmiyor'}</p>
                            <p><strong>‚≠ê Admin:</strong> ${user.isAdmin ? '‚úÖ Evet' : '‚ùå Hayƒ±r'}</p>
                            <p><strong>ÔøΩÔ∏è Moderat√∂r:</strong> ${user.isModerator ? '‚úÖ Evet' : '‚ùå Hayƒ±r'}</p>
                            ${user.isModerator && user.moderatorSeries ? `<p><strong>üìö Atanmƒ±≈ü Seriler:</strong> ${user.moderatorSeries.length} seri</p>` : ''}
                            <p><strong>ÔøΩüö´ Engelli:</strong> ${user.isBlocked ? '‚úÖ Evet' : '‚ùå Hayƒ±r'}</p>
                        </div>
                        
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                            <h5>üìä Kullanƒ±cƒ± Aktivitesi</h5>
                            <p><strong>‚≠ê Verilen Puanlar:</strong> ${user.ratings ? user.ratings.length : 0}</p>
                            <p><strong>‚ù§Ô∏è Favoriler:</strong> ${user.favorites ? user.favorites.length : 0}</p>
                            <p><strong>üìñ Okunan Seriler:</strong> ${user.readSeries ? user.readSeries.length : 0}</p>
                            <p><strong>üìà Okuma ƒ∞lerlemesi:</strong> ${user.readingProgress ? user.readingProgress.length : 0} seri</p>
                        </div>
                        
                        ${user.favorites && user.favorites.length > 0 ? `
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                                <h5>‚ù§Ô∏è Favori Seriler</h5>
                                <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px;">
                                    ${user.favorites.map(fav => `<span style="background: #667eea; color: white; padding: 4px 8px; border-radius: 12px; font-size: 12px;">${fav}</span>`).join('')}
                                </div>
                            </div>
                        ` : ''}
                    `;
                    
                    // Moderat√∂r y√∂netimi b√∂l√ºm√ºn√º g√∂ster (admin olmayan kullanƒ±cƒ±lar i√ßin)
                    const moderatorSection = document.getElementById('moderator-assignment-section');
                    if (!user.isAdmin) {
                        moderatorSection.style.display = 'block';
                        // √ñnce serileri y√ºkle, sonra moderat√∂r atamasƒ±nƒ± ayarla
                        await loadSeriesForUserModeratorAssignment();
                        setupModeratorAssignment(user);
                    } else {
                        moderatorSection.style.display = 'none';
                    }
                    
                    document.getElementById('user-detail-modal').style.display = 'block';
            } catch (error) {
                alert('Kullanƒ±cƒ± detaylarƒ± y√ºklenemedi: ' + error.message);
            }
        }

        // Modal kapatma
        function closeUserModal() {
            document.getElementById('user-detail-modal').style.display = 'none';
        }

        // Tab deƒüi≈ütiƒüinde kullanƒ±cƒ±larƒ± y√ºkle
        const originalSwitchTab = switchTab;
        switchTab = function(tabName) {
            originalSwitchTab(tabName);
            if (tabName === 'users') {
                loadUsers();
                loadSeriesForUserModeratorAssignment();
            }
            if (tabName === 'moderators') {
                loadModerators();
                loadSeriesForModeratorAssignment();
            }
        };

        // Sayfa y√ºklendiƒüinde giri≈ü kontrol√º
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Admin panel loading...');
            
            // URL parametresi ile localStorage temizleme
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('clear') === 'true') {
                localStorage.clear();
                console.log('localStorage cleared');
            }
            
            // Debug: localStorage durumunu kontrol et
            const currentToken = localStorage.getItem('token');
            console.log('Current token:', currentToken);
            
            // Eƒüer token yoksa veya ge√ßersizse giri≈ü formu g√∂ster
            if (!currentToken) {
                console.log('No token found, showing login form');
                document.querySelector('.admin-container').style.display = 'none';
                showLoginForm();
            } else {
                console.log('Token found, verifying...');
                // Token'ƒ± verify et
                verifyToken(currentToken);
            }

            // Etiket ayarlarƒ± event listener'larƒ±
            const labelTextSelect = document.getElementById('edit-series-label-text');
            const labelColorSelect = document.getElementById('edit-series-label-color');
            
            if (labelTextSelect) {
                labelTextSelect.addEventListener('change', updateLabelPreview);
            }
            if (labelColorSelect) {
                labelColorSelect.addEventListener('change', updateLabelPreview);
            }
        });
        
        // Token doƒürulama fonksiyonu
        async function verifyToken(token) {
            try {
                const response = await fetch('http://localhost:5506/api/admin/test-users', {
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    console.log('Token valid, showing admin panel');
                    document.querySelector('.admin-container').style.display = 'block';
                } else {
                    console.log('Token invalid, clearing and showing login');
                    localStorage.removeItem('token');
                    document.querySelector('.admin-container').style.display = 'none';
                    showLoginForm();
                }
            } catch (error) {
                console.log('Token verification failed:', error);
                localStorage.removeItem('token');
                document.querySelector('.admin-container').style.display = 'none';
                showLoginForm();
            }
        }

        // Yorum Y√∂netimi Fonksiyonlarƒ±
        let currentReportsPage = 1;
        let currentCommentsPage = 1;

        // Rapor istatistiklerini y√ºkle
        async function loadReportsStats() {
            try {
                const response = await fetch(`${API_BASE}/reports/admin/stats`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                
                if (response.ok) {
                    const stats = await response.json();
                    document.getElementById('pending-reports').textContent = stats.pendingReports;
                    document.getElementById('total-reports').textContent = stats.totalReports;
                    document.getElementById('reported-comments').textContent = stats.reportedComments;
                }
            } catch (error) {
                console.error('Stats y√ºklenirken hata:', error);
            }
        }

        // Raporlarƒ± y√ºkle
        async function loadReports(page = 1) {
            try {
                const status = document.getElementById('report-status-filter').value;
                const seriesId = document.getElementById('series-filter').value;
                
                const params = new URLSearchParams({
                    page,
                    status,
                    limit: 10
                });
                
                if (seriesId) params.append('seriesId', seriesId);
                
                const response = await fetch(`${API_BASE}/reports/admin/reports?${params}`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    renderReports(data.reports);
                    renderReportsPagination(data.page, data.totalPages);
                    currentReportsPage = data.page;
                }
            } catch (error) {
                console.error('Raporlar y√ºklenirken hata:', error);
            }
        }

        // Raporlarƒ± render et
        function renderReports(reports) {
            const listDiv = document.getElementById('reports-list');
            
            if (reports.length === 0) {
                listDiv.innerHTML = '<p style="text-align: center; color: #666;">Rapor bulunamadƒ±.</p>';
                return;
            }

            listDiv.innerHTML = reports.map(report => `
                <div class="report-item" style="border: 1px solid #ddd; border-radius: 8px; padding: 20px; margin-bottom: 15px; background: white;">
                    <div style="display: flex; justify-content: between; align-items: start; margin-bottom: 15px;">
                        <div style="flex: 1;">
                            <h4 style="margin: 0 0 8px 0; color: #333;">
                                ${report.seriesTitle} - ${report.replyId ? 'Yanƒ±t' : 'Yorum'}
                                <span class="report-status status-${report.status}" style="
                                    padding: 4px 8px; 
                                    border-radius: 4px; 
                                    font-size: 0.8rem; 
                                    margin-left: 10px;
                                    background: ${getStatusColor(report.status)};
                                    color: white;
                                ">${getStatusText(report.status)}</span>
                            </h4>
                            <p style="margin: 5px 0; color: #666; font-size: 0.9rem;">
                                <strong>Rapor Eden:</strong> ${report.reportedBy} | 
                                <strong>Neden:</strong> ${getReasonText(report.reason)} | 
                                <strong>Tarih:</strong> ${new Date(report.reportDate).toLocaleString('tr-TR')}
                            </p>
                            ${report.description ? `<p style="margin: 5px 0; color: #666;"><strong>A√ßƒ±klama:</strong> ${report.description}</p>` : ''}
                        </div>
                    </div>
                    
                    ${report.commentId ? `
                        <div style="background: #f9f9f9; padding: 15px; border-radius: 6px; margin: 15px 0;">
                            <p style="margin: 0; font-size: 0.9rem;"><strong>Yorum ƒ∞√ßeriƒüi:</strong></p>
                            <p style="margin: 5px 0 0 0; font-style: italic;">${report.commentId.text || 'Yorum i√ßeriƒüi y√ºklenemedi'}</p>
                            <p style="margin: 5px 0 0 0; font-size: 0.8rem; color: #666;">
                                <strong>Yazan:</strong> ${report.commentId.author || 'Bilinmiyor'}
                            </p>
                        </div>
                    ` : ''}
                    
                    <div style="display: flex; gap: 10px; margin-top: 15px;">
                        ${report.status === 'pending' ? `
                            <button onclick="updateReportStatus('${report._id}', 'reviewed', 'none')" 
                                style="background: #4CAF50; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer;">
                                ‚úÖ ƒ∞ncelendi
                            </button>
                            <button onclick="deleteCommentFromReport('${report.commentId._id}', '${report.replyId || ''}', '${report._id}')" 
                                style="background: #f44336; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer;">
                                üóëÔ∏è Yorumu Sil
                            </button>
                            <button onclick="updateReportStatus('${report._id}', 'dismissed', 'none')" 
                                style="background: #9E9E9E; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer;">
                                ‚ùå Reddet
                            </button>
                        ` : `
                            <span style="color: #666; font-size: 0.9rem;">
                                ${report.reviewedBy ? `${report.reviewedBy} tarafƒ±ndan ${new Date(report.reviewedAt).toLocaleString('tr-TR')} tarihinde i≈ülendi` : 'ƒ∞≈ülendi'}
                            </span>
                        `}
                    </div>
                </div>
            `).join('');
        }

        // Rapor durumunu g√ºncelle
        async function updateReportStatus(reportId, status, action) {
            try {
                const response = await fetch(`${API_BASE}/reports/admin/reports/${reportId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify({ status, action })
                });
                
                if (response.ok) {
                    showStatus('Rapor durumu g√ºncellendi', 'success');
                    loadReports(currentReportsPage);
                    loadReportsStats();
                } else {
                    showStatus('Rapor g√ºncellenirken hata olu≈ütu', 'error');
                }
            } catch (error) {
                console.error('Rapor g√ºncelleme hatasƒ±:', error);
                showStatus('Rapor g√ºncellenirken hata olu≈ütu', 'error');
            }
        }

        // Yorumu rapordan sil
        async function deleteCommentFromReport(commentId, replyId, reportId) {
            if (!confirm('Bu yorumu/yanƒ±tƒ± silmek istediƒüinizden emin misiniz?')) return;
            
            try {
                const url = `${API_BASE}/reports/admin/comment/${commentId}${replyId ? `?replyId=${replyId}` : ''}`;
                const response = await fetch(url, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                
                if (response.ok) {
                    // Raporu da √ß√∂z√ºmlendi olarak i≈üaretle
                    await updateReportStatus(reportId, 'resolved', 'comment_deleted');
                    showStatus('Yorum silindi ve rapor √ß√∂z√ºmlendi', 'success');
                } else {
                    showStatus('Yorum silinirken hata olu≈ütu', 'error');
                }
            } catch (error) {
                console.error('Yorum silme hatasƒ±:', error);
                showStatus('Yorum silinirken hata olu≈ütu', 'error');
            }
        }

        // Yorum y√∂netimi i√ßin seri listesini y√ºkle
        async function loadCommentsSeriesList() {
            try {
                const response = await fetch(`${API_BASE}/admin/series-list`);
                const series = await response.json();
                
                const seriesFilter = document.getElementById('series-filter');
                const commentSeriesSelect = document.getElementById('comment-series-select');
                
                // Filtre i√ßin
                seriesFilter.innerHTML = '<option value="">T√ºm Seriler</option>';
                series.forEach(s => {
                    const option = document.createElement('option');
                    option.value = s.seriesId;
                    option.textContent = `${s.title} (${s.chapterCount} b√∂l√ºm)`;
                    seriesFilter.appendChild(option);
                });
                
                // Yorum y√∂netimi i√ßin
                commentSeriesSelect.innerHTML = '<option value="">-- Seri Se√ßin --</option>';
                series.forEach(s => {
                    const option = document.createElement('option');
                    option.value = s.seriesId;
                    option.textContent = `${s.title} (${s.chapterCount} b√∂l√ºm)`;
                    commentSeriesSelect.appendChild(option);
                });
                
            } catch (error) {
                console.error('Seri listesi y√ºklenirken hata:', error);
            }
        }

        // Seri bazƒ±nda yorumlarƒ± y√ºkle
        async function loadSeriesComments(page = 1) {
            const seriesId = document.getElementById('comment-series-select').value;
            if (!seriesId) {
                document.getElementById('series-comments').style.display = 'none';
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/reports/admin/comments/${seriesId}?page=${page}&limit=10`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    renderSeriesComments(data.comments);
                    renderSeriesCommentsPagination(data.page, data.totalPages);
                    document.getElementById('series-comments').style.display = 'block';
                }
            } catch (error) {
                console.error('Seri yorumlarƒ± y√ºklenirken hata:', error);
            }
        }

        // Seri yorumlarƒ±nƒ± render et
        function renderSeriesComments(comments) {
            const listDiv = document.getElementById('series-comments-list');
            
            if (comments.length === 0) {
                listDiv.innerHTML = '<p style="text-align: center; color: #666;">Bu seride yorum bulunamadƒ±.</p>';
                return;
            }

            listDiv.innerHTML = comments.map(comment => {
                // Yorum konumunu belirle
                let location = 'Ana Seri Sayfasƒ±';
                if (comment.chapterNumber) {
                    location = `B√∂l√ºm ${comment.chapterNumber}`;
                } else if (comment.seriesId && comment.seriesId.includes('-chapter-')) {
                    // Eski sistemde seriesId'den b√∂l√ºm numarasƒ±nƒ± √ßƒ±kar
                    const chapterMatch = comment.seriesId.match(/-chapter-(\d+)$/);
                    if (chapterMatch) {
                        location = `B√∂l√ºm ${chapterMatch[1]}`;
                    }
                }
                
                return `
                <div class="comment-item" style="border: 1px solid #ddd; border-radius: 8px; padding: 15px; margin-bottom: 10px; background: white;">
                    <div style="display: flex; justify-content: between; align-items: start;">
                        <div style="flex: 1;">
                            <p style="margin: 0 0 8px 0;">
                                <strong>${comment.author}</strong> - 
                                <span style="color: #666; font-size: 0.9rem;">${new Date(comment.date).toLocaleString('tr-TR')}</span>
                                <span style="background: #2196F3; color: white; padding: 2px 6px; border-radius: 3px; font-size: 0.8rem; margin-left: 10px;">${location}</span>
                                ${comment.deleted ? '<span style="color: red; font-size: 0.8rem; margin-left: 10px;">[Sƒ∞Lƒ∞NDƒ∞]</span>' : ''}
                                ${comment.reported ? '<span style="background: #ff4444; color: white; padding: 2px 6px; border-radius: 3px; font-size: 0.8rem; margin-left: 10px;">RAPORLANDI</span>' : ''}
                            </p>
                            <p style="margin: 0; font-style: italic;">${comment.text}</p>
                            <p style="margin: 8px 0 0 0; font-size: 0.8rem; color: #666;">
                                üëç ${comment.likes} | üëé ${comment.dislikes} | üí¨ ${comment.replies ? comment.replies.length : 0} yanƒ±t
                            </p>
                        </div>
                        <div style="margin-left: 15px;">
                            ${!comment.deleted ? `
                                <button onclick="deleteComment('${comment._id}')" 
                                    style="background: #f44336; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">
                                    üóëÔ∏è Sil
                                </button>
                            ` : ''}
                        </div>
                    </div>
                    
                    ${comment.replies && comment.replies.length > 0 ? `
                        <div style="margin-top: 15px; padding-left: 20px; border-left: 3px solid #eee;">
                            <h5 style="margin: 0 0 10px 0; color: #666;">Yanƒ±tlar:</h5>
                            ${comment.replies.map(reply => `
                                <div style="background: #f9f9f9; padding: 10px; border-radius: 4px; margin-bottom: 8px;">
                                    <p style="margin: 0 0 5px 0; font-size: 0.9rem;">
                                        <strong>${reply.author}</strong> - 
                                        <span style="color: #666; font-size: 0.8rem;">${new Date(reply.date).toLocaleString('tr-TR')}</span>
                                        ${reply.deleted ? '<span style="color: red; font-size: 0.8rem; margin-left: 10px;">[Sƒ∞Lƒ∞NDƒ∞]</span>' : ''}
                                    </p>
                                    <p style="margin: 0; font-size: 0.9rem; font-style: italic;">${reply.text}</p>
                                    ${!reply.deleted ? `
                                        <button onclick="deleteReply('${comment._id}', '${reply._id}')" 
                                            style="background: #f44336; color: white; border: none; padding: 3px 8px; border-radius: 3px; cursor: pointer; font-size: 0.7rem; margin-top: 5px;">
                                            üóëÔ∏è Sil
                                        </button>
                                    ` : ''}
                                </div>
                            `).join('')}
                        </div>
                    ` : ''}
                </div>
            `;
            }).join('');
        }

        // Yorum sil
        async function deleteComment(commentId) {
            if (!confirm('Bu yorumu silmek istediƒüinizden emin misiniz?')) return;
            
            try {
                const response = await fetch(`${API_BASE}/reports/admin/comment/${commentId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                
                if (response.ok) {
                    showStatus('Yorum silindi', 'success');
                    loadSeriesComments(currentCommentsPage);
                } else {
                    showStatus('Yorum silinirken hata olu≈ütu', 'error');
                }
            } catch (error) {
                console.error('Yorum silme hatasƒ±:', error);
                showStatus('Yorum silinirken hata olu≈ütu', 'error');
            }
        }

        // Yanƒ±t sil
        async function deleteReply(commentId, replyId) {
            if (!confirm('Bu yanƒ±tƒ± silmek istediƒüinizden emin misiniz?')) return;
            
            try {
                const response = await fetch(`${API_BASE}/reports/admin/comment/${commentId}?replyId=${replyId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                
                if (response.ok) {
                    showStatus('Yanƒ±t silindi', 'success');
                    loadSeriesComments(currentCommentsPage);
                } else {
                    showStatus('Yanƒ±t silinirken hata olu≈ütu', 'error');
                }
            } catch (error) {
                console.error('Yanƒ±t silme hatasƒ±:', error);
                showStatus('Yanƒ±t silinirken hata olu≈ütu', 'error');
            }
        }

        // Pagination render fonksiyonlarƒ±
        function renderReportsPagination(currentPage, totalPages) {
            const paginationDiv = document.getElementById('reports-pagination');
            if (totalPages <= 1) {
                paginationDiv.innerHTML = '';
                return;
            }
            
            let html = '';
            for (let i = 1; i <= totalPages; i++) {
                html += `<button onclick="loadReports(${i})" 
                    style="margin: 0 2px; padding: 5px 10px; border: 1px solid #ddd; background: ${i === currentPage ? '#667eea' : 'white'}; color: ${i === currentPage ? 'white' : 'black'}; cursor: pointer; border-radius: 3px;">
                    ${i}
                </button>`;
            }
            paginationDiv.innerHTML = html;
        }

        function renderSeriesCommentsPagination(currentPage, totalPages) {
            const paginationDiv = document.getElementById('series-comments-pagination');
            if (totalPages <= 1) {
                paginationDiv.innerHTML = '';
                return;
            }
            
            let html = '';
            for (let i = 1; i <= totalPages; i++) {
                html += `<button onclick="loadSeriesComments(${i})" 
                    style="margin: 0 2px; padding: 5px 10px; border: 1px solid #ddd; background: ${i === currentPage ? '#667eea' : 'white'}; color: ${i === currentPage ? 'white' : 'black'}; cursor: pointer; border-radius: 3px;">
                    ${i}
                </button>`;
            }
            paginationDiv.innerHTML = html;
        }

        // Yardƒ±mcƒ± fonksiyonlar
        function getStatusColor(status) {
            const colors = {
                'pending': '#ff4444',
                'reviewed': '#4CAF50',
                'resolved': '#2196F3',
                'dismissed': '#9E9E9E'
            };
            return colors[status] || '#666';
        }

        function getStatusText(status) {
            const texts = {
                'pending': 'Bekliyor',
                'reviewed': 'ƒ∞ncelendi',
                'resolved': '√á√∂z√ºld√º',
                'dismissed': 'Reddedildi'
            };
            return texts[status] || status;
        }

        function getReasonText(reason) {
            const reasons = {
                'spam': 'Spam/Reklam',
                'harassment': 'Taciz/Zorbalƒ±k',
                'hate-speech': 'Nefret S√∂ylemi',
                'inappropriate': 'Uygunsuz ƒ∞√ßerik',
                'misinformation': 'Yanlƒ±≈ü Bilgi',
                'other': 'Diƒüer'
            };
            return reasons[reason] || reason;
        }

        // Duyuru Y√∂netimi Fonksiyonlarƒ±
        let announcementCurrentPage = 1;
        let announcementTotalPages = 1;
        const announcementItemsPerPage = 10;

        // Duyuru formu submit event listener
        document.getElementById('announcement-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            await createAnnouncement();
        });

        // Duyuru filtreleme
        document.getElementById('announcement-filter').addEventListener('change', function() {
            announcementCurrentPage = 1;
            loadAnnouncements();
        });

        // Duyuru listesi yenileme
        document.getElementById('refresh-announcements').addEventListener('click', function() {
            loadAnnouncements();
        });

        // Duyuru formu temizleme
        document.getElementById('clear-announcement-form').addEventListener('click', function() {
            clearAnnouncementForm();
        });

        async function createAnnouncement() {
            const form = document.getElementById('announcement-form');
            const formData = new FormData(form);
            
            const announcementData = {
                title: formData.get('title'),
                content: formData.get('content'),
                type: formData.get('type'),
                isActive: formData.has('isActive')
            };

            try {
                showStatus('Duyuru ekleniyor...', 'info');
                
                const response = await fetch('http://localhost:5506/api/announcements', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + localStorage.getItem('token')
                    },
                    body: JSON.stringify(announcementData)
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    showStatus('‚úÖ Duyuru ba≈üarƒ±yla eklendi!', 'success');
                    clearAnnouncementForm();
                    loadAnnouncements();
                } else {
                    showStatus('‚ùå ' + (result.message || 'Duyuru eklenirken hata olu≈ütu'), 'error');
                }
            } catch (error) {
                console.error('Duyuru ekleme hatasƒ±:', error);
                showStatus('‚ùå Duyuru eklenirken hata olu≈ütu', 'error');
            }
        }

        async function loadAnnouncements() {
            try {
                const filter = document.getElementById('announcement-filter').value;
                const response = await fetch(`http://localhost:5506/api/announcements?page=${announcementCurrentPage}&limit=${announcementItemsPerPage}&filter=${filter}`, {
                    headers: {
                        'Authorization': 'Bearer ' + localStorage.getItem('token')
                    }
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    displayAnnouncements(result.announcements);
                    updateAnnouncementPagination(result.pagination);
                } else {
                    showStatus('‚ùå Duyurular y√ºklenirken hata olu≈ütu', 'error');
                }
            } catch (error) {
                console.error('Duyuru y√ºkleme hatasƒ±:', error);
                showStatus('‚ùå Duyurular y√ºklenirken hata olu≈ütu', 'error');
            }
        }

        function displayAnnouncements(announcements) {
            const container = document.getElementById('announcements-list');
            
            if (!announcements || announcements.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 40px; color: #888;">Hen√ºz duyuru bulunmuyor.</div>';
                return;
            }

            container.innerHTML = announcements.map(announcement => `
                <div class="announcement-item">
                    <div class="announcement-header-item">
                        <h4 class="announcement-title-item">${escapeHtml(announcement.title)}</h4>
                        <div>
                            <span class="announcement-type-badge announcement-type-${announcement.type}">
                                ${getTypeLabel(announcement.type)}
                            </span>
                            <span class="announcement-status-badge ${announcement.isActive ? 'announcement-active' : 'announcement-inactive'}">
                                ${announcement.isActive ? 'Aktif' : 'Pasif'}
                            </span>
                        </div>
                    </div>
                    <div class="announcement-content-item">${escapeHtml(announcement.content)}</div>
                    <div class="announcement-meta">
                        <span class="announcement-date">${formatDate(announcement.createdAt)}</span>
                        <div class="announcement-actions">
                            <button class="btn-edit-announcement" onclick="editAnnouncement('${announcement._id}')">
                                ‚úèÔ∏è D√ºzenle
                            </button>
                            <button class="btn-toggle-announcement" onclick="toggleAnnouncement('${announcement._id}', ${!announcement.isActive})">
                                ${announcement.isActive ? 'üî¥ Pasifle≈ütir' : 'üü¢ Aktifle≈ütir'}
                            </button>
                            <button class="btn-delete-announcement" onclick="deleteAnnouncement('${announcement._id}')">
                                üóëÔ∏è Sil
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function updateAnnouncementPagination(pagination) {
            announcementTotalPages = pagination.totalPages;
            announcementCurrentPage = pagination.currentPage;

            const container = document.getElementById('announcements-pagination');
            
            if (announcementTotalPages <= 1) {
                container.innerHTML = '';
                return;
            }

            let paginationHTML = '';
            
            // Previous button
            paginationHTML += `
                <button class="pagination-btn" onclick="changeAnnouncementPage(${announcementCurrentPage - 1})" 
                        ${announcementCurrentPage <= 1 ? 'disabled' : ''}>
                    ‚Üê √ñnceki
                </button>
            `;

            // Page numbers
            for (let i = 1; i <= announcementTotalPages; i++) {
                if (i === 1 || i === announcementTotalPages || (i >= announcementCurrentPage - 2 && i <= announcementCurrentPage + 2)) {
                    paginationHTML += `
                        <button class="pagination-btn ${i === announcementCurrentPage ? 'active' : ''}" 
                                onclick="changeAnnouncementPage(${i})">
                            ${i}
                        </button>
                    `;
                } else if (i === announcementCurrentPage - 3 || i === announcementCurrentPage + 3) {
                    paginationHTML += '<span class="pagination-ellipsis">...</span>';
                }
            }

            // Next button
            paginationHTML += `
                <button class="pagination-btn" onclick="changeAnnouncementPage(${announcementCurrentPage + 1})" 
                        ${announcementCurrentPage >= announcementTotalPages ? 'disabled' : ''}>
                    Sonraki ‚Üí
                </button>
            `;

            container.innerHTML = paginationHTML;
        }

        function changeAnnouncementPage(page) {
            if (page >= 1 && page <= announcementTotalPages) {
                announcementCurrentPage = page;
                loadAnnouncements();
            }
        }

        async function toggleAnnouncement(announcementId, isActive) {
            try {
                const response = await fetch(`http://localhost:5506/api/announcements/${announcementId}/toggle`, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': 'Bearer ' + localStorage.getItem('token')
                    }
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    showStatus(`‚úÖ Duyuru ${isActive ? 'aktifle≈ütirildi' : 'pasifle≈ütirildi'}!`, 'success');
                    loadAnnouncements();
                } else {
                    showStatus('‚ùå ' + (result.message || 'Duyuru g√ºncellenirken hata olu≈ütu'), 'error');
                }
            } catch (error) {
                console.error('Duyuru g√ºncelleme hatasƒ±:', error);
                showStatus('‚ùå Duyuru g√ºncellenirken hata olu≈ütu', 'error');
            }
        }

        async function deleteAnnouncement(announcementId) {
            if (!confirm('Bu duyuruyu silmek istediƒüinizden emin misiniz?')) {
                return;
            }

            try {
                const response = await fetch(`http://localhost:5506/api/announcements/${announcementId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': 'Bearer ' + localStorage.getItem('token')
                    }
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    showStatus('‚úÖ Duyuru ba≈üarƒ±yla silindi!', 'success');
                    loadAnnouncements();
                } else {
                    showStatus('‚ùå ' + (result.message || 'Duyuru silinirken hata olu≈ütu'), 'error');
                }
            } catch (error) {
                console.error('Duyuru silme hatasƒ±:', error);
                showStatus('‚ùå Duyuru silinirken hata olu≈ütu', 'error');
            }
        }

        async function editAnnouncement(announcementId) {
            try {
                const response = await fetch(`http://localhost:5506/api/announcements/${announcementId}`, {
                    headers: {
                        'Authorization': 'Bearer ' + localStorage.getItem('token')
                    }
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    // Form alanlarƒ±nƒ± doldur
                    document.getElementById('announcement-title').value = result.announcement.title;
                    document.getElementById('announcement-content').value = result.announcement.content;
                    document.getElementById('announcement-type').value = result.announcement.type;
                    document.getElementById('announcement-active').checked = result.announcement.isActive;

                    // Form submit handler'ƒ±nƒ± g√ºncelleme moduna √ßevir
                    const form = document.getElementById('announcement-form');
                    form.onsubmit = async function(e) {
                        e.preventDefault();
                        await updateAnnouncement(announcementId);
                    };

                    // Form butonunu g√ºncelle
                    const submitBtn = form.querySelector('button[type="submit"]');
                    submitBtn.textContent = '‚úèÔ∏è Duyuru G√ºncelle';
                    submitBtn.style.background = '#ff9800';

                    // Sayfayƒ± yukarƒ± kaydƒ±r
                    form.scrollIntoView({ behavior: 'smooth' });
                } else {
                    showStatus('‚ùå Duyuru bilgileri y√ºklenirken hata olu≈ütu', 'error');
                }
            } catch (error) {
                console.error('Duyuru y√ºkleme hatasƒ±:', error);
                showStatus('‚ùå Duyuru bilgileri y√ºklenirken hata olu≈ütu', 'error');
            }
        }

        async function updateAnnouncement(announcementId) {
            const form = document.getElementById('announcement-form');
            const formData = new FormData(form);
            
            const announcementData = {
                title: formData.get('title'),
                content: formData.get('content'),
                type: formData.get('type'),
                isActive: formData.has('isActive')
            };

            try {
                showStatus('Duyuru g√ºncelleniyor...', 'info');
                
                const response = await fetch(`http://localhost:5506/api/announcements/${announcementId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + localStorage.getItem('token')
                    },
                    body: JSON.stringify(announcementData)
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    showStatus('‚úÖ Duyuru ba≈üarƒ±yla g√ºncellendi!', 'success');
                    clearAnnouncementForm();
                    loadAnnouncements();
                } else {
                    showStatus('‚ùå ' + (result.message || 'Duyuru g√ºncellenirken hata olu≈ütu'), 'error');
                }
            } catch (error) {
                console.error('Duyuru g√ºncelleme hatasƒ±:', error);
                showStatus('‚ùå Duyuru g√ºncellenirken hata olu≈ütu', 'error');
            }
        }

        function clearAnnouncementForm() {
            const form = document.getElementById('announcement-form');
            form.reset();
            
            // Form submit handler'ƒ±nƒ± yeni duyuru moduna √ßevir
            form.onsubmit = async function(e) {
                e.preventDefault();
                await createAnnouncement();
            };

            // Form butonunu sƒ±fƒ±rla
            const submitBtn = form.querySelector('button[type="submit"]');
            submitBtn.textContent = 'üì¢ Duyuru Ekle';
            submitBtn.style.background = '#667eea';
        }

        function getTypeLabel(type) {
            switch (type) {
                case 'info': return '‚ÑπÔ∏è Bilgi';
                case 'warning': return '‚ö†Ô∏è Uyarƒ±';
                case 'success': return '‚úÖ Ba≈üarƒ±';
                default: return '‚ÑπÔ∏è Bilgi';
            }
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('tr-TR', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // ƒ∞statistikler i√ßin fonksiyonlar
        
        // Ana istatistikleri y√ºkle
        async function loadStatsOverview() {
            try {
                // Seri bazƒ±nda istatistikler
                const seriesResponse = await fetch(`${API_BASE}/stats/series-stats`);
                const seriesData = await seriesResponse.json();
                
                if (seriesData.success) {
                    const stats = seriesData.data;
                    
                    // Toplam okuma hesapla
                    const totalReads = stats.reduce((sum, series) => sum + series.totalReads, 0);
                    const weeklyReads = stats.reduce((sum, series) => sum + series.weeklyReads, 0);
                    const totalSeries = stats.length;
                    
                    // Bug√ºnk√º okuma sayƒ±sƒ±nƒ± al (haftalƒ±k veriden tahmin et)
                    const todayReads = Math.round(weeklyReads / 7);
                    
                    // ƒ∞statistik kartlarƒ±nƒ± g√ºncelle
                    document.getElementById('total-reads-today').textContent = formatNumber(todayReads);
                    document.getElementById('total-reads-week').textContent = formatNumber(weeklyReads);
                    document.getElementById('total-reads-all').textContent = formatNumber(totalReads);
                    document.getElementById('total-series-read').textContent = totalSeries;
                    
                    // En pop√ºler seriler tablosunu g√ºncelle
                    updatePopularSeriesTable(stats);
                }
            } catch (error) {
                console.error('Stats overview error:', error);
                showStatus('ƒ∞statistik verileri y√ºklenirken hata olu≈ütu', 'error');
            }
        }
        
        // Detaylƒ± istatistikleri y√ºkle
        async function loadDetailedStats(page = 1) {
            try {
                const seriesFilter = document.getElementById('stats-series-filter').value;
                const periodFilter = document.getElementById('stats-period-filter').value;
                
                let url = `${API_BASE}/stats/admin/detailed-stats?page=${page}&limit=20`;
                if (seriesFilter) {
                    url += `&seriesId=${encodeURIComponent(seriesFilter)}`;
                }
                
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.success) {
                    updateDetailedStatsTable(data.data);
                    updateStatsPagination(data.pagination);
                }
            } catch (error) {
                console.error('Detailed stats error:', error);
                showStatus('Detaylƒ± istatistikler y√ºklenirken hata olu≈ütu', 'error');
            }
        }
        
        // ƒ∞statistikler i√ßin seri listesini y√ºkle
        async function loadStatsSeriesList() {
            try {
                const response = await fetch(`${API_BASE}/stats/series-stats`);
                const data = await response.json();
                
                if (data.success) {
                    const select = document.getElementById('stats-series-filter');
                    select.innerHTML = '<option value="">T√ºm Seriler</option>';
                    
                    data.data.forEach(series => {
                        const option = document.createElement('option');
                        option.value = series._id;
                        option.textContent = `${series.seriesTitle} (${formatNumber(series.totalReads)} okuma)`;
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Stats series list error:', error);
            }
        }
        
        // En pop√ºler seriler tablosunu g√ºncelle
        function updatePopularSeriesTable(seriesStats) {
            const tbody = document.getElementById('popular-series-table');
            
            if (!seriesStats || seriesStats.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="padding: 20px; text-align: center; color: #666;">Hen√ºz okuma verisi yok</td></tr>';
                return;
            }
            
            const sortedSeries = seriesStats
                .sort((a, b) => b.totalReads - a.totalReads)
                .slice(0, 20);
            
            tbody.innerHTML = sortedSeries.map((series, index) => {
                const avgReads = Math.round(series.avgReadsPerChapter || 0);
                const lastRead = series.lastRead ? formatDate(series.lastRead) : 'Hi√ß okunmadƒ±';
                
                return `
                    <tr style="border-bottom: 1px solid #dee2e6;">
                        <td style="padding: 12px; font-weight: bold; color: #666;">${index + 1}</td>
                        <td style="padding: 12px; font-weight: 500;">${escapeHtml(series.seriesTitle)}</td>
                        <td style="padding: 12px; text-align: center; font-weight: bold; color: #007bff;">${formatNumber(series.totalReads)}</td>
                        <td style="padding: 12px; text-align: center; color: #ff6f61;">${formatNumber(series.weeklyReads)}</td>
                        <td style="padding: 12px; text-align: center;">${series.chapterCount}</td>
                        <td style="padding: 12px; text-align: center; color: #28a745;">${formatNumber(avgReads)}</td>
                        <td style="padding: 12px; text-align: center; font-size: 0.9rem; color: #666;">${lastRead}</td>
                    </tr>
                `;
            }).join('');
        }
        
        // Detaylƒ± istatistikler tablosunu g√ºncelle
        function updateDetailedStatsTable(statsData) {
            const tbody = document.getElementById('detailed-stats-table');
            
            if (!statsData || statsData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="padding: 20px; text-align: center; color: #666;">Veri bulunamadƒ±</td></tr>';
                return;
            }
            
            tbody.innerHTML = statsData.map(stat => {
                const lastRead = stat.lastRead ? formatDate(stat.lastRead) : 'Hi√ß okunmadƒ±';
                
                return `
                    <tr style="border-bottom: 1px solid #dee2e6;">
                        <td style="padding: 12px; font-weight: 500;">${escapeHtml(stat.seriesTitle)}</td>
                        <td style="padding: 12px; text-align: center;">B√∂l√ºm ${stat.chapterNumber}</td>
                        <td style="padding: 12px; text-align: center; font-weight: bold; color: #007bff;">${formatNumber(stat.totalReads)}</td>
                        <td style="padding: 12px; text-align: center; color: #ff6f61;">${formatNumber(stat.weeklyReads)}</td>
                        <td style="padding: 12px; text-align: center; color: #ffc107;">${formatNumber(stat.dailyReads)}</td>
                        <td style="padding: 12px; text-align: center; font-size: 0.9rem; color: #666;">${lastRead}</td>
                    </tr>
                `;
            }).join('');
        }
        
        // Pagination g√ºncelle
        function updateStatsPagination(pagination) {
            const container = document.getElementById('stats-pagination');
            
            if (!pagination || pagination.pages <= 1) {
                container.innerHTML = '';
                return;
            }
            
            const { page, pages } = pagination;
            let html = '<div style="display: flex; gap: 5px; justify-content: center; align-items: center;">';
            
            // Previous button
            if (page > 1) {
                html += `<button onclick="loadDetailedStats(${page - 1})" style="padding: 8px 12px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">‚Äπ √ñnceki</button>`;
            }
            
            // Page numbers
            const maxVisible = 5;
            let startPage = Math.max(1, page - Math.floor(maxVisible / 2));
            let endPage = Math.min(pages, startPage + maxVisible - 1);
            
            if (endPage - startPage + 1 < maxVisible) {
                startPage = Math.max(1, endPage - maxVisible + 1);
            }
            
            for (let i = startPage; i <= endPage; i++) {
                const isActive = i === page;
                html += `<button onclick="loadDetailedStats(${i})" style="padding: 8px 12px; background: ${isActive ? '#6c757d' : '#fff'}; color: ${isActive ? 'white' : '#007bff'}; border: 1px solid ${isActive ? '#6c757d' : '#007bff'}; border-radius: 4px; cursor: pointer;">${i}</button>`;
            }
            
            // Next button
            if (page < pages) {
                html += `<button onclick="loadDetailedStats(${page + 1})" style="padding: 8px 12px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">Sonraki ‚Ä∫</button>`;
            }
            
            html += `<span style="margin-left: 15px; color: #666;">Sayfa ${page} / ${pages}</span>`;
            html += '</div>';
            
            container.innerHTML = html;
        }
        
        // Sayƒ± formatlama
        function formatNumber(num) {
            if (num >= 1000000) {
                return (num / 1000000).toFixed(1) + 'M';
            } else if (num >= 1000) {
                return (num / 1000).toFixed(1) + 'K';
            }
            return num.toString();
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Token alma fonksiyonu
        function getToken() {
            return localStorage.getItem('token') || 'test-admin-token-for-development';
        }

        // ========== MODERAT√ñR Y√ñNETƒ∞Mƒ∞ FONKSƒ∞YONLARI ==========

        // Moderat√∂rleri y√ºkle
        async function loadModerators() {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`${API_BASE}/admin/moderators`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) throw new Error('Moderat√∂rler y√ºklenemedi');

                const moderators = await response.json();
                displayModerators(moderators);
                updateModeratorStats(moderators);
            } catch (error) {
                console.error('Moderat√∂rleri y√ºkleme hatasƒ±:', error);
                showErrorAlert('Moderat√∂rleri y√ºklerken hata olu≈ütu');
            }
        }

        // Moderat√∂rleri g√∂r√ºnt√ºle
        function displayModerators(moderators) {
            const container = document.getElementById('moderators-list');
            const loading = document.getElementById('moderators-loading');

            loading.style.display = 'none';
            container.style.display = 'block';

            if (moderators.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 40px; color: #666;">Hen√ºz moderat√∂r atanmamƒ±≈ü</div>';
                return;
            }

            container.innerHTML = moderators.map(moderator => `
                <div class="moderator-card" style="background: white; border: 1px solid #e0e0e0; border-radius: 10px; padding: 20px; margin-bottom: 15px;">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                        <div style="flex: 1;">
                            <h4 style="margin-bottom: 8px; color: #333;">üõ°Ô∏è ${escapeHtml(moderator.username)}</h4>
                            <p style="color: #666; margin-bottom: 8px;">${escapeHtml(moderator.email)}</p>
                            <div style="margin-bottom: 10px;">
                                <span style="background: #28a745; color: white; padding: 3px 8px; border-radius: 12px; font-size: 12px;">
                                    Moderat√∂r
                                </span>
                            </div>
                            <div>
                                <strong style="color: #667eea;">Atanmƒ±≈ü Seriler (${moderator.moderatorSeries.length}):</strong>
                                <div style="margin-top: 5px;">
                                    ${moderator.moderatorSeries.length > 0 
                                        ? moderator.moderatorSeries.map(seriesId => 
                                            `<span style="background: #f8f9fa; border: 1px solid #dee2e6; padding: 2px 6px; border-radius: 4px; margin-right: 5px; font-size: 12px;">${seriesId}</span>`
                                          ).join('') 
                                        : '<span style="color: #999; font-style: italic;">Seri atanmamƒ±≈ü</span>'
                                    }
                                </div>
                            </div>
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <button onclick="editModerator('${moderator._id}')" style="background: #667eea; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; font-size: 12px;">
                                ‚úèÔ∏è D√ºzenle
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Moderat√∂r istatistiklerini g√ºncelle
        function updateModeratorStats(moderators) {
            const totalModerators = moderators.length;
            const activeModerators = moderators.filter(m => m.moderatorSeries.length > 0).length;
            const totalManagedSeries = new Set(moderators.flatMap(m => m.moderatorSeries)).size;

            document.getElementById('total-moderators-count').textContent = totalModerators;
            document.getElementById('active-moderators-count').textContent = activeModerators;
            document.getElementById('managed-series-count').textContent = totalManagedSeries;
        }

        // Moderat√∂r atama i√ßin serileri y√ºkle
        async function loadSeriesForModeratorAssignment() {
            try {
                // Test endpoint kullan (ge√ßici √ß√∂z√ºm)
                const response = await fetch(`${API_BASE}/admin/test-available-series`, {
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) throw new Error('Seriler y√ºklenemedi');

                const data = await response.json();
                console.log('Moderat√∂r atama i√ßin gelen seri verisi:', data);
                
                let series = [];
                if (data.success && Array.isArray(data.series)) {
                    series = data.series;
                } else if (Array.isArray(data)) {
                    series = data;
                } else {
                    console.error('Beklenmeyen veri formatƒ±:', data);
                    throw new Error('Seri verisi yanlƒ±≈ü formatta');
                }
                
                const editSeriesSelect = document.getElementById('edit-series-select');
                
                const seriesOptions = series.map(s => 
                    `<option value="${s.id}">${escapeHtml(s.title)} ${s.status ? `(${s.status})` : ''}</option>`
                ).join('');
                
                editSeriesSelect.innerHTML = seriesOptions;
            } catch (error) {
                console.error('Serileri y√ºkleme hatasƒ±:', error);
            }
        }

        // Moderat√∂r d√ºzenle
        async function editModerator(moderatorId) {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`${API_BASE}/admin/users`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) throw new Error('Kullanƒ±cƒ± bilgileri alƒ±namadƒ±');

                const users = await response.json();
                const moderator = users.find(u => u._id === moderatorId);
                
                if (!moderator) {
                    showErrorAlert('Moderat√∂r bulunamadƒ±');
                    return;
                }

                // Modal i√ßeriƒüini doldur
                document.getElementById('edit-moderator-id').value = moderatorId;
                document.getElementById('edit-moderator-info').innerHTML = `
                    <div><strong>Kullanƒ±cƒ± Adƒ±:</strong> ${escapeHtml(moderator.username)}</div>
                    <div><strong>E-posta:</strong> ${escapeHtml(moderator.email)}</div>
                    <div><strong>Kayƒ±t Tarihi:</strong> ${new Date(moderator.createdAt).toLocaleDateString('tr-TR')}</div>
                `;

                // Mevcut serileri se√ßili yap
                const editSeriesSelect = document.getElementById('edit-series-select');
                Array.from(editSeriesSelect.options).forEach(option => {
                    option.selected = moderator.moderatorSeries.includes(option.value);
                });

                // Modalƒ± g√∂ster
                document.getElementById('moderator-edit-modal').style.display = 'block';
            } catch (error) {
                console.error('Moderat√∂r d√ºzenleme hatasƒ±:', error);
                showErrorAlert('Moderat√∂r bilgileri alƒ±namadƒ±');
            }
        }

        // Moderat√∂r modalƒ±nƒ± kapat
        function closeModeratorModal() {
            document.getElementById('moderator-edit-modal').style.display = 'none';
        }

        // Moderat√∂r g√ºncelle
        document.getElementById('edit-moderator-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const moderatorId = document.getElementById('edit-moderator-id').value;
            const seriesSelect = document.getElementById('edit-series-select');
            const selectedSeries = Array.from(seriesSelect.selectedOptions).map(option => option.value);
            
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`${API_BASE}/admin/update-moderator-series`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        userId: moderatorId,
                        seriesIds: selectedSeries
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Moderat√∂r g√ºncelleme ba≈üarƒ±sƒ±z');
                }

                showSuccessAlert('Moderat√∂r serileri ba≈üarƒ±yla g√ºncellendi');
                closeModeratorModal();
                loadModerators();
            } catch (error) {
                console.error('Moderat√∂r g√ºncelleme hatasƒ±:', error);
                showErrorAlert(error.message);
            }
        });

        // Moderat√∂r kaldƒ±r
        async function removeModerator() {
            const moderatorId = document.getElementById('edit-moderator-id').value;
            
            if (!confirm('Bu kullanƒ±cƒ±nƒ±n moderat√∂r yetkilerini kaldƒ±rmak istediƒüinizden emin misiniz?')) {
                return;
            }
            
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`${API_BASE}/admin/remove-moderator`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        userId: moderatorId
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Moderat√∂r kaldƒ±rma ba≈üarƒ±sƒ±z');
                }

                showSuccessAlert('Moderat√∂r yetkileri ba≈üarƒ±yla kaldƒ±rƒ±ldƒ±');
                closeModeratorModal();
                loadModerators();
                loadUsersForModeratorAssignment();
            } catch (error) {
                console.error('Moderat√∂r kaldƒ±rma hatasƒ±:', error);
                showErrorAlert(error.message);
            }
        }

        // ========== KULLANICI Y√ñNETƒ∞Mƒ∞NDE MODERAT√ñR FONKSƒ∞YONLARI ==========

        // Kullanƒ±cƒ± i√ßin seri y√ºkleme
        async function loadSeriesForUserModeratorAssignment() {
            try {
                // Test endpoint kullan (ge√ßici √ß√∂z√ºm)
                const response = await fetch(`${API_BASE}/admin/test-available-series`, {
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) throw new Error('Seriler y√ºklenemedi');

                const data = await response.json();
                console.log('Gelen seri verisi:', data);
                
                let series = [];
                if (data.success && Array.isArray(data.series)) {
                    series = data.series;
                } else if (Array.isArray(data)) {
                    series = data;
                } else {
                    console.error('Beklenmeyen veri formatƒ±:', data);
                    throw new Error('Seri verisi yanlƒ±≈ü formatta');
                }
                
                const userSeriesSelect = document.getElementById('user-series-select');
                
                const seriesOptions = series.map(s => 
                    `<option value="${s.id}">${escapeHtml(s.title)} ${s.status ? `(${s.status})` : ''}</option>`
                ).join('');
                
                userSeriesSelect.innerHTML = seriesOptions;
            } catch (error) {
                console.error('Serileri y√ºkleme hatasƒ±:', error);
            }
        }

        // Moderat√∂r atama i≈ülemini ayarla
        function setupModeratorAssignment(user) {
            document.getElementById('selected-user-id').value = user._id;
            
            // Butonlarƒ± kullanƒ±cƒ± durumuna g√∂re ayarla
            const makeModerator = document.getElementById('make-moderator-btn');
            const updateModerator = document.getElementById('update-moderator-btn');
            const removeModerator = document.getElementById('remove-moderator-btn');
            const seriesSelect = document.getElementById('user-series-select');
            
            if (user.isModerator) {
                // Kullanƒ±cƒ± zaten moderat√∂r
                makeModerator.style.display = 'none';
                updateModerator.style.display = 'inline-block';
                removeModerator.style.display = 'inline-block';
                
                // Mevcut serileri se√ßili yap
                Array.from(seriesSelect.options).forEach(option => {
                    option.selected = user.moderatorSeries && user.moderatorSeries.includes(option.value);
                });
            } else {
                // Kullanƒ±cƒ± hen√ºz moderat√∂r deƒüil
                makeModerator.style.display = 'inline-block';
                updateModerator.style.display = 'none';
                removeModerator.style.display = 'none';
                
                // T√ºm se√ßimleri temizle
                Array.from(seriesSelect.options).forEach(option => {
                    option.selected = false;
                });
            }
        }

        // Kullanƒ±cƒ±yƒ± moderat√∂r yap
        async function makeUserModerator() {
            const userId = document.getElementById('selected-user-id').value;
            const seriesSelect = document.getElementById('user-series-select');
            const selectedSeries = Array.from(seriesSelect.selectedOptions).map(option => option.value);
            
            if (!userId) {
                showErrorAlert('Kullanƒ±cƒ± ID bulunamadƒ±');
                return;
            }
            
            try {
                const token = getToken();
                const response = await fetch(`${API_BASE}/admin/make-moderator`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        userId: userId,
                        seriesIds: selectedSeries
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Moderat√∂r atama ba≈üarƒ±sƒ±z');
                }

                showSuccessAlert('Kullanƒ±cƒ± ba≈üarƒ±yla moderat√∂r yapƒ±ldƒ±');
                closeUserModal();
                loadUsers(); // Kullanƒ±cƒ± listesini yenile
            } catch (error) {
                console.error('Moderat√∂r atama hatasƒ±:', error);
                showErrorAlert(error.message);
            }
        }

        // Kullanƒ±cƒ±nƒ±n moderat√∂r serilerini g√ºncelle
        async function updateUserModeratorSeries() {
            const userId = document.getElementById('selected-user-id').value;
            const seriesSelect = document.getElementById('user-series-select');
            const selectedSeries = Array.from(seriesSelect.selectedOptions).map(option => option.value);
            
            if (!userId) {
                showErrorAlert('Kullanƒ±cƒ± ID bulunamadƒ±');
                return;
            }
            
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`${API_BASE}/admin/update-moderator-series`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        userId: userId,
                        seriesIds: selectedSeries
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Moderat√∂r g√ºncelleme ba≈üarƒ±sƒ±z');
                }

                showSuccessAlert('Moderat√∂r serileri ba≈üarƒ±yla g√ºncellendi');
                closeUserModal();
                loadUsers(); // Kullanƒ±cƒ± listesini yenile
            } catch (error) {
                console.error('Moderat√∂r g√ºncelleme hatasƒ±:', error);
                showErrorAlert(error.message);
            }
        }

        // Kullanƒ±cƒ±nƒ±n moderat√∂r yetkilerini kaldƒ±r
        async function removeUserModerator() {
            const userId = document.getElementById('selected-user-id').value;
            
            if (!confirm('Bu kullanƒ±cƒ±nƒ±n moderat√∂r yetkilerini kaldƒ±rmak istediƒüinizden emin misiniz?')) {
                return;
            }
            
            if (!userId) {
                showErrorAlert('Kullanƒ±cƒ± ID bulunamadƒ±');
                return;
            }
            
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`${API_BASE}/admin/remove-moderator`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        userId: userId
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Moderat√∂r kaldƒ±rma ba≈üarƒ±sƒ±z');
                }

                showSuccessAlert('Moderat√∂r yetkileri ba≈üarƒ±yla kaldƒ±rƒ±ldƒ±');
                closeUserModal();
                loadUsers(); // Kullanƒ±cƒ± listesini yenile
            } catch (error) {
                console.error('Moderat√∂r kaldƒ±rma hatasƒ±:', error);
                showErrorAlert(error.message);
            }
        }
    }
  
}        
     */

    </script>
    <script src="admin-panel.js"></script>
    <script src="admin-panel2.js"></script>
    <script src="admin-panel3.js"></script>
    <script src="admin-panel4.js"></script>
    <script src="admin-panel5.js"></script>

</body>
</html>

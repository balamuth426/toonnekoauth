<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ToonNeko Moderatör Panel</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .moderator-container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .moderator-header {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .moderator-header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .moderator-content {
            padding: 40px;
        }

        .profile-card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 30px;
        }

        .profile-info {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .profile-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            color: white;
        }

        .profile-details h3 {
            margin-bottom: 5px;
            color: #333;
        }

        .profile-details p {
            color: #666;
            margin-bottom: 3px;
        }

        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            margin-top: 10px;
        }

        .badge.moderator {
            background: #28a745;
            color: white;
        }

        .badge.admin {
            background: #dc3545;
            color: white;
        }

        .series-section {
            margin-top: 30px;
        }

        .series-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .series-card {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            padding: 20px;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .series-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .series-title {
            font-size: 1.2rem;
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
        }

        .series-status {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .status-ongoing {
            background: #28a745;
            color: white;
        }

        .status-completed {
            background: #6c757d;
            color: white;
        }

        .chapter-count {
            color: #667eea;
            font-weight: bold;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn.secondary {
            background: #6c757d;
        }

        .login-form {
            max-width: 400px;
            margin: 50px auto;
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #333;
        }

        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: bold;
        }

        .alert.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .no-series {
            text-align: center;
            padding: 40px;
            color: #666;
            font-style: italic;
        }

        /* Seri Yönetim Modal Stilleri */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            overflow-y: auto;
        }

        .modal-content {
            background-color: white;
            margin: 50px auto;
            padding: 0;
            border-radius: 15px;
            width: 90%;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
        }

        .modal-header {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            padding: 20px 30px;
            border-radius: 15px 15px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-body {
            padding: 30px;
        }

        .close {
            color: white;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            opacity: 0.8;
            transition: opacity 0.3s;
        }

        .close:hover {
            opacity: 1;
        }

        .tab-container {
            margin-bottom: 20px;
        }

        .tab-buttons {
            display: flex;
            border-bottom: 2px solid #eee;
            margin-bottom: 20px;
        }

        .tab-button {
            padding: 12px 24px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            color: #666;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }

        .tab-button.active {
            color: #28a745;
            border-bottom-color: #28a745;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .form-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
        }

        .form-row .form-group {
            flex: 1;
        }

        textarea {
            min-height: 100px;
            resize: vertical;
        }

        .chapter-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
        }

        .chapter-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #eee;
            margin-bottom: 10px;
        }

        .chapter-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }

        .chapter-info {
            flex: 1;
        }

        .chapter-actions {
            display: flex;
            gap: 10px;
        }

        .btn.small {
            padding: 5px 12px;
            font-size: 12px;
        }

        .btn.danger {
            background: #dc3545;
        }

        .btn.danger:hover {
            background: #c82333;
        }

        /* Resim input konteyner stilleri */
        .images-input-container {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            background: #f9f9f9;
        }

        .image-input-item {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
        }

        .image-input-item:last-child {
            margin-bottom: 0;
        }

        .image-input-item input {
            flex: 1;
            margin-bottom: 0;
        }

        .preview-container {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }

        .preview-images {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }

        .preview-images img {
            max-width: 150px;
            max-height: 200px;
            object-fit: cover;
            border-radius: 4px;
            border: 1px solid #ddd;
        }

        .form-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .form-actions .btn {
            flex: 1;
        }

        /* Admin Panel Stilleri - Moderatör için uyarlandı */
        .edit-form-container {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 25px;
            margin-top: 20px;
            border: 2px solid #e9ecef;
        }

        .edit-series-header {
            color: #28a745;
            font-size: 1.2rem;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e9ecef;
        }

        .chapters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .chapter-card {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 20px;
            transition: all 0.3s ease;
        }

        .chapter-card:hover {
            border-color: #28a745;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .chapter-card h4 {
            margin: 0 0 10px 0;
            color: #333;
            font-size: 1.2rem;
        }

        .chapter-info {
            color: #666;
            font-size: 0.9rem;
            margin-bottom: 15px;
        }

        .chapter-actions {
            display: flex;
            gap: 10px;
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 0.9rem;
        }

        .edit-image-input-item {
            display: flex;
            gap: 10px;
            margin: 10px 0;
            align-items: center;
        }

        .edit-image-input-item input {
            flex: 1;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #28a745;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .status-message {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }

        .status-message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status-message.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        /* Etiket yönetimi stilleri - Admin panel'den */
        .label-config {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }

        .label-preview {
            margin-top: 15px;
            padding: 10px;
            background: white;
            border-radius: 5px;
            border: 1px solid #ddd;
        }

        .series-label {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            color: white;
            text-shadow: 0 1px 2px rgba(0,0,0,0.3);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .form-row-full {
            grid-column: 1 / -1;
        }
    </style>
</head>
<body>
    <div class="moderator-container" id="main-content" style="display: none;">
        <div class="moderator-header">
            <h1>🛡️ ToonNeko Moderatör Panel</h1>
            <p>Atanmış serilerinizi yönetin</p>
        </div>

        <div class="moderator-content">
            <div id="status-message" class="status-message"></div>
            <div id="loading" class="loading">
                <div class="spinner"></div>
                <p>İşlem gerçekleştiriliyor...</p>
            </div>

            <!-- Profil Kartı -->
            <div class="profile-card" id="profile-section">
                <div class="profile-info">
                    <div class="profile-avatar" id="profile-avatar">
                        🛡️
                    </div>
                    <div class="profile-details">
                        <h3 id="profile-username">Yükleniyor...</h3>
                        <p id="profile-email"></p>
                        <p id="profile-type"></p>
                        <div id="profile-badges"></div>
                    </div>
                </div>
            </div>

            <!-- Atanmış Seriler -->
            <div class="series-section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2>📚 Yönetilen Seriler</h2>
                    <button class="btn secondary" onclick="logout()">🚪 Çıkış Yap</button>
                </div>
                
                <div id="series-loading" style="text-align: center; padding: 40px; color: #666;">
                    <div style="font-size: 18px;">Seriler yükleniyor...</div>
                </div>
                
                <div id="series-content" style="display: none;">
                    <div class="series-grid" id="series-grid">
                        <!-- Seriler buraya yüklenecek -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Giriş Formu -->
    <div class="login-form" id="login-section">
        <h2 style="text-align: center; margin-bottom: 30px; color: #333;">🛡️ Moderatör Girişi</h2>
        
        <div id="login-alert" style="display: none;"></div>
        
        <form id="login-form">
            <div class="form-group">
                <label for="login-identifier">Kullanıcı Adı veya E-posta</label>
                <input type="text" id="login-identifier" required placeholder="Kullanıcı adı veya e-posta">
            </div>
            
            <div class="form-group">
                <label for="login-password">Şifre</label>
                <input type="password" id="login-password" required>
            </div>
            
            <button type="submit" class="btn" style="width: 100%;">🔐 Giriş Yap</button>
        </form>
        
        <div style="text-align: center; margin-top: 20px;">
            <a href="/" style="color: #667eea; text-decoration: none;">← Ana Sayfaya Dön</a>
        </div>
    </div>

    <!-- Seri Yönetim Modal -->
    <div id="series-management-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-series-title">Seri Yönetimi</h2>
                <span class="close" onclick="closeSeriesModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="tab-container">
                    <div class="tab-buttons">
                        <button class="tab-button active" onclick="switchTab('series-info')">📝 Seri Bilgileri</button>
                        <button class="tab-button" onclick="switchTab('chapters')">📖 Bölümler</button>
                        <button class="tab-button" onclick="switchTab('add-chapter')">➕ Bölüm Ekle</button>
                        <button class="tab-button" onclick="switchTab('edit-chapter')">✏️ Bölüm Düzenle</button>
                    </div>

                    <!-- Seri Bilgileri Tab -->
                    <div id="series-info" class="tab-content active">
                        <form id="series-info-form">
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="series-title">Seri Başlığı *</label>
                                    <input type="text" id="series-title" required>
                                </div>
                                <div class="form-group">
                                    <label for="series-status">Seri Durumu *</label>
                                    <select id="series-status" required>
                                        <option value="Devam Ediyor">Devam Ediyor</option>
                                        <option value="Tamamlandı">Tamamlandı</option>
                                        <option value="Beklemede">Beklemede</option>
                                    </select>
                                </div>
                            </div>

                            <div class="form-group form-row-full">
                                <label for="series-summary">Seri Özeti</label>
                                <textarea id="series-summary" placeholder="Serinin açıklaması..." rows="4"></textarea>
                            </div>

                            <div class="form-group form-row-full">
                                <label for="series-cover">Kapak Görseli (Google Drive Link) *</label>
                                <div style="display: flex; gap: 10px;">
                                    <input type="url" id="series-cover" placeholder="https://drive.google.com/file/d/..." style="flex: 1;">
                                    <button type="button" class="btn secondary small" onclick="validateCoverImage()">🔍 Görseli Doğrula</button>
                                </div>
                            </div>

                            <div class="form-group form-row-full">
                                <label for="series-genres">Seri Türleri (virgülle ayırarak yazın)</label>
                                <input type="text" id="series-genres" placeholder="Aksiyon, Fantastik, Dram...">
                                <small style="color: #666; font-size: 14px; margin-top: 5px; display: block;">Örnek: Aksiyon, Fantastik, Dram, Komedi</small>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label for="series-author">Yazar</label>
                                    <input type="text" id="series-author">
                                </div>
                                <div class="form-group">
                                    <label for="series-artist">Çizer</label>
                                    <input type="text" id="series-artist">
                                </div>
                            </div>

                            <div class="form-group form-row-full">
                                <label for="series-publisher">Yayıncı</label>
                                <input type="text" id="series-publisher">
                            </div>

                            <!-- Seri Etiketi -->
                            <div class="form-group form-row-full">
                                <label>📋 Seri Etiketi</label>
                                <div class="label-config">
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label for="series-label-enabled">Etiket Durumu</label>
                                            <select id="series-label-enabled" onchange="toggleLabelSettings()">
                                                <option value="none">Etiket Yok</option>
                                                <option value="false">Etiketi Gizle</option>
                                                <option value="true">Etiketi Göster</option>
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <div id="label-settings" style="display: none;">
                                        <div class="form-row">
                                            <div class="form-group">
                                                <label for="series-label-text">Etiket Metni</label>
                                                <select id="series-label-text" onchange="updateLabelPreview()">
                                                    <option value="Yeni">🌟 Yeni</option>
                                                    <option value="Güncel">🔥 Güncel</option>
                                                    <option value="Yeni Sezon">📺 Yeni Sezon</option>
                                                    <option value="Sezon Finali">🏁 Sezon Finali</option>
                                                    <option value="Popüler">⭐ Popüler</option>
                                                    <option value="Tamamlandı">✅ Tamamlandı</option>
                                                    <option value="Ara Verildi">⏸️ Ara Verildi</option>
                                                    <option value="Bırakıldı">🛑 Bırakıldı</option>
                                                </select>
                                            </div>
                                            
                                            <div class="form-group">
                                                <label for="series-label-color">Etiket Rengi</label>
                                                <select id="series-label-color" onchange="updateLabelPreview()">
                                                    <option value="#4CAF50">🟢 Yeşil (Yeni)</option>
                                                    <option value="#FF9800">🟠 Turuncu (Güncel)</option>
                                                    <option value="#2196F3">🔵 Mavi (Sezon)</option>
                                                    <option value="#9C27B0">🟣 Mor (Final)</option>
                                                    <option value="#F44336">🔴 Kırmızı (Popüler)</option>
                                                    <option value="#607D8B">⚫ Gri (Tamamlandı)</option>
                                                    <option value="#FFC107">🟡 Sarı (Ara Verildi)</option>
                                                    <option value="#795548">🤎 Kahverengi (Bırakıldı)</option>
                                                </select>
                                            </div>
                                        </div>
                                        
                                        <div class="label-preview">
                                            <span>Önizleme: </span>
                                            <span id="label-preview-badge" class="series-label" style="background: #4CAF50;">🌟 Yeni</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div id="cover-preview" class="preview-container" style="display: none;">
                                <h4>📸 Kapak Önizleme:</h4>
                                <img id="cover-preview-img" style="max-width: 200px; border-radius: 8px;">
                            </div>

                            <button type="submit" class="btn" style="width: 100%; margin-top: 20px;">
                                💾 Seri Bilgilerini Güncelle
                            </button>
                        </form>
                    </div>

                    <!-- Bölümler Tab -->
                    <div id="chapters" class="tab-content">
                        <div class="chapter-list" id="chapter-list">
                            <!-- Bölümler buraya yüklenecek -->
                        </div>
                    </div>

                    <!-- Bölüm Ekle Tab -->
                    <div id="add-chapter" class="tab-content">
                        <form id="add-chapter-form">
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="chapter-number">Bölüm Numarası *</label>
                                    <input type="number" id="chapter-number" name="chapterNumber" required min="1">
                                </div>
                                <div class="form-group">
                                    <label for="chapter-title">Bölüm Başlığı</label>
                                    <input type="text" id="chapter-title" name="title" placeholder="Opsiyonel">
                                </div>
                            </div>

                            <div class="form-group">
                                <label>Bölüm Görselleri (Google Drive Links) *</label>
                                <div class="images-input-container">
                                    <div id="image-inputs">
                                        <div class="image-input-item">
                                            <input type="url" placeholder="Sayfa 1 Google Drive linki" required>
                                            <button type="button" class="btn danger small" onclick="removeImageInput(this)">Sil</button>
                                        </div>
                                    </div>
                                    <button type="button" class="btn secondary" onclick="addImageInput()">➕ Görsel Ekle</button>
                                </div>
                            </div>

                            <div id="images-preview" class="preview-container" style="display: none;">
                                <h4>🖼️ Görsel Önizleme:</h4>
                                <div class="preview-images" id="preview-images-container"></div>
                            </div>

                            <div style="display: flex; gap: 10px; margin-top: 20px;">
                                <button type="submit" class="btn" style="flex: 1;">📖 Bölüm Ekle</button>
                                <button type="button" class="btn secondary" onclick="previewImages()" style="flex: 1;">🔍 Görselleri Önizle</button>
                            </div>
                        </form>
                    </div>

                    <!-- Bölüm Düzenle Tab -->
                    <div id="edit-chapter" class="tab-content">
                        <div class="form-group">
                            <label for="edit-chapter-select">Düzenlenecek Bölüm</label>
                            <select id="edit-chapter-select" onchange="loadChapterForEdit()">
                                <option value="">-- Bölüm Seçin --</option>
                            </select>
                        </div>

                        <div id="edit-chapter-form-container" style="display: none;">
                            <form id="edit-chapter-form">
                                <input type="hidden" id="edit-chapter-original-number">
                                
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="edit-chapter-number">Bölüm Numarası *</label>
                                        <input type="number" id="edit-chapter-number" required min="1">
                                    </div>
                                    <div class="form-group">
                                        <label for="edit-chapter-title">Bölüm Başlığı</label>
                                        <input type="text" id="edit-chapter-title" required>
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label>Görsel URL'leri *</label>
                                    <div id="edit-image-inputs" class="images-input-container">
                                        <!-- Dinamik olarak doldurulacak -->
                                    </div>
                                    <button type="button" class="btn secondary" onclick="addEditImageInput()">➕ Görsel Ekle</button>
                                </div>

                                <div id="edit-images-preview" class="preview-container" style="display: none;">
                                    <h4>🖼️ Güncel Görsel Önizleme:</h4>
                                    <div class="preview-images" id="edit-preview-images-container"></div>
                                </div>
                                
                                <div style="display: flex; gap: 10px; margin-top: 20px;">
                                    <button type="submit" class="btn">💾 Güncelle</button>
                                    <button type="button" class="btn secondary" onclick="previewEditImages()">🔍 Önizle</button>
                                    <button type="button" class="btn danger" onclick="deleteSelectedChapter()">🗑️ Sil</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="config.js?v=5"></script>
    <script>
        // API Base URL
        const API_BASE = 'https://toonnekoauth-api.onrender.com/api';
        
        // Sayfa yüklendiğinde
        document.addEventListener('DOMContentLoaded', function() {
            checkAuthentication();
        });

        // Giriş kontrolü
        function checkAuthentication() {
            const token = localStorage.getItem('token');
            if (!token) {
                showLoginForm();
                return;
            }
            
            // Token'ı doğrula ve profil bilgilerini al
            loadModeratorProfile();
        }

        // Giriş formunu göster
        function showLoginForm() {
            document.getElementById('main-content').style.display = 'none';
            document.getElementById('login-section').style.display = 'block';
        }

        // Ana içeriği göster
        function showMainContent() {
            document.getElementById('login-section').style.display = 'none';
            document.getElementById('main-content').style.display = 'block';
        }

        // Giriş formu
        document.getElementById('login-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const identifier = document.getElementById('login-identifier').value;
            const password = document.getElementById('login-password').value;
            
            try {
                const response = await fetch(`${API_BASE}/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ identifier, password })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Giriş başarısız');
                }

                // Token'ı kaydet
                localStorage.setItem('token', data.token);
                
                // Moderatör yetki kontrolü
                await checkModeratorPermission();
                
            } catch (error) {
                showAlert('error', error.message);
            }
        });

        // Moderatör yetki kontrolü
        async function checkModeratorPermission() {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`${API_BASE}/moderator/profile`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    throw new Error('Moderatör yetkisi bulunamadı');
                }

                const profile = await response.json();
                
                if (!profile.isAdmin && !profile.isModerator) {
                    throw new Error('Bu sayfaya erişim yetkiniz yok');
                }

                // Başarılı giriş
                showMainContent();
                loadModeratorProfile();
                loadModeratorSeries();
                
            } catch (error) {
                localStorage.removeItem('token');
                showAlert('error', error.message);
            }
        }

        // Moderatör profil bilgilerini yükle
        async function loadModeratorProfile() {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`${API_BASE}/moderator/profile`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    throw new Error('Profil bilgileri alınamadı');
                }

                const profile = await response.json();
                displayProfile(profile);
                
            } catch (error) {
                console.error('Profil yükleme hatası:', error);
                logout();
            }
        }

        // Profil bilgilerini göster
        function displayProfile(profile) {
            document.getElementById('profile-username').textContent = profile.username;
            document.getElementById('profile-email').textContent = profile.email;
            
            const typeText = profile.isAdmin ? 'Admin (Tüm Yetkiler)' : `Moderatör (${profile.moderatorSeries.length} Seri)`;
            document.getElementById('profile-type').textContent = typeText;
            
            const badges = document.getElementById('profile-badges');
            const badgeClass = profile.isAdmin ? 'admin' : 'moderator';
            const badgeText = profile.isAdmin ? '👑 Admin' : '🛡️ Moderatör';
            badges.innerHTML = `<span class="badge ${badgeClass}">${badgeText}</span>`;
            
            // Avatar'ı güncelle
            document.getElementById('profile-avatar').textContent = profile.isAdmin ? '👑' : '🛡️';
        }

        // Moderatör serilerini yükle
        async function loadModeratorSeries() {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`${API_BASE}/moderator/my-series`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    throw new Error('Seriler yüklenemedi');
                }

                const data = await response.json();
                displaySeries(data);
                
            } catch (error) {
                console.error('Serileri yükleme hatası:', error);
                showAlert('error', 'Seriler yüklenirken hata oluştu');
            }
        }

        // Serileri göster
        function displaySeries(data) {
            const loading = document.getElementById('series-loading');
            const content = document.getElementById('series-content');
            const grid = document.getElementById('series-grid');

            loading.style.display = 'none';
            content.style.display = 'block';

            if (!data.series || data.series.length === 0) {
                grid.innerHTML = '<div class="no-series">Henüz atanmış seri bulunmuyor</div>';
                return;
            }

            grid.innerHTML = data.series.map(series => `
                <div class="series-card">
                    <div class="series-title">${escapeHtml(series.title)}</div>
                    <div class="series-status ${series.status === 'Devam Ediyor' ? 'status-ongoing' : 'status-completed'}">
                        ${series.status || 'Bilinmiyor'}
                    </div>
                    <div class="chapter-count">
                        📖 ${series.chapters.length} Bölüm
                    </div>
                    <div style="margin-top: 15px; display: flex; gap: 10px;">
                        <button class="btn" onclick="openSeriesModal('${series.id}')" style="flex: 1;">
                            ⚙️ Düzenle
                        </button>
                        <button class="btn secondary" onclick="viewSeries('${series.id}')" style="flex: 1;">
                            👁️ Görüntüle
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // Seri yönetimi
        function manageSeries(seriesId) {
            // Admin paneline yönlendir (belirli seri ile)
            window.open(`/admin-panel.html?series=${seriesId}`, '_blank');
        }

        // Seri görüntüle
        function viewSeries(seriesId) {
            window.open(`/series/${seriesId}/${seriesId}seri.html`, '_blank');
        }

        // Global değişkenler
        let currentSeriesId = null;
        let currentSeriesData = null;

        // Seri modal aç
        async function openSeriesModal(seriesId) {
            currentSeriesId = seriesId;
            
            try {
                // Seri detaylarını al
                await loadSeriesDetails(seriesId);
                
                // Modal'ı göster
                document.getElementById('series-management-modal').style.display = 'block';
                
                // İlk tab'ı aktif yap
                switchTab('series-info');
                
            } catch (error) {
                console.error('Seri modal açma hatası:', error);
                showAlert('error', 'Seri bilgileri yüklenemedi');
            }
        }

        // Seri detaylarını yükle
        async function loadSeriesDetails(seriesId) {
            try {
                console.log('loadSeriesDetails: Loading details for series:', seriesId);
                
                const token = localStorage.getItem('token');
                const response = await fetch(`${API_BASE}/moderator/series/${seriesId}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    throw new Error('Seri detayları alınamadı');
                }

                currentSeriesData = await response.json();
                console.log('loadSeriesDetails: Received series data from server:', currentSeriesData);
                
                if (!currentSeriesData) {
                    throw new Error('Seri bulunamadı');
                }

                // Form alanlarını doldur
                populateSeriesForm();
                loadChaptersList();
                
            } catch (error) {
                console.error('Seri detayları yükleme hatası:', error);
                throw error;
            }
        }

        // Seri form alanlarını doldur
        function populateSeriesForm() {
            if (!currentSeriesData) {
                console.error('populateSeriesForm: currentSeriesData is null');
                return;
            }
            
            console.log('populateSeriesForm: Loading series data:', currentSeriesData);
            
            // Modal başlığını güncelle
            const modalTitle = document.getElementById('modal-series-title');
            if (modalTitle) {
                modalTitle.textContent = `${currentSeriesData.title} - Yönetim`;
            }
            
            // Her alanı tek tek debug ederek kontrol et
            try {
                // Series title
                const titleElement = document.getElementById('series-title');
                if (titleElement) {
                    console.log('Setting series-title to:', currentSeriesData.title);
                    titleElement.value = currentSeriesData.title || '';
                } else {
                    console.error('Element not found: series-title');
                }
                
                // Series status
                const statusElement = document.getElementById('series-status');
                if (statusElement) {
                    console.log('Setting series-status to:', currentSeriesData.status);
                    statusElement.value = currentSeriesData.status || 'Devam Ediyor';
                } else {
                    console.error('Element not found: series-status');
                }
                
                // Series author
                const authorElement = document.getElementById('series-author');
                if (authorElement) {
                    console.log('Setting series-author to:', currentSeriesData.author);
                    authorElement.value = currentSeriesData.author || '';
                } else {
                    console.error('Element not found: series-author');
                }
                
                // Series artist
                const artistElement = document.getElementById('series-artist');
                if (artistElement) {
                    console.log('Setting series-artist to:', currentSeriesData.artist);
                    artistElement.value = currentSeriesData.artist || '';
                } else {
                    console.error('Element not found: series-artist');
                }
                
                // Series publisher
                const publisherElement = document.getElementById('series-publisher');
                if (publisherElement) {
                    console.log('Setting series-publisher to:', currentSeriesData.publisher);
                    publisherElement.value = currentSeriesData.publisher || '';
                } else {
                    console.error('Element not found: series-publisher');
                }
                
                // Series summary
                const summaryElement = document.getElementById('series-summary');
                if (summaryElement) {
                    console.log('Setting series-summary to:', currentSeriesData.summary);
                    summaryElement.value = currentSeriesData.summary || '';
                } else {
                    console.error('Element not found: series-summary');
                }
                
                // Türleri string olarak birleştir
                const genresElement = document.getElementById('series-genres');
                if (genresElement) {
                    const genres = currentSeriesData.genres || [];
                    console.log('Setting series-genres to:', genres);
                    genresElement.value = Array.isArray(genres) ? genres.join(', ') : '';
                } else {
                    console.error('Element not found: series-genres');
                }
                
                // Kapak görselini ayarla
                const coverElement = document.getElementById('series-cover');
                if (coverElement && currentSeriesData.image) {
                    console.log('Setting series-cover to:', currentSeriesData.image);
                    coverElement.value = currentSeriesData.image;
                    // Eğer proxy URL ise önizlemeyi göster
                    if (currentSeriesData.image.includes('/api/image/proxy-image/')) {
                        const previewImg = document.getElementById('cover-preview-img');
                        const coverPreview = document.getElementById('cover-preview');
                        if (previewImg && coverPreview) {
                            previewImg.src = currentSeriesData.image;
                            coverPreview.style.display = 'block';
                        }
                    }
                } else if (!coverElement) {
                    console.error('Element not found: series-cover');
                }
                
                // Etiket bilgilerini yükle
                const labelEnabledElement = document.getElementById('series-label-enabled');
                const labelTextElement = document.getElementById('series-label-text');
                const labelColorElement = document.getElementById('series-label-color');
                
                if (currentSeriesData.label && labelEnabledElement && labelTextElement && labelColorElement) {
                    const label = currentSeriesData.label;
                    console.log('Setting label info:', label);
                    
                    // Etiket durumunu ayarla
                    if (label.enabled === true) {
                        labelEnabledElement.value = 'true';
                    } else if (label.enabled === false) {
                        labelEnabledElement.value = 'false';
                    } else {
                        labelEnabledElement.value = 'none';
                    }
                    
                    // Etiket metni ve rengini ayarla
                    if (label.text) {
                        labelTextElement.value = label.text;
                    }
                    if (label.color) {
                        labelColorElement.value = label.color;
                    }
                } else if (labelEnabledElement && labelTextElement && labelColorElement) {
                    console.log('No label info found, setting defaults');
                    // Varsayılan değerler
                    labelEnabledElement.value = 'none';
                    labelTextElement.value = 'Yeni';
                    labelColorElement.value = '#4CAF50';
                } else {
                    console.error('One or more label elements not found');
                }
                
                // Etiket ayarlarını göster/gizle ve önizlemeyi güncelle
                if (typeof toggleLabelSettings === 'function') {
                    toggleLabelSettings();
                }
                if (typeof updateLabelPreview === 'function') {
                    updateLabelPreview();
                }
                
                // Bir sonraki bölüm numarasını hesapla
                const chapterNumberElement = document.getElementById('chapter-number');
                if (chapterNumberElement) {
                    const chapters = currentSeriesData.chapters || [];
                    const nextChapterNumber = chapters.length > 0 ? Math.max(...chapters.map(ch => ch.number)) + 1 : 1;
                    chapterNumberElement.value = nextChapterNumber;
                } else {
                    console.error('Element not found: chapter-number');
                }
                
                // Bölüm düzenleme seçeneklerini yükle
                if (typeof loadChapterSelectOptions === 'function') {
                    loadChapterSelectOptions();
                }
                
                console.log('populateSeriesForm: Form successfully populated');
                
            } catch (error) {
                console.error('populateSeriesForm: Error populating form:', error);
            }
        }

        // Bölümler listesini yükle
        function loadChaptersList() {
            if (!currentSeriesData || !currentSeriesData.chapters) return;
            
            const chapterList = document.getElementById('chapter-list');
            
            if (currentSeriesData.chapters.length === 0) {
                chapterList.innerHTML = '<div class="no-series">Henüz bölüm eklenmemiş</div>';
                return;
            }
            
            // Admin panel tarzında grid layout kullan
            const chaptersHtml = currentSeriesData.chapters.map(chapter => `
                <div class="chapter-card">
                    <h4>Bölüm ${chapter.number}: ${escapeHtml(chapter.title || `Bölüm ${chapter.number}`)}</h4>
                    <div class="chapter-info">
                        📅 ${chapter.uploadDate ? new Date(chapter.uploadDate).toLocaleDateString('tr-TR') : 'Tarih bilinmiyor'}<br>
                        🖼️ ${chapter.imageUrls ? chapter.imageUrls.length : (chapter.imageCount || 0)} görsel<br>
                        📁 ${chapter.filename || `chapter-${chapter.number}.html`}
                    </div>
                    <div class="chapter-actions">
                        <button class="btn btn-small" onclick="editChapterFromList(${chapter.number})">✏️ Düzenle</button>
                        <button class="btn btn-small danger" onclick="deleteChapter(${chapter.number})">🗑️ Sil</button>
                        <button class="btn btn-small secondary" onclick="viewChapter('${currentSeriesId}', ${chapter.number})">👁️ Görüntüle</button>
                    </div>
                </div>
            `).join('');
            
            chapterList.innerHTML = `<div class="chapters-grid">${chaptersHtml}</div>`;
        }

        // Tab değiştir
        function switchTab(tabName) {
            // Tüm tab butonlarını pasif yap
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            // Seçili tab'ı aktif yap
            document.querySelector(`[onclick="switchTab('${tabName}')"]`).classList.add('active');
            document.getElementById(tabName).classList.add('active');
        }

        // Modal kapat
        function closeSeriesModal() {
            document.getElementById('series-management-modal').style.display = 'none';
            currentSeriesId = null;
            currentSeriesData = null;
        }

        // Bölüm görüntüle
        function viewChapter(seriesId, chapterNumber) {
            window.open(`/chapters/${seriesId}/${seriesId}-chapter-${chapterNumber}.html`, '_blank');
        }

        // Listeden bölüm düzenleme
        function editChapterFromList(chapterNumber) {
            // Düzenleme tab'ına geç
            switchTab('edit-chapter');
            
            // Bölüm seçeneğini ayarla
            document.getElementById('edit-chapter-select').value = chapterNumber;
            loadChapterForEdit();
        }

        // Show status message (admin panel'den)
        function showStatus(message, type) {
            const statusDiv = document.getElementById('status-message');
            statusDiv.textContent = message;
            statusDiv.className = `status-message ${type}`;
            statusDiv.style.display = 'block';
            
            setTimeout(() => {
                statusDiv.style.display = 'none';
            }, 5000);
        }

        // Show/hide loading (admin panel'den)
        function toggleLoading(show) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
        }

        function showLoading(show) {
            toggleLoading(show);
        }

        // Bölüm sil - Admin panel tarzı gelişmiş versiyon
        async function deleteChapter(chapterNumber) {
            if (!confirm(`Bölüm ${chapterNumber}'ü silmek istediğinizden emin misiniz?\n\nBu işlem geri alınamaz ve tüm bölüm dosyaları silinecektir.`)) {
                return;
            }
            
            try {
                toggleLoading(true);
                showStatus(`Bölüm ${chapterNumber} siliniyor...`, 'info');
                
                const token = localStorage.getItem('token');
                const response = await fetch(`${API_BASE}/moderator/delete-chapter/${currentSeriesId}/${chapterNumber}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Bölüm silinemedi');
                }

                const result = await response.json();
                showStatus(result.message || `Bölüm ${chapterNumber} başarıyla silindi!`, 'success');
                
                // Bölümler listesini yenile
                await loadSeriesDetails(currentSeriesId);
                
                // Seri listesini yenile
                loadModeratorSeries();
                
                // Eğer düzenleme formunda bu bölüm seçiliyse temizle
                if (document.getElementById('edit-chapter-select').value == chapterNumber) {
                    document.getElementById('edit-chapter-form-container').style.display = 'none';
                    document.getElementById('edit-chapter-select').value = '';
                }
                
            } catch (error) {
                console.error('Bölüm silme hatası:', error);
                showStatus(error.message || 'Bölüm silinirken hata oluştu', 'error');
            } finally {
                toggleLoading(false);
            }
        }

        // Form submit event'leri
        document.addEventListener('DOMContentLoaded', function() {
            // Seri bilgileri form
            document.getElementById('series-info-form').addEventListener('submit', async function(e) {
                e.preventDefault();
                await updateSeriesInfo();
            });
            
            // Bölüm ekleme form
            document.getElementById('add-chapter-form').addEventListener('submit', async function(e) {
                e.preventDefault();
                await addNewChapter();
            });
            
            // Bölüm düzenleme form
            document.getElementById('edit-chapter-form').addEventListener('submit', async function(e) {
                e.preventDefault();
                await updateChapter();
            });
            
            // Modal dışına tıklayınca kapat
            document.getElementById('series-management-modal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeSeriesModal();
                }
            });
        });

        // Bölüm güncelle - Admin panel tarzı gelişmiş versiyon
        async function updateChapter() {
            try {
                const originalNumber = parseInt(document.getElementById('edit-chapter-original-number').value);
                const newNumber = parseInt(document.getElementById('edit-chapter-number').value);
                const title = document.getElementById('edit-chapter-title').value;
                
                // Görsel URL'lerini topla ve doğrula
                const imageInputs = document.querySelectorAll('#edit-image-inputs input[type="url"]');
                const imageUrls = [];
                
                for (let input of imageInputs) {
                    const url = input.value.trim();
                    if (url) {
                        // Eğer proxy URL değilse ve Google Drive linkiyse dönüştür
                        if (!url.includes('/api/image/proxy-image/') && url.includes('drive.google.com')) {
                            const fileId = extractFileId(url);
                            if (fileId) {
                                imageUrls.push(createProxyUrl(fileId));
                            } else {
                                showStatus('Geçersiz Google Drive linki: ' + url, 'error');
                                return;
                            }
                        } else {
                            imageUrls.push(url);
                        }
                    }
                }
                
                if (imageUrls.length === 0) {
                    showStatus('En az bir görsel URL\'si gerekli', 'error');
                    return;
                }

                // Bölüm numarası kontrolü
                if (!newNumber || newNumber < 1) {
                    showStatus('Geçerli bir bölüm numarası girin', 'error');
                    return;
                }

                // Başlık kontrolü
                if (!title || title.trim() === '') {
                    showStatus('Bölüm başlığı gerekli', 'error');
                    return;
                }

                // Bölüm numarası değiştiyse çakışma kontrolü
                if (newNumber !== originalNumber) {
                    const existingChapter = currentSeriesData.chapters.find(ch => ch.number === newNumber);
                    if (existingChapter) {
                        if (!confirm(`Bölüm ${newNumber} zaten mevcut. Üzerine yazmak istiyor musunuz?`)) {
                            return;
                        }
                    }
                }
                
                const updateData = {
                    newNumber: newNumber,
                    title: title.trim(),
                    imageUrls: imageUrls
                };
                
                toggleLoading(true);
                showStatus(`Bölüm ${originalNumber} güncelleniyor... (${imageUrls.length} görsel)`, 'info');
                
                const token = localStorage.getItem('token');
                const response = await fetch(`${API_BASE}/moderator/update-chapter/${currentSeriesId}/${originalNumber}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(updateData)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Bölüm güncellenemedi');
                }

                const result = await response.json();
                showStatus(result.message || `Bölüm ${newNumber} başarıyla güncellendi! (${imageUrls.length} görsel)`, 'success');
                
                // Bölümler listesini yenile
                await loadSeriesDetails(currentSeriesId);
                
                // Seri listesini yenile
                loadModeratorSeries();
                
                // Düzenleme formunu temizle
                document.getElementById('edit-chapter-form-container').style.display = 'none';
                document.getElementById('edit-chapter-select').value = '';
                document.getElementById('edit-images-preview').style.display = 'none';
                
                // Bölümler tab'ına geç
                switchTab('chapters');
                
            } catch (error) {
                console.error('Bölüm güncelleme hatası:', error);
                showStatus(error.message || 'Bölüm güncellenirken hata oluştu', 'error');
            } finally {
                toggleLoading(false);
            }
        }

        // Seri bilgilerini güncelle - Admin panel tarzı
        async function updateSeriesInfo() {
            try {
                let coverUrl = document.getElementById('series-cover').value.trim();
                
                // Eğer Google Drive link'i verilmişse proxy URL'e çevir
                if (coverUrl && coverUrl.includes('drive.google.com')) {
                    const fileId = extractFileId(coverUrl);
                    if (fileId) {
                        coverUrl = createProxyUrl(fileId);
                    } else {
                        showStatus('Geçersiz Google Drive linki', 'error');
                        return;
                    }
                }
                
                const formData = {
                    title: document.getElementById('series-title').value,
                    status: document.getElementById('series-status').value,
                    author: document.getElementById('series-author').value,
                    artist: document.getElementById('series-artist').value,
                    publisher: document.getElementById('series-publisher').value,
                    summary: document.getElementById('series-summary').value,
                    genres: document.getElementById('series-genres').value.split(',').map(g => g.trim()).filter(g => g),
                    image: coverUrl
                };
                
                // Etiket bilgilerini ekle
                const labelEnabled = document.getElementById('series-label-enabled').value;
                if (labelEnabled !== 'none') {
                    formData.label = {
                        enabled: labelEnabled === 'true',
                        text: document.getElementById('series-label-text').value,
                        color: document.getElementById('series-label-color').value
                    };
                } else {
                    formData.label = null; // Etiket kaldır
                }

                // Zorunlu alanları kontrol et
                if (!formData.title || !formData.status) {
                    showStatus('Lütfen tüm zorunlu alanları doldurun (Başlık, Durum)', 'error');
                    return;
                }
                
                toggleLoading(true);
                showStatus('Seri bilgileri güncelleniyor...', 'info');
                
                const token = localStorage.getItem('token');
                const response = await fetch(`${API_BASE}/moderator/update-series/${currentSeriesId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(formData)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Seri güncellenemedi');
                }

                const result = await response.json();
                showStatus(result.message || 'Seri bilgileri başarıyla güncellendi!', 'success');
                
                // Seri listesini yenile
                loadModeratorSeries();
                
                // Mevcut seri verisini güncelle
                await loadSeriesDetails(currentSeriesId);
                
            } catch (error) {
                console.error('Seri güncelleme hatası:', error);
                showStatus(error.message || 'Seri bilgileri güncellenirken hata oluştu', 'error');
            } finally {
                toggleLoading(false);
            }
        }

        // Yeni bölüm ekle - Admin panel tarzı gelişmiş versiyon
        async function addNewChapter() {
            try {
                const chapterNumber = parseInt(document.getElementById('chapter-number').value);
                const chapterTitle = document.getElementById('chapter-title').value || `Bölüm ${chapterNumber}`;
                
                // Google Drive linklerini topla ve doğrula
                const imageInputs = document.querySelectorAll('#image-inputs input[type="url"]');
                const imageUrls = [];
                
                for (let input of imageInputs) {
                    const url = input.value.trim();
                    if (url) {
                        const fileId = extractFileId(url);
                        if (fileId) {
                            // Proxy URL oluştur
                            imageUrls.push(createProxyUrl(fileId));
                        } else {
                            showStatus('Geçersiz Google Drive linki: ' + url, 'error');
                            return;
                        }
                    }
                }
                
                if (imageUrls.length === 0) {
                    showStatus('En az bir Google Drive görseli gerekli', 'error');
                    return;
                }

                // Bölüm numarası kontrolü
                if (!chapterNumber || chapterNumber < 1) {
                    showStatus('Geçerli bir bölüm numarası girin', 'error');
                    return;
                }

                // Mevcut bölümlerle çakışma kontrolü
                const existingChapter = currentSeriesData.chapters.find(ch => ch.number === chapterNumber);
                if (existingChapter) {
                    if (!confirm(`Bölüm ${chapterNumber} zaten mevcut. Üzerine yazmak istiyor musunuz?`)) {
                        return;
                    }
                }
                
                const chapterData = {
                    number: chapterNumber,
                    title: chapterTitle,
                    imageUrls: imageUrls
                };
                
                toggleLoading(true);
                showStatus(`Bölüm ${chapterNumber} ekleniyor... (${imageUrls.length} görsel)`, 'info');
                
                const token = localStorage.getItem('token');
                const response = await fetch(`${API_BASE}/moderator/add-chapter/${currentSeriesId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(chapterData)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Bölüm eklenemedi');
                }

                const result = await response.json();
                showStatus(result.message || `Bölüm ${chapterNumber} başarıyla eklendi! (${imageUrls.length} görsel)`, 'success');
                
                // Formu temizle
                document.getElementById('add-chapter-form').reset();
                resetImageInputs();
                document.getElementById('images-preview').style.display = 'none';
                
                // Bir sonraki bölüm numarasını ayarla
                document.getElementById('chapter-number').value = chapterNumber + 1;
                
                // Bölümler listesini yenile
                await loadSeriesDetails(currentSeriesId);
                
                // Seri listesini yenile
                loadModeratorSeries();
                
                // Bölümler tab'ına geç
                switchTab('chapters');
                
            } catch (error) {
                console.error('Bölüm ekleme hatası:', error);
                showStatus(error.message || 'Bölüm eklenirken hata oluştu', 'error');
            } finally {
                toggleLoading(false);
            }
        }

        // Google Drive Helper Functions
        function extractFileId(driveUrl) {
            const match = driveUrl.match(/\/file\/d\/([a-zA-Z0-9_-]+)/);
            return match ? match[1] : null;
        }
        
        function createProxyUrl(fileId) {
            return `${API_BASE}/image/proxy-image/${fileId}`;
        }

        // Resim input yönetimi - Admin panel tarzı
        function addImageInput() {
            const container = document.getElementById('image-inputs');
            const inputCount = container.children.length;
            
            const newInputItem = document.createElement('div');
            newInputItem.className = 'image-input-item';
            newInputItem.innerHTML = `
                <input type="url" placeholder="Sayfa ${inputCount + 1} Google Drive linki" required>
                <button type="button" class="btn danger small" onclick="removeImageInput(this)">Sil</button>
            `;
            
            container.appendChild(newInputItem);
        }

        function removeImageInput(button) {
            const container = document.getElementById('image-inputs');
            if (container.children.length > 1) {
                button.parentElement.remove();
                updateImagePlaceholders();
            } else {
                showStatus('En az bir görsel gerekli', 'error');
            }
        }

        function updateImagePlaceholders() {
            const inputs = document.querySelectorAll('#image-inputs input[type="url"]');
            inputs.forEach((input, index) => {
                input.placeholder = `Sayfa ${index + 1} Google Drive linki`;
            });
        }

        function resetImageInputs() {
            const container = document.getElementById('image-inputs');
            container.innerHTML = `
                <div class="image-input-item">
                    <input type="url" placeholder="Sayfa 1 Google Drive linki" required>
                    <button type="button" class="btn danger small" onclick="removeImageInput(this)">Sil</button>
                </div>
            `;
        }

        // Görsel önizleme - Admin panel tarzı
        async function previewImages() {
            const imageInputs = document.querySelectorAll('#image-inputs input');
            const urls = Array.from(imageInputs).map(input => input.value).filter(url => url);
            
            if (urls.length === 0) {
                showStatus('Lütfen en az bir görsel linki girin', 'error');
                return;
            }

            toggleLoading(true);
            
            const previewContainer = document.getElementById('preview-images-container');
            previewContainer.innerHTML = '';
            
            // Convert URLs to proxy format and display images
            for (let i = 0; i < urls.length; i++) {
                const fileId = extractFileId(urls[i]);
                
                if (fileId) {
                    const proxyUrl = createProxyUrl(fileId);
                    
                    const imgContainer = document.createElement('div');
                    imgContainer.style.cssText = 'margin: 10px; text-align: center; border: 1px solid #ddd; padding: 10px; border-radius: 5px;';
                    
                    const img = document.createElement('img');
                    img.className = 'preview-image';
                    img.alt = `Sayfa ${i + 1}`;
                    img.style.cssText = 'max-width: 150px; border: 2px solid #28a745; border-radius: 5px;';
                    
                    const label = document.createElement('p');
                    label.innerHTML = `<strong>Sayfa ${i + 1}</strong><br><small>Proxy URL</small>`;
                    
                    img.onload = function() {
                        img.style.borderColor = '#28a745';
                        label.innerHTML = `<strong>Sayfa ${i + 1} ✅</strong><br><small>${img.naturalWidth}x${img.naturalHeight}px</small>`;
                    };
                    
                    img.onerror = function() {
                        img.style.borderColor = '#dc3545';
                        img.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgZmlsbD0iI2Y4ZjlmYSIvPjx0ZXh0IHg9IjUwIiB5PSI1MCIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjE0IiBmaWxsPSIjNmM3NTdkIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBkeT0iMC4zZW0iPkVycm9yPC90ZXh0Pjwvc3ZnPg==';
                        label.innerHTML = `<strong>Sayfa ${i + 1} ❌</strong><br><small>Yüklenemedi</small>`;
                    };
                    
                    img.src = proxyUrl;
                    
                    imgContainer.appendChild(label);
                    imgContainer.appendChild(img);
                    previewContainer.appendChild(imgContainer);
                } else {
                    const errorDiv = document.createElement('div');
                    errorDiv.textContent = `Sayfa ${i + 1}: Geçersiz Google Drive link`;
                    errorDiv.style.color = 'red';
                    previewContainer.appendChild(errorDiv);
                }
            }
            
            document.getElementById('images-preview').style.display = 'block';
            toggleLoading(false);
        }

        // Kapak görseli doğrulama - Admin panel tarzı
        async function validateCoverImage() {
            const coverUrl = document.getElementById('series-cover').value;
            if (!coverUrl) {
                showStatus('Lütfen kapak görseli linkini girin', 'error');
                return;
            }

            const fileId = extractFileId(coverUrl);
            if (!fileId) {
                showStatus('Geçersiz Google Drive link formatı!', 'error');
                return;
            }

            toggleLoading(true);
            showStatus(`File ID: ${fileId} - Test başlatılıyor...`, 'info');
            
            try {
                // Test multiple URL formats
                const proxyUrl = `${API_BASE}/image/proxy-image/${fileId}`;
                const directUrls = createDirectUrls(fileId);
                
                console.log('Testing URLs:', { proxyUrl, directUrls });
                
                // Clear previous preview
                const previewDiv = document.getElementById('cover-preview');
                previewDiv.innerHTML = `
                    <h4>📸 Görsel Test Sonuçları:</h4>
                    <div id="test-results"></div>
                `;
                previewDiv.style.display = 'block';
                
                const resultsDiv = document.getElementById('test-results');
                
                // Test proxy URL first (recommended)
                await testImageFormat(resultsDiv, 'Server Proxy (Önerilen)', proxyUrl, true);
                
                // Test direct formats
                await testImageFormat(resultsDiv, 'High Quality Direct', directUrls.high, false);
                await testImageFormat(resultsDiv, 'Download Format', directUrls.download, false);
                await testImageFormat(resultsDiv, 'Medium Quality', directUrls.medium, false);
                
            } catch (error) {
                showStatus('Doğrulama sırasında hata oluştu: ' + error.message, 'error');
                console.error('Validation error:', error);
            }
            
            toggleLoading(false);
        }

        // Direct URL'ler oluştur
        function createDirectUrls(fileId) {
            return {
                proxy: `${API_BASE}/image/proxy-image/${fileId}`,
                high: `https://drive.google.com/uc?export=view&id=${fileId}`,
                download: `https://drive.usercontent.google.com/download?id=${fileId}&authuser=0`,
                medium: `https://drive.google.com/uc?id=${fileId}`,
                thumbnail: `https://drive.google.com/thumbnail?id=${fileId}&sz=s1600`
            };
        }

        // Görsel format testi
        async function testImageFormat(container, formatName, url, isRecommended) {
            return new Promise((resolve) => {
                const testDiv = document.createElement('div');
                testDiv.style.cssText = `
                    margin: 10px 0; 
                    padding: 10px; 
                    border: 1px solid #ddd; 
                    border-radius: 5px;
                    background: ${isRecommended ? '#e8f5e8' : '#f8f9fa'};
                `;
                
                testDiv.innerHTML = `
                    <h5>${isRecommended ? '🛡️' : '🌐'} ${formatName}</h5>
                    <div style="font-size: 12px; color: #666; word-break: break-all; margin: 5px 0;">${url}</div>
                    <p id="status-${formatName.replace(/\s+/g, '-').toLowerCase()}">Test ediliyor...</p>
                    <div id="image-container-${formatName.replace(/\s+/g, '-').toLowerCase()}"></div>
                `;
                
                container.appendChild(testDiv);
                
                const statusEl = document.getElementById(`status-${formatName.replace(/\s+/g, '-').toLowerCase()}`);
                const imgContainer = document.getElementById(`image-container-${formatName.replace(/\s+/g, '-').toLowerCase()}`);
                
                const img = new Image();
                img.style.cssText = 'max-width: 200px; max-height: 200px; border: 2px solid #ddd; border-radius: 5px; margin-top: 10px;';
                
                const startTime = Date.now();
                
                img.onload = function() {
                    const loadTime = Date.now() - startTime;
                    img.style.borderColor = '#28a745';
                    statusEl.innerHTML = `✅ Başarılı! (${loadTime}ms)<br><small>${img.naturalWidth} x ${img.naturalHeight}px</small>`;
                    imgContainer.appendChild(img);
                    
                    if (isRecommended) {
                        showStatus(`✅ Kapak görseli başarıyla yüklendi! (${formatName})`, 'success');
                    }
                    resolve(true);
                };
                
                img.onerror = function() {
                    const loadTime = Date.now() - startTime;
                    img.style.borderColor = '#dc3545';
                    statusEl.innerHTML = `❌ Yüklenemedi (${loadTime}ms)<br><small>CORS veya erişim hatası</small>`;
                    
                    // Show error placeholder
                    img.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgZmlsbD0iI2Y4ZjlmYSIvPjx0ZXh0IHg9IjUwIiB5PSI1MCIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjE0IiBmaWxsPSIjNmM3NTdkIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBkeT0iMC4zZW0iPkVycm9yPC90ZXh0Pjwvc3ZnPg==';
                    imgContainer.appendChild(img);
                    resolve(false);
                };
                
                img.src = url;
                
                // Timeout after 10 seconds
                setTimeout(() => {
                    if (statusEl.textContent === 'Test ediliyor...') {
                        statusEl.innerHTML = '⏰ Zaman aşımı (10s+)';
                        resolve(false);
                    }
                }, 10000);
            });
        }

        // Bölüm düzenleme için bölüm listesini yükle
        function loadChapterSelectOptions() {
            if (!currentSeriesData || !currentSeriesData.chapters) return;
            
            const select = document.getElementById('edit-chapter-select');
            select.innerHTML = '<option value="">-- Bölüm Seçin --</option>';
            
            currentSeriesData.chapters.forEach(chapter => {
                const option = document.createElement('option');
                option.value = chapter.number;
                option.textContent = `Bölüm ${chapter.number}: ${chapter.title || `Bölüm ${chapter.number}`}`;
                select.appendChild(option);
            });
        }

        // Düzenleme için bölüm yükle
        function loadChapterForEdit() {
            const chapterNumber = parseInt(document.getElementById('edit-chapter-select').value);
            if (!chapterNumber) {
                document.getElementById('edit-chapter-form-container').style.display = 'none';
                return;
            }
            
            const chapter = currentSeriesData.chapters.find(ch => ch.number === chapterNumber);
            if (!chapter) return;
            
            // Form alanlarını doldur
            document.getElementById('edit-chapter-original-number').value = chapter.number;
            document.getElementById('edit-chapter-number').value = chapter.number;
            document.getElementById('edit-chapter-title').value = chapter.title || `Bölüm ${chapter.number}`;
            
            // Görsel URL'lerini yükle
            loadEditImageInputs(chapter.imageUrls || []);
            
            document.getElementById('edit-chapter-form-container').style.display = 'block';
        }

        // Düzenleme için görsel input'larını yükle - Admin panel tarzı
        function loadEditImageInputs(imageUrls) {
            const container = document.getElementById('edit-image-inputs');
            container.innerHTML = '';
            
            imageUrls.forEach((url, index) => {
                const inputItem = document.createElement('div');
                inputItem.className = 'edit-image-input-item';
                inputItem.innerHTML = `
                    <input type="url" value="${url}" placeholder="Sayfa ${index + 1} URL" required oninput="updateImagePreview(this)">
                    <button type="button" class="btn danger small" onclick="removeEditImageInput(this)">Sil</button>
                    <img src="${getPreviewUrl(url)}" class="image-preview" style="max-width:60px; max-height:60px; vertical-align:middle; margin-left:8px; display:inline-block;" onclick="showImageModal(this.src)" title="Önizle">
                `;
                container.appendChild(inputItem);
            });
            
            // En az bir input olsun
            if (imageUrls.length === 0) {
                addEditImageInput();
            }
        }

        // Preview URL oluştur (admin panel'den)
        function getPreviewUrl(url) {
            // Google Drive linkinden fileId çıkarıp thumbnail oluştur
            const fileId = extractFileId(url);
            if (fileId) {
                return `https://drive.google.com/thumbnail?id=${fileId}&sz=s400`;
            }
            return url;
        }

        // Görsel önizleme güncelle (admin panel'den)
        function updateImagePreview(input) {
            const url = input.value;
            const img = input.parentElement.querySelector('.image-preview');
            if (url) {
                img.src = getPreviewUrl(url);
                img.style.display = 'inline-block';
            } else {
                img.src = '';
                img.style.display = 'none';
            }
        }

        // Görsel modal göster (admin panel'den)
        function showImageModal(src) {
            // Basit modal: yeni sekmede aç
            window.open(src, '_blank');
        }

        // Düzenleme için yeni görsel input ekle - Admin panel tarzı
        function addEditImageInput() {
            const container = document.getElementById('edit-image-inputs');
            const inputCount = container.children.length;
            
            const newInputItem = document.createElement('div');
            newInputItem.className = 'edit-image-input-item';
            newInputItem.innerHTML = `
                <input type="url" placeholder="Sayfa ${inputCount + 1} URL" required oninput="updateImagePreview(this)">
                <button type="button" class="btn danger small" onclick="removeEditImageInput(this)">Sil</button>
                <img src="" class="image-preview" style="max-width:60px; max-height:60px; vertical-align:middle; margin-left:8px; display:none;" onclick="showImageModal(this.src)" title="Önizle">
            `;
            
            container.appendChild(newInputItem);
        }

        function removeEditImageInput(button) {
            const container = document.getElementById('edit-image-inputs');
            if (container.children.length > 1) {
                button.parentElement.remove();
                updateEditImagePlaceholders();
            } else {
                showStatus('En az bir görsel gerekli', 'error');
            }
        }

        function updateEditImagePlaceholders() {
            const inputs = document.querySelectorAll('#edit-image-inputs input[type="url"]');
            inputs.forEach((input, index) => {
                if (!input.value) {
                    input.placeholder = `Sayfa ${index + 1} URL`;
                }
            });
        }

        // Düzenleme önizleme - Admin panel tarzı
        async function previewEditImages() {
            const imageInputs = document.querySelectorAll('#edit-image-inputs input[type="url"]');
            const urls = Array.from(imageInputs).map(input => input.value).filter(url => url);
            
            if (urls.length === 0) {
                showStatus('Önizlenecek geçerli görsel bulunamadı', 'error');
                return;
            }

            toggleLoading(true);
            
            const previewContainer = document.getElementById('edit-preview-images-container');
            const previewSection = document.getElementById('edit-images-preview');
            
            previewContainer.innerHTML = '';
            
            // Her URL için önizleme oluştur
            for (let i = 0; i < urls.length; i++) {
                const url = urls[i];
                
                // Google Drive linklerini proxy URL'ye çevir
                let displayUrl = url;
                if (url.includes('drive.google.com')) {
                    const fileId = extractFileId(url);
                    if (fileId) {
                        displayUrl = createProxyUrl(fileId);
                    }
                }
                
                const imgContainer = document.createElement('div');
                imgContainer.style.cssText = 'margin: 10px; text-align: center; border: 1px solid #ddd; padding: 10px; border-radius: 5px;';
                
                const img = document.createElement('img');
                img.style.cssText = 'max-width: 150px; border: 2px solid #28a745; border-radius: 5px;';
                
                const label = document.createElement('p');
                label.innerHTML = `<strong>Sayfa ${i + 1}</strong><br><small>Yükleniyor...</small>`;
                
                img.onload = function() {
                    img.style.borderColor = '#28a745';
                    label.innerHTML = `<strong>Sayfa ${i + 1} ✅</strong><br><small>${img.naturalWidth}x${img.naturalHeight}px</small>`;
                };
                
                img.onerror = function() {
                    img.style.borderColor = '#dc3545';
                    img.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgZmlsbD0iI2Y4ZjlmYSIvPjx0ZXh0IHg9IjUwIiB5PSI1MCIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjE0IiBmaWxsPSIjNmM3NTdkIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBkeT0iMC4zZW0iPkVycm9yPC90ZXh0Pjwvc3ZnPg==';
                    label.innerHTML = `<strong>Sayfa ${i + 1} ❌</strong><br><small>Yüklenemedi</small>`;
                };
                
                img.src = displayUrl;
                
                imgContainer.appendChild(label);
                imgContainer.appendChild(img);
                previewContainer.appendChild(imgContainer);
            }
            
            previewSection.style.display = 'block';
            toggleLoading(false);
            showStatus(`${urls.length} görsel önizleniyor`, 'info');
        }

        // Seçili bölümü sil
        async function deleteSelectedChapter() {
            const chapterNumber = parseInt(document.getElementById('edit-chapter-original-number').value);
            if (!chapterNumber) return;
            
            await deleteChapter(chapterNumber);
            
            // Düzenleme formunu gizle
            document.getElementById('edit-chapter-form-container').style.display = 'none';
            document.getElementById('edit-chapter-select').value = '';
        }

        // Etiket ayarları görünürlük kontrolü - Admin panel'den
        function toggleLabelSettings() {
            const labelValue = document.getElementById('series-label-enabled').value;
            const labelSettings = document.getElementById('label-settings');
            
            // Sadece "true" (Etiketi Göster) durumunda ayarları göster
            labelSettings.style.display = labelValue === 'true' ? 'block' : 'none';
            updateLabelPreview();
        }

        // Etiket önizleme güncelleme - Admin panel'den
        function updateLabelPreview() {
            const labelValue = document.getElementById('series-label-enabled').value;
            const text = document.getElementById('series-label-text').value;
            const color = document.getElementById('series-label-color').value;
            const preview = document.getElementById('label-preview-badge');
            
            if (labelValue === 'true') {
                // Etiketi göster
                preview.textContent = text;
                preview.style.background = color;
                preview.style.display = 'inline-block';
                preview.style.opacity = '1';
            } else if (labelValue === 'false') {
                // Etiket var ama gizli (önizlemede göster ama soluk)
                preview.textContent = text + ' (Gizli)';
                preview.style.background = color;
                preview.style.opacity = '0.5';
                preview.style.display = 'inline-block';
            } else {
                // Etiket yok
                preview.style.display = 'none';
                preview.style.opacity = '1';
            }
        }

        // Başarı alert'i için ayrı fonksiyon
        function showSuccessAlert(message) {
            showStatus(message, 'success');
        }

        // Hata alert'i için ayrı fonksiyon  
        function showErrorAlert(message) {
            showStatus(message, 'error');
        }

        // Çıkış yap
        function logout() {
            localStorage.removeItem('token');
            showLoginForm();
            
            // Formu temizle
            document.getElementById('login-form').reset();
            document.getElementById('login-alert').style.display = 'none';
        }

        // HTML escape
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ===== BÖLÜM YÖNETİMİ FONKSİYONLARI (Admin Panel'den Alındı) =====
        
        // Bölüm ekleme form submit - Admin panel tarzı
        document.getElementById('add-chapter-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!currentSeriesId) {
                showStatus('Önce bir seri seçin', 'error');
                return;
            }
            
            const formData = new FormData(e.target);
            const imageInputs = document.querySelectorAll('#image-inputs input[type="url"]');
            const imageUrls = Array.from(imageInputs).map(input => input.value).filter(url => url);
            
            // Client-side validasyon
            const chapterNumber = parseInt(formData.get('chapterNumber') || document.getElementById('chapter-number').value);
            
            if (!chapterNumber || isNaN(chapterNumber)) {
                showStatus('Geçerli bir bölüm numarası gerekli', 'error');
                return;
            }
            
            if (chapterNumber <= 0) {
                showStatus('Bölüm numarası 0\'dan büyük olmalı', 'error');
                return;
            }
            
            if (imageUrls.length === 0) {
                showStatus('Lütfen en az bir görsel linki girin', 'error');
                return;
            }
            
            // Google Drive linklerini kontrol et
            for (let i = 0; i < imageUrls.length; i++) {
                const url = imageUrls[i];
                if (!url.includes('drive.google.com') || !url.includes('/file/d/')) {
                    showStatus(`${i + 1}. görsel için geçerli bir Google Drive linki girin`, 'error');
                    return;
                }
            }
            
            const data = {
                seriesId: currentSeriesId,
                chapterNumber: chapterNumber,
                title: formData.get('title') || document.getElementById('chapter-title').value || `Bölüm ${chapterNumber}`,
                imageUrls: imageUrls
            };
            
            toggleLoading(true);
            
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`${API_BASE}/admin/create-chapter-with-images`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ ...data, seriesId: currentSeriesId })
                });

                const result = await response.json();
                
                if (result.success) {
                    showStatus(`Bölüm başarıyla oluşturuldu! (${result.imageCount} görsel)`, 'success');
                    e.target.reset();
                    resetImageInputs();
                    document.getElementById('images-preview').style.display = 'none';
                    
                    // Seri detaylarını yenile
                    await loadSeriesDetails(currentSeriesId);
                    
                    // Seri listesini yenile
                    loadModeratorSeries();
                    
                    // Bir sonraki bölüm numarasını ayarla
                    const chapters = currentSeriesData.chapters || [];
                    const nextChapterNumber = chapters.length > 0 ? Math.max(...chapters.map(ch => ch.number)) + 1 : 1;
                    document.getElementById('chapter-number').value = nextChapterNumber;
                    
                    // Bölümler tab'ına geç
                    switchTab('chapters');
                } else {
                    showStatus(result.error || 'Bölüm oluşturulamadı', 'error');
                }
            } catch (error) {
                showStatus('Bağlantı hatası', 'error');
                console.error('Chapter creation error:', error);
            }
            
            toggleLoading(false);
        });

        // Görsel input'larını sıfırla
        function resetImageInputs() {
            document.getElementById('image-inputs').innerHTML = `
                <div class="image-input-item">
                    <input type="url" placeholder="Sayfa 1 Google Drive linki" required>
                    <button type="button" class="btn danger small" onclick="removeImageInput(this)">Sil</button>
                </div>
            `;
        }

        // Görsel input ekle - Admin panel tarzı
        function addImageInput() {
            const container = document.getElementById('image-inputs');
            const inputCount = container.children.length;
            
            const newInputDiv = document.createElement('div');
            newInputDiv.className = 'image-input-item';
            newInputDiv.innerHTML = `
                <input type="url" placeholder="Sayfa ${inputCount + 1} Google Drive linki" required>
                <button type="button" class="btn danger small" onclick="removeImageInput(this)">Sil</button>
            `;
            container.appendChild(newInputDiv);
        }

        // Görsel input sil - Admin panel tarzı  
        function removeImageInput(button) {
            const container = document.getElementById('image-inputs');
            if (container.children.length > 1) {
                button.parentElement.remove();
                
                // Placeholder'ları yeniden numaralandır
                const inputs = container.querySelectorAll('input[type="url"]');
                inputs.forEach((input, index) => {
                    input.placeholder = `Sayfa ${index + 1} Google Drive linki`;
                });
            } else {
                showStatus('En az bir görsel linki gerekli', 'error');
            }
        }

        // Görselleri önizle - Admin panel tarzı
        async function previewImages() {
            const imageInputs = document.querySelectorAll('#image-inputs input');
            const urls = Array.from(imageInputs).map(input => input.value).filter(url => url);
            
            if (urls.length === 0) {
                showStatus('Önizlemek için en az bir görsel linki girin', 'error');
                return;
            }

            toggleLoading(true);
            
            const previewContainer = document.getElementById('preview-images-container');
            previewContainer.innerHTML = '';
            
            // Convert URLs to proxy format and display images
            for (let i = 0; i < urls.length; i++) {
                const fileId = extractFileId(urls[i]);
                
                if (fileId) {
                    const proxyUrl = createProxyUrl(fileId);
                    
                    const imgContainer = document.createElement('div');
                    imgContainer.style.cssText = 'margin: 10px; text-align: center; border: 1px solid #ddd; padding: 10px; border-radius: 5px;';
                    
                    const img = document.createElement('img');
                    img.className = 'preview-image';
                    img.alt = `Sayfa ${i + 1}`;
                    img.style.cssText = 'max-width: 150px; border: 2px solid #28a745; border-radius: 5px;';
                    
                    const label = document.createElement('p');
                    label.innerHTML = `<strong>Sayfa ${i + 1}</strong><br><small>Proxy URL</small>`;
                    
                    img.onload = function() {
                        img.style.borderColor = '#28a745';
                        label.innerHTML = `<strong>Sayfa ${i + 1} ✅</strong><br><small>${img.naturalWidth}x${img.naturalHeight}px</small>`;
                    };
                    
                    img.onerror = function() {
                        img.style.borderColor = '#dc3545';
                        img.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgZmlsbD0iI2Y4ZjlmYSIvPjx0ZXh0IHg9IjUwIiB5PSI1MCIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjE0IiBmaWxsPSIjNmM3NTdkIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBkeT0iMC4zZW0iPkVycm9yPC90ZXh0Pjwvc3ZnPg==';
                        label.innerHTML = `<strong>Sayfa ${i + 1} ❌</strong><br><small>Yüklenemedi</small>`;
                    };
                    
                    img.src = proxyUrl;
                    
                    imgContainer.appendChild(label);
                    imgContainer.appendChild(img);
                    previewContainer.appendChild(imgContainer);
                } else {
                    const errorDiv = document.createElement('div');
                    errorDiv.textContent = `Sayfa ${i + 1}: Geçersiz Google Drive link`;
                    errorDiv.style.color = 'red';
                    previewContainer.appendChild(errorDiv);
                }
            }
            
            document.getElementById('images-preview').style.display = 'block';
            showStatus(`${urls.length} görsel önizleme yüklendi`, 'success');
            toggleLoading(false);
        }

        // Düzenleme görselleri önizle - Admin panel tarzı
        function previewEditImages() {
            const imageInputs = document.querySelectorAll('#edit-image-inputs input[type="url"]');
            const imageUrls = Array.from(imageInputs).map(input => input.value.trim()).filter(url => url);
            
            if (imageUrls.length === 0) {
                showStatus('Önizlemek için en az bir görsel linki girin', 'error');
                return;
            }
            
            const previewContainer = document.getElementById('edit-preview-images-container');
            previewContainer.innerHTML = '';
            
            imageUrls.forEach((url, index) => {
                const fileId = extractFileId(url);
                if (fileId) {
                    const thumbnailUrl = `https://drive.google.com/thumbnail?id=${fileId}&sz=s400`;
                    const img = document.createElement('img');
                    img.src = thumbnailUrl;
                    img.style.maxWidth = '200px';
                    img.style.margin = '5px';
                    img.style.border = '2px solid #ddd';
                    img.style.borderRadius = '8px';
                    img.style.cursor = 'pointer';
                    img.title = `Sayfa ${index + 1}`;
                    img.onclick = () => showImageModal(createProxyUrl(fileId));
                    
                    previewContainer.appendChild(img);
                }
            });
            
            document.getElementById('edit-images-preview').style.display = 'block';
            showStatus(`${imageUrls.length} görsel önizleme yüklendi`, 'success');
        }

        // Seçili bölümü sil - Admin panel tarzı
        async function deleteSelectedChapter() {
            const chapterNumber = parseInt(document.getElementById('edit-chapter-select').value);
            if (!chapterNumber) {
                showStatus('Önce bir bölüm seçin', 'error');
                return;
            }
            
            if (!confirm(`Bölüm ${chapterNumber}'ı silmek istediğinize emin misiniz? Bu işlem geri alınamaz.`)) {
                return;
            }
            
            try {
                toggleLoading(true);
                showStatus(`Bölüm ${chapterNumber} siliniyor...`, 'info');
                
                const token = localStorage.getItem('token');
                const response = await fetch(`${API_BASE}/moderator/delete-chapter/${currentSeriesId}/${chapterNumber}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Bölüm silinemedi');
                }

                const result = await response.json();
                showStatus(result.message || `Bölüm ${chapterNumber} başarıyla silindi`, 'success');
                
                // Seri detaylarını yenile
                await loadSeriesDetails(currentSeriesId);
                
                // Seri listesini yenile
                loadModeratorSeries();
                
                // Düzenleme formunu temizle
                document.getElementById('edit-chapter-form-container').style.display = 'none';
                document.getElementById('edit-chapter-select').value = '';
                document.getElementById('edit-images-preview').style.display = 'none';
                
                // Bölümler tab'ına geç
                switchTab('chapters');
                
            } catch (error) {
                console.error('Bölüm silme hatası:', error);
                showStatus(error.message || 'Bölüm silinirken hata oluştu', 'error');
            } finally {
                toggleLoading(false);
            }
        }

        // Listeden bölüm düzenle - Admin panel tarzı
        function editChapterFromList(chapterNumber) {
            // Bölüm seç dropdown'ını ayarla
            document.getElementById('edit-chapter-select').value = chapterNumber;
            
            // Formu yükle
            loadChapterForEdit();
            
            // Bölüm düzenle tab'ına geç
            switchTab('edit-chapter');
        }

        // Bölümü görüntüle - Admin panel tarzı
        function viewChapter(seriesId, chapterNumber) {
            window.open(`/client/chapters/${seriesId} chapters/bölüm${chapterNumber}.html`, '_blank');
        }

        // Kapak görseli doğrula - Admin panel tarzı
        function validateCoverImage() {
            const url = document.getElementById('series-cover').value.trim();
            const previewContainer = document.getElementById('cover-preview');
            const previewImage = document.getElementById('cover-preview-img');

            if (!url) {
                showStatus('Lütfen bir görsel URL\'si girin', 'error');
                previewContainer.style.display = 'none';
                return;
            }

            // Google Drive linkini proxy URL'ye dönüştür
            let imageUrl = url;
            const fileId = extractFileId(url);
            if (fileId) {
                imageUrl = createProxyUrl(fileId);
            }

            // Loading göster
            previewImage.src = '';
            previewContainer.style.display = 'block';
            previewImage.style.display = 'none';
            
            // Temporary loading message
            const loadingMsg = document.createElement('div');
            loadingMsg.innerHTML = '🔄 Görsel yükleniyor...';
            loadingMsg.style.padding = '20px';
            loadingMsg.style.textAlign = 'center';
            loadingMsg.id = 'temp-loading-cover';
            previewContainer.appendChild(loadingMsg);

            previewImage.onload = function() {
                const tempLoading = document.getElementById('temp-loading-cover');
                if (tempLoading) tempLoading.remove();
                
                previewImage.style.display = 'block';
                showStatus('Kapak görseli başarıyla yüklendi', 'success');
            };
            
            previewImage.onerror = function() {
                const tempLoading = document.getElementById('temp-loading-cover');
                if (tempLoading) tempLoading.remove();
                
                previewContainer.style.display = 'none';
                showStatus('Kapak görseli yüklenemedi. URL\'yi kontrol edin', 'error');
            };
            
            previewImage.src = imageUrl;
        }
    </script>
</body>
</html>
